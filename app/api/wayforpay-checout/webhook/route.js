(function(_0x10690a,_0x496479){const _0x41be72=a5_0x4508,_0x56af33=_0x10690a();while(!![]){try{const _0x10eae1=-parseInt(_0x41be72(0x125))/0x1*(parseInt(_0x41be72(0x112))/0x2)+-parseInt(_0x41be72(0x11b))/0x3*(parseInt(_0x41be72(0x118))/0x4)+-parseInt(_0x41be72(0x115))/0x5+parseInt(_0x41be72(0x11a))/0x6+parseInt(_0x41be72(0x11c))/0x7+parseInt(_0x41be72(0x121))/0x8+parseInt(_0x41be72(0x110))/0x9*(-parseInt(_0x41be72(0x11d))/0xa);if(_0x10eae1===_0x496479)break;else _0x56af33['push'](_0x56af33['shift']());}catch(_0x3e413b){_0x56af33['push'](_0x56af33['shift']());}}}(a5_0xfe73,0xae1c8));import{NextResponse}from'next/server';import a5_0x5c05f3 from'crypto';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';import{getBundleById}from'@/sanity/lib/courses/getBundleById';import{client}from'@/sanity/lib/adminClient';import{sendPaymentUpdate}from'@/lib/payment-events';const WAYFORPAY_MERCHANT_SECRET_KEY=process['env']['WAYFORPAY_MERCHANT_SECRET_KEY'];export async function POST(_0x216aee){const _0x13c00c=a5_0x4508;let _0x444603;try{_0x444603=await _0x216aee['json'](),console['log']('WayForPay\x20webhook\x20received:',JSON['stringify'](_0x444603,null,0x2)),console['log']('Admin\x20client\x20debug:',{'hasToken':!!process['env']['SANITY_API_ADMIN_TOKEN'],'tokenLength':process['env']['SANITY_API_ADMIN_TOKEN']?.['length']||0x0,'projectId':process['env']['NEXT_PUBLIC_SANITY_PROJECT_ID'],'dataset':process['env']['NEXT_PUBLIC_SANITY_DATASET']});const {orderReference:_0x3659f4,transactionStatus:_0x129630,processingDate:_0x1d42fd,merchantSignature:_0x3cfd92,amount:_0x505ee9,reason:_0x2a6792}=_0x444603;if(!_0x3659f4||!_0x129630||_0x1d42fd===undefined||!_0x3cfd92)return console['error']('WayForPay\x20Webhook:\x20Missing\x20critical\x20fields\x20from\x20payload:',{'orderReference':_0x3659f4,'transactionStatus':_0x129630,'processingDate':_0x1d42fd,'receivedSignature':_0x3cfd92}),new NextResponse('Webhook\x20Error:\x20Missing\x20fields',{'status':0x190});const {merchantAccount:_0x25d2df,amount:_0x4cc02b,currency:_0x5250d3,authCode:_0x8b1288,cardPan:_0x6f3919,reasonCode:_0x384a39}=_0x444603,_0x129b45=_0x25d2df+';'+_0x3659f4+';'+_0x4cc02b+';'+_0x5250d3+';'+_0x8b1288+';'+_0x6f3919+';'+_0x129630+';'+_0x384a39,_0x5d5939=a5_0x5c05f3['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x129b45)['digest']('hex');if(_0x5d5939!==_0x3cfd92)return console['error']('WayForPay\x20Webhook:\x20Invalid\x20signature.',{'calculatedSignature':_0x5d5939,'receivedSignature':_0x3cfd92,'stringToSign':_0x129b45,'signatureFields':{'merchantAccount':_0x25d2df,'orderReference':_0x3659f4,'amount':_0x4cc02b,'currency':_0x5250d3,'authCode':_0x8b1288,'cardPan':_0x6f3919,'transactionStatus':_0x129630,'reasonCode':_0x384a39}}),new NextResponse('Webhook\x20Error:\x20Invalid\x20signature',{'status':0x190});switch(_0x129630){case'Approved':console['log']('âœ…\x20Payment\x20APPROVED\x20for\x20order\x20'+_0x3659f4),await processApprovedPayment(_0x3659f4,_0x505ee9);break;case _0x13c00c(0x11f):console['log']('â³\x20Payment\x20PENDING\x20for\x20order\x20'+_0x3659f4+'.\x20Reason:\x20'+_0x2a6792),await processPendingPayment(_0x3659f4);break;case'Declined':console['log']('âŒ\x20Payment\x20DECLINED\x20for\x20order\x20'+_0x3659f4+'.\x20Reason:\x20'+_0x2a6792),await processDeclinedPayment(_0x3659f4,_0x2a6792);break;case _0x13c00c(0x11e):console['log']('â°\x20Payment\x20EXPIRED\x20for\x20order\x20'+_0x3659f4+'.\x20Reason:\x20'+_0x2a6792),await processExpiredPayment(_0x3659f4);break;case'Refunded':console['log']('ðŸ’°\x20Payment\x20REFUNDED\x20for\x20order\x20'+_0x3659f4+'.\x20Reason:\x20'+_0x2a6792),await processRefundedPayment(_0x3659f4);break;default:console['log']('â„¹ï¸\x20Unhandled\x20payment\x20status\x20\x27'+_0x129630+'\x27\x20for\x20order\x20'+_0x3659f4+'.\x20Reason:\x20'+_0x2a6792);}const _0x1834ab=Math['floor'](Date[_0x13c00c(0x111)]()/0x3e8),_0x3771d3=_0x3659f4+';accept;'+_0x1834ab,_0x8cfe3e=a5_0x5c05f3[_0x13c00c(0x123)]('md5',WAYFORPAY_MERCHANT_SECRET_KEY)[_0x13c00c(0x120)](_0x3771d3)['digest']('hex'),_0x2ae279={'orderReference':_0x3659f4,'status':'accept','time':_0x1834ab,'signature':_0x8cfe3e};return NextResponse['json'](_0x2ae279,{'status':0xc8});}catch(_0x48a897){console['error']('Error\x20in\x20WayForPay\x20webhook\x20handler:',_0x48a897);_0x48a897 instanceof Error&&(console['error']('Error\x20details:',{'message':_0x48a897['message'],'stack':_0x48a897[_0x13c00c(0x122)],'name':_0x48a897['name']}),_0x48a897['message']['includes']('Insufficient\x20permissions')&&console['error']('SANITY\x20PERMISSION\x20ERROR\x20DETECTED:',{'hasAdminToken':!!process['env']['SANITY_API_ADMIN_TOKEN'],'tokenStart':process['env']['SANITY_API_ADMIN_TOKEN']?.['substring'](0x0,0x8)+'...','projectId':process['env']['NEXT_PUBLIC_SANITY_PROJECT_ID'],'dataset':process['env']['NEXT_PUBLIC_SANITY_DATASET']}));const _0x6a0f1c=_0x444603?.['orderReference']||'unknown_order_ref_error',_0x3196e4=Math['floor'](Date['now']()/0x3e8),_0xf71a36='error',_0x35c01e=_0x6a0f1c+';'+_0xf71a36+';'+_0x3196e4,_0x45cabd=a5_0x5c05f3['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x35c01e)['digest']('hex');return NextResponse['json']({'orderReference':_0x6a0f1c,'status':_0xf71a36,'time':_0x3196e4,'signature':_0x45cabd},{'status':0x1f4});}}async function processApprovedPayment(_0x2e9cda,_0x3a2732){const _0x2ec17e=a5_0x4508,_0x4aab4e=_0x2e9cda['split']('--');if(_0x4aab4e[0x0]==='bundle'&&_0x4aab4e[_0x2ec17e(0x119)]>=0x4){const _0x15d4d7=_0x4aab4e[0x1],_0x25a52e=_0x4aab4e[0x2];console['log']('Processing\x20bundle\x20order:',{'bundleId':_0x15d4d7,'clerkUserId':_0x25a52e});const _0x498600=await getStudentByClerkId(_0x25a52e);if(!_0x498600?.['data']?.['_id'])console['error']('WayForPay\x20Webhook:\x20Student\x20not\x20found\x20for\x20clerkId\x20'+_0x25a52e+'\x20in\x20bundle\x20order\x20'+_0x2e9cda);else{const _0x2ee601=await getBundleById(_0x15d4d7);if(!_0x2ee601)console[_0x2ec17e(0x116)]('WayForPay\x20Webhook:\x20Bundle\x20not\x20found\x20for\x20bundleId\x20'+_0x15d4d7+'\x20in\x20order\x20'+_0x2e9cda);else{const _0x39c58e=_0x498600['data']['_id'];console[_0x2ec17e(0x117)]('Creating\x20bundle\x20enrollment\x20for:',{'sanityStudentId':_0x39c58e,'bundleId':_0x15d4d7,'orderReference':_0x2e9cda,'paidAmount':_0x3a2732});try{const _0x5257f4=await client['fetch'](_0x2ec17e(0x113));console[_0x2ec17e(0x117)]('Admin\x20client\x20read\x20test:',!!_0x5257f4);}catch(_0x41f5e9){console['error']('Admin\x20client\x20read\x20test\x20failed:',_0x41f5e9);}await createBundleEnrollment({'studentId':_0x39c58e,'bundleId':_0x15d4d7,'paymentId':_0x2e9cda,'amount':_0x3a2732,'paymentProvider':_0x2ec17e(0x114),'bundleData':_0x2ee601}),console['log']('WayForPay\x20Webhook:\x20Bundle\x20enrollment\x20successfully\x20created\x20for\x20order\x20'+_0x2e9cda),sendPaymentUpdate(_0x2e9cda,{'type':'payment_approved','message':'Bundle\x20enrollment\x20successful!','bundleId':_0x15d4d7,'redirectUrl':'/payment/success?payment_success=wayforpay&type=bundle'});}}}else{if(_0x4aab4e[_0x2ec17e(0x119)]>=0x3){const _0x286752=_0x4aab4e[0x0],_0x19c2d3=_0x4aab4e[0x1],_0x38eb63=await getStudentByClerkId(_0x19c2d3);if(!_0x38eb63?.['data']?.['_id'])console['error']('WayForPay\x20Webhook:\x20Student\x20not\x20found\x20for\x20clerkId\x20'+_0x19c2d3+'\x20in\x20order\x20'+_0x2e9cda);else{const _0x44116b=_0x38eb63['data']['_id'];await createEnrollment({'studentId':_0x44116b,'courseId':_0x286752,'paymentId':_0x2e9cda,'amount':_0x3a2732,'paymentProvider':'wayforpay'}),console['log']('WayForPay\x20Webhook:\x20Course\x20enrollment\x20successfully\x20created\x20for\x20order\x20'+_0x2e9cda),sendPaymentUpdate(_0x2e9cda,{'type':'payment_approved','message':'Course\x20enrollment\x20successful!','courseId':_0x286752,'redirectUrl':'/payment/success?payment_success=wayforpay&type=course'});}}else console['error']('WayForPay\x20Webhook:\x20Invalid\x20orderReference\x20format',_0x2e9cda);}}async function processPendingPayment(_0x2ceaac){const _0x1208db=a5_0x4508;console['log']('Payment\x20is\x20still\x20pending\x20for\x20'+_0x2ceaac+_0x1208db(0x124)),sendPaymentUpdate(_0x2ceaac,{'type':'payment_pending','message':'Payment\x20is\x20still\x20being\x20processed\x20by\x20the\x20bank...'});}function a5_0x4508(_0x4c1789,_0x5cc4c4){const _0xfe735e=a5_0xfe73();return a5_0x4508=function(_0x450874,_0x16a599){_0x450874=_0x450874-0x110;let _0x3bbd88=_0xfe735e[_0x450874];return _0x3bbd88;},a5_0x4508(_0x4c1789,_0x5cc4c4);}function a5_0xfe73(){const _0x18bd19=['1581105OOeRqQ','error','log','40jwomRe','length','6736626nDwuCl','192180gFMKLQ','9982287AUQUhm','180XAzoTB','Expired','Pending','update','11135128NbGTYO','stack','createHmac','.\x20No\x20enrollment\x20created\x20yet.','8263DcGzqD','523899oOpHwZ','now','296BfoFlc','*[_type\x20==\x20\x22student\x22][0]','wayforpay'];a5_0xfe73=function(){return _0x18bd19;};return a5_0xfe73();}async function processDeclinedPayment(_0x1f602e,_0x5471dc){console['log']('Payment\x20declined\x20for\x20'+_0x1f602e+'.\x20Reason:\x20'+_0x5471dc),sendPaymentUpdate(_0x1f602e,{'type':'payment_failed','message':'Payment\x20was\x20declined','reason':_0x5471dc,'redirectUrl':'/payment/failed?provider=wayforpay&reason='+encodeURIComponent(_0x5471dc)});}async function processExpiredPayment(_0x5d75ed){console['log']('Payment\x20expired\x20for\x20'+_0x5d75ed);}async function processRefundedPayment(_0x3700f9){console['log']('Payment\x20refunded\x20for\x20'+_0x3700f9);}