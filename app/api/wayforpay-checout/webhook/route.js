(function(_0x432be1,_0x1709c0){const _0x232542=a5_0x466f,_0x1a3d17=_0x432be1();while(!![]){try{const _0x3a3314=parseInt(_0x232542(0xc3))/0x1*(parseInt(_0x232542(0xcb))/0x2)+parseInt(_0x232542(0xca))/0x3+parseInt(_0x232542(0xbd))/0x4*(-parseInt(_0x232542(0xc9))/0x5)+-parseInt(_0x232542(0xd0))/0x6*(parseInt(_0x232542(0xc0))/0x7)+parseInt(_0x232542(0xc1))/0x8+-parseInt(_0x232542(0xce))/0x9+parseInt(_0x232542(0xc2))/0xa;if(_0x3a3314===_0x1709c0)break;else _0x1a3d17['push'](_0x1a3d17['shift']());}catch(_0x3353bf){_0x1a3d17['push'](_0x1a3d17['shift']());}}}(a5_0x1a3f,0x80fcb));import{NextResponse}from'next/server';function a5_0x1a3f(){const _0x3301ac=['length','payment_approved','env','wayforpay','/payment/success?payment_success=wayforpay&type=course','5MlRnBV','1895415uoBuPr','2bhzOEJ','Expired','json','6110649HKVVQf','log','12IXcVBf','orderReference','_id','1228132jhGDcN','Error\x20in\x20WayForPay\x20webhook\x20handler:','digest','2323664LdvcAs','1347696SAfyTk','9067800TEsMSn','471182cwEmTS'];a5_0x1a3f=function(){return _0x3301ac;};return a5_0x1a3f();}import a5_0x580620 from'crypto';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';import{getBundleById}from'@/sanity/lib/courses/getBundleById';import{client}from'@/sanity/lib/adminClient';import{sendPaymentUpdate}from'@/lib/payment-events';const WAYFORPAY_MERCHANT_SECRET_KEY=process['env']['WAYFORPAY_MERCHANT_SECRET_KEY'];function a5_0x466f(_0x55705a,_0x47154e){const _0x1a3f3c=a5_0x1a3f();return a5_0x466f=function(_0x466f56,_0x4ad778){_0x466f56=_0x466f56-0xbb;let _0x189099=_0x1a3f3c[_0x466f56];return _0x189099;},a5_0x466f(_0x55705a,_0x47154e);}export async function POST(_0x5600c1){const _0x39bb6c=a5_0x466f;let _0x5b3b0d;try{_0x5b3b0d=await _0x5600c1[_0x39bb6c(0xcd)](),console['log']('WayForPay\x20webhook\x20received:',JSON['stringify'](_0x5b3b0d,null,0x2)),console['log']('Admin\x20client\x20debug:',{'hasToken':!!process['env']['SANITY_API_ADMIN_TOKEN'],'tokenLength':process['env']['SANITY_API_ADMIN_TOKEN']?.[_0x39bb6c(0xc4)]||0x0,'projectId':process['env']['NEXT_PUBLIC_SANITY_PROJECT_ID'],'dataset':process['env']['NEXT_PUBLIC_SANITY_DATASET']});const {orderReference:_0x5b416c,transactionStatus:_0x1e133b,processingDate:_0x3aa52a,merchantSignature:_0x1f5f69,amount:_0x2d875d,reason:_0x494239}=_0x5b3b0d;if(!_0x5b416c||!_0x1e133b||_0x3aa52a===undefined||!_0x1f5f69)return console['error']('WayForPay\x20Webhook:\x20Missing\x20critical\x20fields\x20from\x20payload:',{'orderReference':_0x5b416c,'transactionStatus':_0x1e133b,'processingDate':_0x3aa52a,'receivedSignature':_0x1f5f69}),new NextResponse('Webhook\x20Error:\x20Missing\x20fields',{'status':0x190});const {merchantAccount:_0x355fb1,amount:_0x27b5b3,currency:_0x30cb8,authCode:_0x389fa8,cardPan:_0x38c503,reasonCode:_0x1aa356}=_0x5b3b0d,_0x4c3a69=_0x355fb1+';'+_0x5b416c+';'+_0x27b5b3+';'+_0x30cb8+';'+_0x389fa8+';'+_0x38c503+';'+_0x1e133b+';'+_0x1aa356,_0x437abc=a5_0x580620['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x4c3a69)[_0x39bb6c(0xbf)]('hex');if(_0x437abc!==_0x1f5f69)return console['error']('WayForPay\x20Webhook:\x20Invalid\x20signature.',{'calculatedSignature':_0x437abc,'receivedSignature':_0x1f5f69,'stringToSign':_0x4c3a69,'signatureFields':{'merchantAccount':_0x355fb1,'orderReference':_0x5b416c,'amount':_0x27b5b3,'currency':_0x30cb8,'authCode':_0x389fa8,'cardPan':_0x38c503,'transactionStatus':_0x1e133b,'reasonCode':_0x1aa356}}),new NextResponse('Webhook\x20Error:\x20Invalid\x20signature',{'status':0x190});switch(_0x1e133b){case'Approved':console['log']('âœ…\x20Payment\x20APPROVED\x20for\x20order\x20'+_0x5b416c),await processApprovedPayment(_0x5b416c,_0x2d875d);break;case'Pending':console['log']('â³\x20Payment\x20PENDING\x20for\x20order\x20'+_0x5b416c+'.\x20Reason:\x20'+_0x494239),await processPendingPayment(_0x5b416c);break;case'Declined':console['log']('âŒ\x20Payment\x20DECLINED\x20for\x20order\x20'+_0x5b416c+'.\x20Reason:\x20'+_0x494239),await processDeclinedPayment(_0x5b416c,_0x494239);break;case _0x39bb6c(0xcc):console['log']('â°\x20Payment\x20EXPIRED\x20for\x20order\x20'+_0x5b416c+'.\x20Reason:\x20'+_0x494239),await processExpiredPayment(_0x5b416c);break;case'Refunded':console['log']('ðŸ’°\x20Payment\x20REFUNDED\x20for\x20order\x20'+_0x5b416c+'.\x20Reason:\x20'+_0x494239),await processRefundedPayment(_0x5b416c);break;default:console['log']('â„¹ï¸\x20Unhandled\x20payment\x20status\x20\x27'+_0x1e133b+'\x27\x20for\x20order\x20'+_0x5b416c+'.\x20Reason:\x20'+_0x494239);}const _0x430c80=Math['floor'](Date['now']()/0x3e8),_0x10b78b=_0x5b416c+';accept;'+_0x430c80,_0x2f2b73=a5_0x580620['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x10b78b)['digest']('hex'),_0x2c097b={'orderReference':_0x5b416c,'status':'accept','time':_0x430c80,'signature':_0x2f2b73};return NextResponse['json'](_0x2c097b,{'status':0xc8});}catch(_0x398048){console['error'](_0x39bb6c(0xbe),_0x398048);_0x398048 instanceof Error&&(console['error']('Error\x20details:',{'message':_0x398048['message'],'stack':_0x398048['stack'],'name':_0x398048['name']}),_0x398048['message']['includes']('Insufficient\x20permissions')&&console['error']('SANITY\x20PERMISSION\x20ERROR\x20DETECTED:',{'hasAdminToken':!!process['env']['SANITY_API_ADMIN_TOKEN'],'tokenStart':process['env']['SANITY_API_ADMIN_TOKEN']?.['substring'](0x0,0x8)+'...','projectId':process['env']['NEXT_PUBLIC_SANITY_PROJECT_ID'],'dataset':process[_0x39bb6c(0xc6)]['NEXT_PUBLIC_SANITY_DATASET']}));const _0x102592=_0x5b3b0d?.[_0x39bb6c(0xbb)]||'unknown_order_ref_error',_0x24769d=Math['floor'](Date['now']()/0x3e8),_0x2aaffc='error',_0x4a2e62=_0x102592+';'+_0x2aaffc+';'+_0x24769d,_0xb0486a=a5_0x580620['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x4a2e62)['digest']('hex');return NextResponse['json']({'orderReference':_0x102592,'status':_0x2aaffc,'time':_0x24769d,'signature':_0xb0486a},{'status':0x1f4});}}async function processApprovedPayment(_0xc8200d,_0x1e3e14){const _0x1ecc78=a5_0x466f,_0x7f31ff=_0xc8200d['split']('--');if(_0x7f31ff[0x0]==='bundle'&&_0x7f31ff['length']>=0x4){const _0x221759=_0x7f31ff[0x1],_0x2c1fa9=_0x7f31ff[0x2];console['log']('Processing\x20bundle\x20order:',{'bundleId':_0x221759,'clerkUserId':_0x2c1fa9});const _0xff9d42=await getStudentByClerkId(_0x2c1fa9);if(!_0xff9d42?.['data']?.['_id'])console['error']('WayForPay\x20Webhook:\x20Student\x20not\x20found\x20for\x20clerkId\x20'+_0x2c1fa9+'\x20in\x20bundle\x20order\x20'+_0xc8200d);else{const _0x4b94eb=await getBundleById(_0x221759);if(!_0x4b94eb)console['error']('WayForPay\x20Webhook:\x20Bundle\x20not\x20found\x20for\x20bundleId\x20'+_0x221759+'\x20in\x20order\x20'+_0xc8200d);else{const _0x15dedf=_0xff9d42['data']['_id'];console['log']('Creating\x20bundle\x20enrollment\x20for:',{'sanityStudentId':_0x15dedf,'bundleId':_0x221759,'orderReference':_0xc8200d,'paidAmount':_0x1e3e14});try{const _0x304217=await client['fetch']('*[_type\x20==\x20\x22student\x22][0]');console['log']('Admin\x20client\x20read\x20test:',!!_0x304217);}catch(_0x4d9c88){console['error']('Admin\x20client\x20read\x20test\x20failed:',_0x4d9c88);}await createBundleEnrollment({'studentId':_0x15dedf,'bundleId':_0x221759,'paymentId':_0xc8200d,'amount':_0x1e3e14,'paymentProvider':'wayforpay','bundleData':_0x4b94eb}),console['log']('WayForPay\x20Webhook:\x20Bundle\x20enrollment\x20successfully\x20created\x20for\x20order\x20'+_0xc8200d),sendPaymentUpdate(_0xc8200d,{'type':'payment_approved','message':'Bundle\x20enrollment\x20successful!','bundleId':_0x221759,'redirectUrl':'/payment/success?payment_success=wayforpay&type=bundle'});}}}else{if(_0x7f31ff['length']>=0x3){const _0x95421d=_0x7f31ff[0x0],_0x29c96d=_0x7f31ff[0x1],_0xc0849e=await getStudentByClerkId(_0x29c96d);if(!_0xc0849e?.['data']?.['_id'])console['error']('WayForPay\x20Webhook:\x20Student\x20not\x20found\x20for\x20clerkId\x20'+_0x29c96d+'\x20in\x20order\x20'+_0xc8200d);else{const _0x507957=_0xc0849e['data'][_0x1ecc78(0xbc)];await createEnrollment({'studentId':_0x507957,'courseId':_0x95421d,'paymentId':_0xc8200d,'amount':_0x1e3e14,'paymentProvider':_0x1ecc78(0xc7)}),console['log']('WayForPay\x20Webhook:\x20Course\x20enrollment\x20successfully\x20created\x20for\x20order\x20'+_0xc8200d),sendPaymentUpdate(_0xc8200d,{'type':_0x1ecc78(0xc5),'message':'Course\x20enrollment\x20successful!','courseId':_0x95421d,'redirectUrl':_0x1ecc78(0xc8)});}}else console['error']('WayForPay\x20Webhook:\x20Invalid\x20orderReference\x20format',_0xc8200d);}}async function processPendingPayment(_0x41fb2c){console['log']('Payment\x20is\x20still\x20pending\x20for\x20'+_0x41fb2c+'.\x20No\x20enrollment\x20created\x20yet.'),sendPaymentUpdate(_0x41fb2c,{'type':'payment_pending','message':'Payment\x20is\x20still\x20being\x20processed\x20by\x20the\x20bank...'});}async function processDeclinedPayment(_0x5c8d92,_0x37592b){console['log']('Payment\x20declined\x20for\x20'+_0x5c8d92+'.\x20Reason:\x20'+_0x37592b),sendPaymentUpdate(_0x5c8d92,{'type':'payment_failed','message':'Payment\x20was\x20declined','reason':_0x37592b,'redirectUrl':'/payment/failed?provider=wayforpay&reason='+encodeURIComponent(_0x37592b)});}async function processExpiredPayment(_0x209459){const _0x307871=a5_0x466f;console[_0x307871(0xcf)]('Payment\x20expired\x20for\x20'+_0x209459);}async function processRefundedPayment(_0x3a9fc5){console['log']('Payment\x20refunded\x20for\x20'+_0x3a9fc5);}