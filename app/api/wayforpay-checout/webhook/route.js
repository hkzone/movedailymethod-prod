(function(_0x4ab6fb,_0x2ceaf3){const _0x9ffedf=a5_0x4ce0,_0x5c8567=_0x4ab6fb();while(!![]){try{const _0x26e2b1=-parseInt(_0x9ffedf(0x17b))/0x1*(-parseInt(_0x9ffedf(0x16b))/0x2)+parseInt(_0x9ffedf(0x176))/0x3+parseInt(_0x9ffedf(0x16c))/0x4+parseInt(_0x9ffedf(0x17d))/0x5+-parseInt(_0x9ffedf(0x169))/0x6*(parseInt(_0x9ffedf(0x174))/0x7)+-parseInt(_0x9ffedf(0x16f))/0x8+-parseInt(_0x9ffedf(0x16e))/0x9;if(_0x26e2b1===_0x2ceaf3)break;else _0x5c8567['push'](_0x5c8567['shift']());}catch(_0x157b66){_0x5c8567['push'](_0x5c8567['shift']());}}}(a5_0x3602,0x338b5));import{NextResponse}from'next/server';import a5_0x5dc4d3 from'crypto';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';import{getBundleById}from'@/sanity/lib/courses/getBundleById';import{client}from'@/sanity/lib/adminClient';function a5_0x3602(){const _0x8b8bbb=['WayForPay\x20Webhook:\x20Missing\x20critical\x20fields\x20from\x20payload:','wayforpay','SANITY_API_ADMIN_TOKEN','length','77bHoXsE','.\x20Reason:\x20','1241478nuqmBl','includes','stringify','NEXT_PUBLIC_SANITY_PROJECT_ID','WayForPay\x20Webhook:\x20Invalid\x20orderReference\x20format','839aJCTUv','WayForPay\x20Webhook:\x20Student\x20not\x20found\x20for\x20clerkId\x20','1782230vhjsFx','2046uQTQRf','Payment\x20is\x20still\x20pending\x20for\x20','692iCwZTw','1479592BjBFwA','error','7580304YaItnM','2986656ukZdUw'];a5_0x3602=function(){return _0x8b8bbb;};return a5_0x3602();}import{sendPaymentUpdate}from'@/lib/payment-events';const WAYFORPAY_MERCHANT_SECRET_KEY=process['env']['WAYFORPAY_MERCHANT_SECRET_KEY'];export async function POST(_0x22cd62){const _0x18ced8=a5_0x4ce0;let _0x378829;try{_0x378829=await _0x22cd62['json'](),console['log']('WayForPay\x20webhook\x20received:',JSON[_0x18ced8(0x178)](_0x378829,null,0x2)),console['log']('Admin\x20client\x20debug:',{'hasToken':!!process['env']['SANITY_API_ADMIN_TOKEN'],'tokenLength':process['env']['SANITY_API_ADMIN_TOKEN']?.['length']||0x0,'projectId':process['env'][_0x18ced8(0x179)],'dataset':process['env']['NEXT_PUBLIC_SANITY_DATASET']});const {orderReference:_0x18b05c,transactionStatus:_0x34120b,processingDate:_0x1d2660,merchantSignature:_0x346805,amount:_0x3cc347,reason:_0x16069f}=_0x378829;if(!_0x18b05c||!_0x34120b||_0x1d2660===undefined||!_0x346805)return console['error'](_0x18ced8(0x170),{'orderReference':_0x18b05c,'transactionStatus':_0x34120b,'processingDate':_0x1d2660,'receivedSignature':_0x346805}),new NextResponse('Webhook\x20Error:\x20Missing\x20fields',{'status':0x190});const {merchantAccount:_0x198372,amount:_0x295868,currency:_0x1d32c5,authCode:_0x58a007,cardPan:_0x5e4d1c,reasonCode:_0x1e359d}=_0x378829,_0x1c3f77=_0x198372+';'+_0x18b05c+';'+_0x295868+';'+_0x1d32c5+';'+_0x58a007+';'+_0x5e4d1c+';'+_0x34120b+';'+_0x1e359d,_0x22731a=a5_0x5dc4d3['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x1c3f77)['digest']('hex');if(_0x22731a!==_0x346805)return console['error']('WayForPay\x20Webhook:\x20Invalid\x20signature.',{'calculatedSignature':_0x22731a,'receivedSignature':_0x346805,'stringToSign':_0x1c3f77,'signatureFields':{'merchantAccount':_0x198372,'orderReference':_0x18b05c,'amount':_0x295868,'currency':_0x1d32c5,'authCode':_0x58a007,'cardPan':_0x5e4d1c,'transactionStatus':_0x34120b,'reasonCode':_0x1e359d}}),new NextResponse('Webhook\x20Error:\x20Invalid\x20signature',{'status':0x190});switch(_0x34120b){case'Approved':console['log']('âœ…\x20Payment\x20APPROVED\x20for\x20order\x20'+_0x18b05c),await processApprovedPayment(_0x18b05c,_0x3cc347);break;case'Pending':console['log']('â³\x20Payment\x20PENDING\x20for\x20order\x20'+_0x18b05c+'.\x20Reason:\x20'+_0x16069f),await processPendingPayment(_0x18b05c);break;case'Declined':console['log']('âŒ\x20Payment\x20DECLINED\x20for\x20order\x20'+_0x18b05c+'.\x20Reason:\x20'+_0x16069f),await processDeclinedPayment(_0x18b05c,_0x16069f);break;case'Expired':console['log']('â°\x20Payment\x20EXPIRED\x20for\x20order\x20'+_0x18b05c+'.\x20Reason:\x20'+_0x16069f),await processExpiredPayment(_0x18b05c);break;case'Refunded':console['log']('ðŸ’°\x20Payment\x20REFUNDED\x20for\x20order\x20'+_0x18b05c+'.\x20Reason:\x20'+_0x16069f),await processRefundedPayment(_0x18b05c);break;default:console['log']('â„¹ï¸\x20Unhandled\x20payment\x20status\x20\x27'+_0x34120b+'\x27\x20for\x20order\x20'+_0x18b05c+'.\x20Reason:\x20'+_0x16069f);}const _0x358eea=Math['floor'](Date['now']()/0x3e8),_0x53789f=_0x18b05c+';accept;'+_0x358eea,_0x3bd55e=a5_0x5dc4d3['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x53789f)['digest']('hex'),_0x4d7071={'orderReference':_0x18b05c,'status':'accept','time':_0x358eea,'signature':_0x3bd55e};return NextResponse['json'](_0x4d7071,{'status':0xc8});}catch(_0x33173b){console['error']('Error\x20in\x20WayForPay\x20webhook\x20handler:',_0x33173b);_0x33173b instanceof Error&&(console['error']('Error\x20details:',{'message':_0x33173b['message'],'stack':_0x33173b['stack'],'name':_0x33173b['name']}),_0x33173b['message'][_0x18ced8(0x177)]('Insufficient\x20permissions')&&console['error']('SANITY\x20PERMISSION\x20ERROR\x20DETECTED:',{'hasAdminToken':!!process['env'][_0x18ced8(0x172)],'tokenStart':process['env']['SANITY_API_ADMIN_TOKEN']?.['substring'](0x0,0x8)+'...','projectId':process['env']['NEXT_PUBLIC_SANITY_PROJECT_ID'],'dataset':process['env']['NEXT_PUBLIC_SANITY_DATASET']}));const _0x136e7b=_0x378829?.['orderReference']||'unknown_order_ref_error',_0x5cba15=Math['floor'](Date['now']()/0x3e8),_0x2291a3='error',_0x4a41fd=_0x136e7b+';'+_0x2291a3+';'+_0x5cba15,_0x44dacb=a5_0x5dc4d3['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x4a41fd)['digest']('hex');return NextResponse['json']({'orderReference':_0x136e7b,'status':_0x2291a3,'time':_0x5cba15,'signature':_0x44dacb},{'status':0x1f4});}}async function processApprovedPayment(_0x57e478,_0x378f1d){const _0x3a517a=a5_0x4ce0,_0x4add22=_0x57e478['split']('--');if(_0x4add22[0x0]==='bundle'&&_0x4add22[_0x3a517a(0x173)]>=0x4){const _0x5e0cb1=_0x4add22[0x1],_0x1b0005=_0x4add22[0x2];console['log']('Processing\x20bundle\x20order:',{'bundleId':_0x5e0cb1,'clerkUserId':_0x1b0005});const _0x96a2a7=await getStudentByClerkId(_0x1b0005);if(!_0x96a2a7?.['data']?.['_id'])console['error']('WayForPay\x20Webhook:\x20Student\x20not\x20found\x20for\x20clerkId\x20'+_0x1b0005+'\x20in\x20bundle\x20order\x20'+_0x57e478);else{const _0x357d73=await getBundleById(_0x5e0cb1);if(!_0x357d73)console[_0x3a517a(0x16d)]('WayForPay\x20Webhook:\x20Bundle\x20not\x20found\x20for\x20bundleId\x20'+_0x5e0cb1+'\x20in\x20order\x20'+_0x57e478);else{const _0x7ac0a5=_0x96a2a7['data']['_id'];console['log']('Creating\x20bundle\x20enrollment\x20for:',{'sanityStudentId':_0x7ac0a5,'bundleId':_0x5e0cb1,'orderReference':_0x57e478,'paidAmount':_0x378f1d});try{const _0x3e9e39=await client['fetch']('*[_type\x20==\x20\x22student\x22][0]');console['log']('Admin\x20client\x20read\x20test:',!!_0x3e9e39);}catch(_0x3f5c0b){console['error']('Admin\x20client\x20read\x20test\x20failed:',_0x3f5c0b);}await createBundleEnrollment({'studentId':_0x7ac0a5,'bundleId':_0x5e0cb1,'paymentId':_0x57e478,'amount':_0x378f1d,'paymentProvider':'wayforpay','bundleData':_0x357d73}),console['log']('WayForPay\x20Webhook:\x20Bundle\x20enrollment\x20successfully\x20created\x20for\x20order\x20'+_0x57e478),sendPaymentUpdate(_0x57e478,{'type':'payment_approved','message':'Bundle\x20enrollment\x20successful!','bundleId':_0x5e0cb1,'redirectUrl':'/payment/success?payment_success=wayforpay&type=bundle'});}}}else{if(_0x4add22['length']>=0x3){const _0x2bd64b=_0x4add22[0x0],_0x31c865=_0x4add22[0x1],_0x110134=await getStudentByClerkId(_0x31c865);if(!_0x110134?.['data']?.['_id'])console[_0x3a517a(0x16d)](_0x3a517a(0x17c)+_0x31c865+'\x20in\x20order\x20'+_0x57e478);else{const _0xd6877f=_0x110134['data']['_id'];await createEnrollment({'studentId':_0xd6877f,'courseId':_0x2bd64b,'paymentId':_0x57e478,'amount':_0x378f1d,'paymentProvider':_0x3a517a(0x171)}),console['log']('WayForPay\x20Webhook:\x20Course\x20enrollment\x20successfully\x20created\x20for\x20order\x20'+_0x57e478),sendPaymentUpdate(_0x57e478,{'type':'payment_approved','message':'Course\x20enrollment\x20successful!','courseId':_0x2bd64b,'redirectUrl':'/payment/success?payment_success=wayforpay&type=course'});}}else console['error'](_0x3a517a(0x17a),_0x57e478);}}async function processPendingPayment(_0x3298bd){const _0xc5fdd9=a5_0x4ce0;console['log'](_0xc5fdd9(0x16a)+_0x3298bd+'.\x20No\x20enrollment\x20created\x20yet.'),sendPaymentUpdate(_0x3298bd,{'type':'payment_pending','message':'Payment\x20is\x20still\x20being\x20processed\x20by\x20the\x20bank...'});}function a5_0x4ce0(_0xedf74b,_0x1a8608){const _0x3602bd=a5_0x3602();return a5_0x4ce0=function(_0x4ce054,_0x5f0dfa){_0x4ce054=_0x4ce054-0x169;let _0x384726=_0x3602bd[_0x4ce054];return _0x384726;},a5_0x4ce0(_0xedf74b,_0x1a8608);}async function processDeclinedPayment(_0x4384e4,_0x4f5820){const _0x4a2777=a5_0x4ce0;console['log']('Payment\x20declined\x20for\x20'+_0x4384e4+_0x4a2777(0x175)+_0x4f5820),sendPaymentUpdate(_0x4384e4,{'type':'payment_failed','message':'Payment\x20was\x20declined','reason':_0x4f5820,'redirectUrl':'/payment/failed?provider=wayforpay&reason='+encodeURIComponent(_0x4f5820)});}async function processExpiredPayment(_0x9383c4){console['log']('Payment\x20expired\x20for\x20'+_0x9383c4);}async function processRefundedPayment(_0x1656d9){console['log']('Payment\x20refunded\x20for\x20'+_0x1656d9);}