(function(_0x42a5c3,_0x5230c5){const _0x5770f5=a5_0x4f49,_0x2919d7=_0x42a5c3();while(!![]){try{const _0x31c2bc=-parseInt(_0x5770f5(0xba))/0x1+-parseInt(_0x5770f5(0xbe))/0x2*(-parseInt(_0x5770f5(0xb1))/0x3)+-parseInt(_0x5770f5(0xb9))/0x4*(-parseInt(_0x5770f5(0xbb))/0x5)+parseInt(_0x5770f5(0xc0))/0x6*(parseInt(_0x5770f5(0xac))/0x7)+-parseInt(_0x5770f5(0xbf))/0x8+-parseInt(_0x5770f5(0xb2))/0x9*(-parseInt(_0x5770f5(0xb4))/0xa)+-parseInt(_0x5770f5(0xb5))/0xb*(parseInt(_0x5770f5(0xaf))/0xc);if(_0x31c2bc===_0x5230c5)break;else _0x2919d7['push'](_0x2919d7['shift']());}catch(_0x28c543){_0x2919d7['push'](_0x2919d7['shift']());}}}(a5_0x2805,0xa43b7));import{NextResponse}from'next/server';import a5_0x279c6f from'crypto';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';import{getBundleById}from'@/sanity/lib/courses/getBundleById';function a5_0x2805(){const _0x4096cf=['230CeNTjb','187IANTDz','_id','.\x20No\x20enrollment\x20created\x20yet.','update','828FDwPBP','346723RmITvp','22885psOGiq','Webhook\x20Error:\x20Missing\x20fields','payment_approved','2098PJHnTu','97040Wkatrl','24846LKkdYo','env','.\x20Reason:\x20','âœ…\x20Payment\x20APPROVED\x20for\x20order\x20','message','unknown_order_ref_error','2072LOUnml','error','Payment\x20refunded\x20for\x20','1494132JUyBNY','createHmac','591Yhcrzu','300681hcYFwn','SANITY_API_ADMIN_TOKEN'];a5_0x2805=function(){return _0x4096cf;};return a5_0x2805();}import{client}from'@/sanity/lib/adminClient';import{sendPaymentUpdate}from'@/lib/payment-events';const WAYFORPAY_MERCHANT_SECRET_KEY=process['env']['WAYFORPAY_MERCHANT_SECRET_KEY'];export async function POST(_0x5e3ee1){const _0x421859=a5_0x4f49;let _0x3fed30;try{_0x3fed30=await _0x5e3ee1['json'](),console['log']('WayForPay\x20webhook\x20received:',JSON['stringify'](_0x3fed30,null,0x2)),console['log']('Admin\x20client\x20debug:',{'hasToken':!!process[_0x421859(0xc1)][_0x421859(0xb3)],'tokenLength':process['env']['SANITY_API_ADMIN_TOKEN']?.['length']||0x0,'projectId':process[_0x421859(0xc1)]['NEXT_PUBLIC_SANITY_PROJECT_ID'],'dataset':process['env']['NEXT_PUBLIC_SANITY_DATASET']});const {orderReference:_0x31ffd4,transactionStatus:_0x4808bb,processingDate:_0xc3e026,merchantSignature:_0x3ef857,amount:_0x508e15,reason:_0x58187c}=_0x3fed30;if(!_0x31ffd4||!_0x4808bb||_0xc3e026===undefined||!_0x3ef857)return console['error']('WayForPay\x20Webhook:\x20Missing\x20critical\x20fields\x20from\x20payload:',{'orderReference':_0x31ffd4,'transactionStatus':_0x4808bb,'processingDate':_0xc3e026,'receivedSignature':_0x3ef857}),new NextResponse(_0x421859(0xbc),{'status':0x190});const {merchantAccount:_0x2bcd26,amount:_0x1ac153,currency:_0x688997,authCode:_0x455d71,cardPan:_0x3a2c2d,reasonCode:_0x398d2f}=_0x3fed30,_0x265735=_0x2bcd26+';'+_0x31ffd4+';'+_0x1ac153+';'+_0x688997+';'+_0x455d71+';'+_0x3a2c2d+';'+_0x4808bb+';'+_0x398d2f,_0x2fd3eb=a5_0x279c6f['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x265735)['digest']('hex');if(_0x2fd3eb!==_0x3ef857)return console['error']('WayForPay\x20Webhook:\x20Invalid\x20signature.',{'calculatedSignature':_0x2fd3eb,'receivedSignature':_0x3ef857,'stringToSign':_0x265735,'signatureFields':{'merchantAccount':_0x2bcd26,'orderReference':_0x31ffd4,'amount':_0x1ac153,'currency':_0x688997,'authCode':_0x455d71,'cardPan':_0x3a2c2d,'transactionStatus':_0x4808bb,'reasonCode':_0x398d2f}}),new NextResponse('Webhook\x20Error:\x20Invalid\x20signature',{'status':0x190});switch(_0x4808bb){case'Approved':console['log'](_0x421859(0xc3)+_0x31ffd4),await processApprovedPayment(_0x31ffd4,_0x508e15);break;case'Pending':console['log']('â³\x20Payment\x20PENDING\x20for\x20order\x20'+_0x31ffd4+'.\x20Reason:\x20'+_0x58187c),await processPendingPayment(_0x31ffd4);break;case'Declined':console['log']('âŒ\x20Payment\x20DECLINED\x20for\x20order\x20'+_0x31ffd4+_0x421859(0xc2)+_0x58187c),await processDeclinedPayment(_0x31ffd4,_0x58187c);break;case'Expired':console['log']('â°\x20Payment\x20EXPIRED\x20for\x20order\x20'+_0x31ffd4+'.\x20Reason:\x20'+_0x58187c),await processExpiredPayment(_0x31ffd4);break;case'Refunded':console['log']('ðŸ’°\x20Payment\x20REFUNDED\x20for\x20order\x20'+_0x31ffd4+_0x421859(0xc2)+_0x58187c),await processRefundedPayment(_0x31ffd4);break;default:console['log']('â„¹ï¸\x20Unhandled\x20payment\x20status\x20\x27'+_0x4808bb+'\x27\x20for\x20order\x20'+_0x31ffd4+'.\x20Reason:\x20'+_0x58187c);}const _0x396c3e=Math['floor'](Date['now']()/0x3e8),_0xfff58a=_0x31ffd4+';accept;'+_0x396c3e,_0x1d12a3=a5_0x279c6f[_0x421859(0xb0)]('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0xfff58a)['digest']('hex'),_0x4efd6b={'orderReference':_0x31ffd4,'status':'accept','time':_0x396c3e,'signature':_0x1d12a3};return NextResponse['json'](_0x4efd6b,{'status':0xc8});}catch(_0x16da6b){console['error']('Error\x20in\x20WayForPay\x20webhook\x20handler:',_0x16da6b);_0x16da6b instanceof Error&&(console['error']('Error\x20details:',{'message':_0x16da6b['message'],'stack':_0x16da6b['stack'],'name':_0x16da6b['name']}),_0x16da6b[_0x421859(0xaa)]['includes']('Insufficient\x20permissions')&&console['error']('SANITY\x20PERMISSION\x20ERROR\x20DETECTED:',{'hasAdminToken':!!process['env']['SANITY_API_ADMIN_TOKEN'],'tokenStart':process['env']['SANITY_API_ADMIN_TOKEN']?.['substring'](0x0,0x8)+'...','projectId':process['env']['NEXT_PUBLIC_SANITY_PROJECT_ID'],'dataset':process['env']['NEXT_PUBLIC_SANITY_DATASET']}));const _0x3cd584=_0x3fed30?.['orderReference']||_0x421859(0xab),_0x2df5cf=Math['floor'](Date['now']()/0x3e8),_0x3af542='error',_0x30e36b=_0x3cd584+';'+_0x3af542+';'+_0x2df5cf,_0x1d7565=a5_0x279c6f[_0x421859(0xb0)]('md5',WAYFORPAY_MERCHANT_SECRET_KEY)[_0x421859(0xb8)](_0x30e36b)['digest']('hex');return NextResponse['json']({'orderReference':_0x3cd584,'status':_0x3af542,'time':_0x2df5cf,'signature':_0x1d7565},{'status':0x1f4});}}async function processApprovedPayment(_0x4d4158,_0x2e223a){const _0x2b6afc=a5_0x4f49,_0x1ff8f9=_0x4d4158['split']('--');if(_0x1ff8f9[0x0]==='bundle'&&_0x1ff8f9['length']>=0x4){const _0x11f194=_0x1ff8f9[0x1],_0x31be03=_0x1ff8f9[0x2];console['log']('Processing\x20bundle\x20order:',{'bundleId':_0x11f194,'clerkUserId':_0x31be03});const _0x44e366=await getStudentByClerkId(_0x31be03);if(!_0x44e366?.['data']?.['_id'])console[_0x2b6afc(0xad)]('WayForPay\x20Webhook:\x20Student\x20not\x20found\x20for\x20clerkId\x20'+_0x31be03+'\x20in\x20bundle\x20order\x20'+_0x4d4158);else{const _0x3d8ee4=await getBundleById(_0x11f194);if(!_0x3d8ee4)console['error']('WayForPay\x20Webhook:\x20Bundle\x20not\x20found\x20for\x20bundleId\x20'+_0x11f194+'\x20in\x20order\x20'+_0x4d4158);else{const _0x4df5e4=_0x44e366['data'][_0x2b6afc(0xb6)];console['log']('Creating\x20bundle\x20enrollment\x20for:',{'sanityStudentId':_0x4df5e4,'bundleId':_0x11f194,'orderReference':_0x4d4158,'paidAmount':_0x2e223a});try{const _0x2cdad8=await client['fetch']('*[_type\x20==\x20\x22student\x22][0]');console['log']('Admin\x20client\x20read\x20test:',!!_0x2cdad8);}catch(_0x145924){console['error']('Admin\x20client\x20read\x20test\x20failed:',_0x145924);}await createBundleEnrollment({'studentId':_0x4df5e4,'bundleId':_0x11f194,'paymentId':_0x4d4158,'amount':_0x2e223a,'paymentProvider':'wayforpay','bundleData':_0x3d8ee4}),console['log']('WayForPay\x20Webhook:\x20Bundle\x20enrollment\x20successfully\x20created\x20for\x20order\x20'+_0x4d4158),sendPaymentUpdate(_0x4d4158,{'type':'payment_approved','message':'Bundle\x20enrollment\x20successful!','bundleId':_0x11f194,'redirectUrl':'/payment/success?payment_success=wayforpay&type=bundle'});}}}else{if(_0x1ff8f9['length']>=0x3){const _0xc95d95=_0x1ff8f9[0x0],_0xda407c=_0x1ff8f9[0x1],_0xec642d=await getStudentByClerkId(_0xda407c);if(!_0xec642d?.['data']?.['_id'])console['error']('WayForPay\x20Webhook:\x20Student\x20not\x20found\x20for\x20clerkId\x20'+_0xda407c+'\x20in\x20order\x20'+_0x4d4158);else{const _0x2add9c=_0xec642d['data']['_id'];await createEnrollment({'studentId':_0x2add9c,'courseId':_0xc95d95,'paymentId':_0x4d4158,'amount':_0x2e223a,'paymentProvider':'wayforpay'}),console['log']('WayForPay\x20Webhook:\x20Course\x20enrollment\x20successfully\x20created\x20for\x20order\x20'+_0x4d4158),sendPaymentUpdate(_0x4d4158,{'type':_0x2b6afc(0xbd),'message':'Course\x20enrollment\x20successful!','courseId':_0xc95d95,'redirectUrl':'/payment/success?payment_success=wayforpay&type=course'});}}else console['error']('WayForPay\x20Webhook:\x20Invalid\x20orderReference\x20format',_0x4d4158);}}async function processPendingPayment(_0x1dfdeb){const _0x27315e=a5_0x4f49;console['log']('Payment\x20is\x20still\x20pending\x20for\x20'+_0x1dfdeb+_0x27315e(0xb7)),sendPaymentUpdate(_0x1dfdeb,{'type':'payment_pending','message':'Payment\x20is\x20still\x20being\x20processed\x20by\x20the\x20bank...'});}async function processDeclinedPayment(_0x49fe72,_0x30e5ea){console['log']('Payment\x20declined\x20for\x20'+_0x49fe72+'.\x20Reason:\x20'+_0x30e5ea),sendPaymentUpdate(_0x49fe72,{'type':'payment_failed','message':'Payment\x20was\x20declined','reason':_0x30e5ea,'redirectUrl':'/payment/failed?provider=wayforpay&reason='+encodeURIComponent(_0x30e5ea)});}async function processExpiredPayment(_0x18cdcb){console['log']('Payment\x20expired\x20for\x20'+_0x18cdcb);}function a5_0x4f49(_0x47b541,_0x257e09){const _0x28057b=a5_0x2805();return a5_0x4f49=function(_0x4f49cd,_0x3bd42e){_0x4f49cd=_0x4f49cd-0xaa;let _0x24d2fc=_0x28057b[_0x4f49cd];return _0x24d2fc;},a5_0x4f49(_0x47b541,_0x257e09);}async function processRefundedPayment(_0x4fd39d){const _0x5802e5=a5_0x4f49;console['log'](_0x5802e5(0xae)+_0x4fd39d);}