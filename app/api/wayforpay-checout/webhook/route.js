(function(_0x31bf7b,_0x57bdeb){const _0x48a6d9=a5_0x4269,_0x340aec=_0x31bf7b();while(!![]){try{const _0x50e9d7=parseInt(_0x48a6d9(0x106))/0x1*(parseInt(_0x48a6d9(0xff))/0x2)+-parseInt(_0x48a6d9(0x100))/0x3+-parseInt(_0x48a6d9(0xfe))/0x4*(-parseInt(_0x48a6d9(0xfa))/0x5)+-parseInt(_0x48a6d9(0x104))/0x6+-parseInt(_0x48a6d9(0x113))/0x7*(-parseInt(_0x48a6d9(0x108))/0x8)+-parseInt(_0x48a6d9(0xfc))/0x9*(-parseInt(_0x48a6d9(0x109))/0xa)+-parseInt(_0x48a6d9(0xfd))/0xb*(-parseInt(_0x48a6d9(0x111))/0xc);if(_0x50e9d7===_0x57bdeb)break;else _0x340aec['push'](_0x340aec['shift']());}catch(_0x32a068){_0x340aec['push'](_0x340aec['shift']());}}}(a5_0x139b,0xa17cb));import{NextResponse}from'next/server';import a5_0x3dcbf3 from'crypto';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';import{getBundleById}from'@/sanity/lib/courses/getBundleById';import{client}from'@/sanity/lib/adminClient';function a5_0x139b(){const _0x1112c9=['30QpItqT','digest','3198249pkTCVK','814wfuraK','263748HpNIZX','2fgICbS','843594nxUSGY','log','createHmac','payment_pending','5477592cplZYF','_id','154689epAJQL','env','8ziQics','10iHPeAU','error','stringify','Processing\x20bundle\x20order:','payment_failed','update','â°\x20Payment\x20EXPIRED\x20for\x20order\x20','WayForPay\x20Webhook:\x20Invalid\x20orderReference\x20format','152364xZdRHe','.\x20Reason:\x20','72317BjwUiM','floor','WayForPay\x20Webhook:\x20Student\x20not\x20found\x20for\x20clerkId\x20','ðŸ’°\x20Payment\x20REFUNDED\x20for\x20order\x20'];a5_0x139b=function(){return _0x1112c9;};return a5_0x139b();}import{sendPaymentUpdate}from'@/lib/payment-events';const WAYFORPAY_MERCHANT_SECRET_KEY=process['env']['WAYFORPAY_MERCHANT_SECRET_KEY'];export async function POST(_0x15e7f4){const _0x17fa0e=a5_0x4269;let _0x21b866;try{_0x21b866=await _0x15e7f4['json'](),console['log']('WayForPay\x20webhook\x20received:',JSON[_0x17fa0e(0x10b)](_0x21b866,null,0x2)),console['log']('Admin\x20client\x20debug:',{'hasToken':!!process['env']['SANITY_API_ADMIN_TOKEN'],'tokenLength':process[_0x17fa0e(0x107)]['SANITY_API_ADMIN_TOKEN']?.['length']||0x0,'projectId':process[_0x17fa0e(0x107)]['NEXT_PUBLIC_SANITY_PROJECT_ID'],'dataset':process['env']['NEXT_PUBLIC_SANITY_DATASET']});const {orderReference:_0x540e03,transactionStatus:_0xccd553,processingDate:_0x455a81,merchantSignature:_0x43f126,amount:_0x5cb1d7,reason:_0x46cf27}=_0x21b866;if(!_0x540e03||!_0xccd553||_0x455a81===undefined||!_0x43f126)return console['error']('WayForPay\x20Webhook:\x20Missing\x20critical\x20fields\x20from\x20payload:',{'orderReference':_0x540e03,'transactionStatus':_0xccd553,'processingDate':_0x455a81,'receivedSignature':_0x43f126}),new NextResponse('Webhook\x20Error:\x20Missing\x20fields',{'status':0x190});const {merchantAccount:_0x3903fb,amount:_0x3ce5e2,currency:_0x399f92,authCode:_0x1b81b8,cardPan:_0x361e2d,reasonCode:_0x5d50a0}=_0x21b866,_0x1b9b23=_0x3903fb+';'+_0x540e03+';'+_0x3ce5e2+';'+_0x399f92+';'+_0x1b81b8+';'+_0x361e2d+';'+_0xccd553+';'+_0x5d50a0,_0x2fdc4a=a5_0x3dcbf3['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x1b9b23)['digest']('hex');if(_0x2fdc4a!==_0x43f126)return console['error']('WayForPay\x20Webhook:\x20Invalid\x20signature.',{'calculatedSignature':_0x2fdc4a,'receivedSignature':_0x43f126,'stringToSign':_0x1b9b23,'signatureFields':{'merchantAccount':_0x3903fb,'orderReference':_0x540e03,'amount':_0x3ce5e2,'currency':_0x399f92,'authCode':_0x1b81b8,'cardPan':_0x361e2d,'transactionStatus':_0xccd553,'reasonCode':_0x5d50a0}}),new NextResponse('Webhook\x20Error:\x20Invalid\x20signature',{'status':0x190});switch(_0xccd553){case'Approved':console['log']('âœ…\x20Payment\x20APPROVED\x20for\x20order\x20'+_0x540e03),await processApprovedPayment(_0x540e03,_0x5cb1d7);break;case'Pending':console['log']('â³\x20Payment\x20PENDING\x20for\x20order\x20'+_0x540e03+'.\x20Reason:\x20'+_0x46cf27),await processPendingPayment(_0x540e03);break;case'Declined':console['log']('âŒ\x20Payment\x20DECLINED\x20for\x20order\x20'+_0x540e03+'.\x20Reason:\x20'+_0x46cf27),await processDeclinedPayment(_0x540e03,_0x46cf27);break;case'Expired':console['log'](_0x17fa0e(0x10f)+_0x540e03+'.\x20Reason:\x20'+_0x46cf27),await processExpiredPayment(_0x540e03);break;case'Refunded':console['log'](_0x17fa0e(0xf9)+_0x540e03+_0x17fa0e(0x112)+_0x46cf27),await processRefundedPayment(_0x540e03);break;default:console['log']('â„¹ï¸\x20Unhandled\x20payment\x20status\x20\x27'+_0xccd553+'\x27\x20for\x20order\x20'+_0x540e03+'.\x20Reason:\x20'+_0x46cf27);}const _0x9016fb=Math[_0x17fa0e(0x114)](Date['now']()/0x3e8),_0x20f273=_0x540e03+';accept;'+_0x9016fb,_0x3e1920=a5_0x3dcbf3[_0x17fa0e(0x102)]('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x20f273)['digest']('hex'),_0x156ba0={'orderReference':_0x540e03,'status':'accept','time':_0x9016fb,'signature':_0x3e1920};return NextResponse['json'](_0x156ba0,{'status':0xc8});}catch(_0x99c1fb){console['error']('Error\x20in\x20WayForPay\x20webhook\x20handler:',_0x99c1fb);_0x99c1fb instanceof Error&&(console['error']('Error\x20details:',{'message':_0x99c1fb['message'],'stack':_0x99c1fb['stack'],'name':_0x99c1fb['name']}),_0x99c1fb['message']['includes']('Insufficient\x20permissions')&&console[_0x17fa0e(0x10a)]('SANITY\x20PERMISSION\x20ERROR\x20DETECTED:',{'hasAdminToken':!!process['env']['SANITY_API_ADMIN_TOKEN'],'tokenStart':process['env']['SANITY_API_ADMIN_TOKEN']?.['substring'](0x0,0x8)+'...','projectId':process['env']['NEXT_PUBLIC_SANITY_PROJECT_ID'],'dataset':process['env']['NEXT_PUBLIC_SANITY_DATASET']}));const _0x396124=_0x21b866?.['orderReference']||'unknown_order_ref_error',_0x5d4a92=Math['floor'](Date['now']()/0x3e8),_0x154ee3='error',_0xed5177=_0x396124+';'+_0x154ee3+';'+_0x5d4a92,_0x44c1ac=a5_0x3dcbf3[_0x17fa0e(0x102)]('md5',WAYFORPAY_MERCHANT_SECRET_KEY)[_0x17fa0e(0x10e)](_0xed5177)[_0x17fa0e(0xfb)]('hex');return NextResponse['json']({'orderReference':_0x396124,'status':_0x154ee3,'time':_0x5d4a92,'signature':_0x44c1ac},{'status':0x1f4});}}async function processApprovedPayment(_0xeb5fb3,_0x4df602){const _0x35eacf=a5_0x4269,_0x2506f5=_0xeb5fb3['split']('--');if(_0x2506f5[0x0]==='bundle'&&_0x2506f5['length']>=0x4){const _0x3b60e9=_0x2506f5[0x1],_0x58a658=_0x2506f5[0x2];console[_0x35eacf(0x101)](_0x35eacf(0x10c),{'bundleId':_0x3b60e9,'clerkUserId':_0x58a658});const _0x3df73d=await getStudentByClerkId(_0x58a658);if(!_0x3df73d?.['data']?.[_0x35eacf(0x105)])console['error'](_0x35eacf(0x115)+_0x58a658+'\x20in\x20bundle\x20order\x20'+_0xeb5fb3);else{const _0x3fa759=await getBundleById(_0x3b60e9);if(!_0x3fa759)console['error']('WayForPay\x20Webhook:\x20Bundle\x20not\x20found\x20for\x20bundleId\x20'+_0x3b60e9+'\x20in\x20order\x20'+_0xeb5fb3);else{const _0x6ffa3e=_0x3df73d['data']['_id'];console['log']('Creating\x20bundle\x20enrollment\x20for:',{'sanityStudentId':_0x6ffa3e,'bundleId':_0x3b60e9,'orderReference':_0xeb5fb3,'paidAmount':_0x4df602});try{const _0x18fe6c=await client['fetch']('*[_type\x20==\x20\x22student\x22][0]');console['log']('Admin\x20client\x20read\x20test:',!!_0x18fe6c);}catch(_0x244e22){console['error']('Admin\x20client\x20read\x20test\x20failed:',_0x244e22);}await createBundleEnrollment({'studentId':_0x6ffa3e,'bundleId':_0x3b60e9,'paymentId':_0xeb5fb3,'amount':_0x4df602,'paymentProvider':'wayforpay','bundleData':_0x3fa759}),console['log']('WayForPay\x20Webhook:\x20Bundle\x20enrollment\x20successfully\x20created\x20for\x20order\x20'+_0xeb5fb3),sendPaymentUpdate(_0xeb5fb3,{'type':'payment_approved','message':'Bundle\x20enrollment\x20successful!','bundleId':_0x3b60e9,'redirectUrl':'/payment/success?payment_success=wayforpay&type=bundle'});}}}else{if(_0x2506f5['length']>=0x3){const _0x1f866f=_0x2506f5[0x0],_0x39346c=_0x2506f5[0x1],_0x413b4f=await getStudentByClerkId(_0x39346c);if(!_0x413b4f?.['data']?.['_id'])console['error']('WayForPay\x20Webhook:\x20Student\x20not\x20found\x20for\x20clerkId\x20'+_0x39346c+'\x20in\x20order\x20'+_0xeb5fb3);else{const _0x36e404=_0x413b4f['data']['_id'];await createEnrollment({'studentId':_0x36e404,'courseId':_0x1f866f,'paymentId':_0xeb5fb3,'amount':_0x4df602,'paymentProvider':'wayforpay'}),console['log']('WayForPay\x20Webhook:\x20Course\x20enrollment\x20successfully\x20created\x20for\x20order\x20'+_0xeb5fb3),sendPaymentUpdate(_0xeb5fb3,{'type':'payment_approved','message':'Course\x20enrollment\x20successful!','courseId':_0x1f866f,'redirectUrl':'/payment/success?payment_success=wayforpay&type=course'});}}else console['error'](_0x35eacf(0x110),_0xeb5fb3);}}async function processPendingPayment(_0x392eba){const _0x5a4d35=a5_0x4269;console['log']('Payment\x20is\x20still\x20pending\x20for\x20'+_0x392eba+'.\x20No\x20enrollment\x20created\x20yet.'),sendPaymentUpdate(_0x392eba,{'type':_0x5a4d35(0x103),'message':'Payment\x20is\x20still\x20being\x20processed\x20by\x20the\x20bank...'});}async function processDeclinedPayment(_0x2d1a3c,_0xa48b91){const _0x40aebb=a5_0x4269;console['log']('Payment\x20declined\x20for\x20'+_0x2d1a3c+'.\x20Reason:\x20'+_0xa48b91),sendPaymentUpdate(_0x2d1a3c,{'type':_0x40aebb(0x10d),'message':'Payment\x20was\x20declined','reason':_0xa48b91,'redirectUrl':'/payment/failed?provider=wayforpay&reason='+encodeURIComponent(_0xa48b91)});}async function processExpiredPayment(_0x5d7a11){console['log']('Payment\x20expired\x20for\x20'+_0x5d7a11);}function a5_0x4269(_0x2fd686,_0x4ea6c5){const _0x139b1c=a5_0x139b();return a5_0x4269=function(_0x4269e5,_0x48b1ad){_0x4269e5=_0x4269e5-0xf9;let _0x291e3a=_0x139b1c[_0x4269e5];return _0x291e3a;},a5_0x4269(_0x2fd686,_0x4ea6c5);}async function processRefundedPayment(_0x437b89){console['log']('Payment\x20refunded\x20for\x20'+_0x437b89);}