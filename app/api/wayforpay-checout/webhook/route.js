function a5_0xfae2(){const _0x163f14=['digest','.\x20Reason:\x20','update','/payment/success?payment_success=wayforpay&type=bundle','3WgWmAW','60960gOOZKN','wayforpay','2963184Edkthv','423668VdtyjU','\x20in\x20order\x20','Expired','2587256pbptwS','18twXpkk','797365QTuJIE','741195fPKvGl','_id','82964CphVSV','...','log','Admin\x20client\x20read\x20test\x20failed:','Pending','\x20in\x20bundle\x20order\x20'];a5_0xfae2=function(){return _0x163f14;};return a5_0xfae2();}(function(_0xa7d959,_0x11ea75){const _0xe83987=a5_0x26b4,_0x7261b=_0xa7d959();while(!![]){try{const _0x2f8f8c=-parseInt(_0xe83987(0xe7))/0x1+parseInt(_0xe83987(0xdc))/0x2+-parseInt(_0xe83987(0xe6))/0x3*(parseInt(_0xe83987(0xea))/0x4)+parseInt(_0xe83987(0xd9))/0x5*(parseInt(_0xe83987(0xd8))/0x6)+parseInt(_0xe83987(0xed))/0x7+-parseInt(_0xe83987(0xe9))/0x8+-parseInt(_0xe83987(0xda))/0x9;if(_0x2f8f8c===_0x11ea75)break;else _0x7261b['push'](_0x7261b['shift']());}catch(_0x1e14ef){_0x7261b['push'](_0x7261b['shift']());}}}(a5_0xfae2,0x41e37));import{NextResponse}from'next/server';import a5_0x5d6c4d from'crypto';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';import{getBundleById}from'@/sanity/lib/courses/getBundleById';import{client}from'@/sanity/lib/adminClient';import{sendPaymentUpdate}from'@/lib/payment-events';const WAYFORPAY_MERCHANT_SECRET_KEY=process['env']['WAYFORPAY_MERCHANT_SECRET_KEY'];export async function POST(_0x19c356){const _0x2160ee=a5_0x26b4;let _0x196ac5;try{_0x196ac5=await _0x19c356['json'](),console['log']('WayForPay\x20webhook\x20received:',JSON['stringify'](_0x196ac5,null,0x2)),console['log']('Admin\x20client\x20debug:',{'hasToken':!!process['env']['SANITY_API_ADMIN_TOKEN'],'tokenLength':process['env']['SANITY_API_ADMIN_TOKEN']?.['length']||0x0,'projectId':process['env']['NEXT_PUBLIC_SANITY_PROJECT_ID'],'dataset':process['env']['NEXT_PUBLIC_SANITY_DATASET']});const {orderReference:_0x402caa,transactionStatus:_0x18d54f,processingDate:_0x55271b,merchantSignature:_0x83e14d,amount:_0x1711b4,reason:_0x14d273}=_0x196ac5;if(!_0x402caa||!_0x18d54f||_0x55271b===undefined||!_0x83e14d)return console['error']('WayForPay\x20Webhook:\x20Missing\x20critical\x20fields\x20from\x20payload:',{'orderReference':_0x402caa,'transactionStatus':_0x18d54f,'processingDate':_0x55271b,'receivedSignature':_0x83e14d}),new NextResponse('Webhook\x20Error:\x20Missing\x20fields',{'status':0x190});const {merchantAccount:_0x2413b3,amount:_0x4b8c5a,currency:_0x1dfad0,authCode:_0xf5cfa,cardPan:_0x1a17a5,reasonCode:_0x19a438}=_0x196ac5,_0x3bccd9=_0x2413b3+';'+_0x402caa+';'+_0x4b8c5a+';'+_0x1dfad0+';'+_0xf5cfa+';'+_0x1a17a5+';'+_0x18d54f+';'+_0x19a438,_0x28aefc=a5_0x5d6c4d['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)[_0x2160ee(0xe4)](_0x3bccd9)[_0x2160ee(0xe2)]('hex');if(_0x28aefc!==_0x83e14d)return console['error']('WayForPay\x20Webhook:\x20Invalid\x20signature.',{'calculatedSignature':_0x28aefc,'receivedSignature':_0x83e14d,'stringToSign':_0x3bccd9,'signatureFields':{'merchantAccount':_0x2413b3,'orderReference':_0x402caa,'amount':_0x4b8c5a,'currency':_0x1dfad0,'authCode':_0xf5cfa,'cardPan':_0x1a17a5,'transactionStatus':_0x18d54f,'reasonCode':_0x19a438}}),new NextResponse('Webhook\x20Error:\x20Invalid\x20signature',{'status':0x190});switch(_0x18d54f){case'Approved':console['log']('âœ…\x20Payment\x20APPROVED\x20for\x20order\x20'+_0x402caa),await processApprovedPayment(_0x402caa,_0x1711b4);break;case _0x2160ee(0xe0):console['log']('â³\x20Payment\x20PENDING\x20for\x20order\x20'+_0x402caa+'.\x20Reason:\x20'+_0x14d273),await processPendingPayment(_0x402caa);break;case'Declined':console[_0x2160ee(0xde)]('âŒ\x20Payment\x20DECLINED\x20for\x20order\x20'+_0x402caa+'.\x20Reason:\x20'+_0x14d273),await processDeclinedPayment(_0x402caa,_0x14d273);break;case _0x2160ee(0xec):console['log']('â°\x20Payment\x20EXPIRED\x20for\x20order\x20'+_0x402caa+'.\x20Reason:\x20'+_0x14d273),await processExpiredPayment(_0x402caa);break;case'Refunded':console['log']('ðŸ’°\x20Payment\x20REFUNDED\x20for\x20order\x20'+_0x402caa+_0x2160ee(0xe3)+_0x14d273),await processRefundedPayment(_0x402caa);break;default:console['log']('â„¹ï¸\x20Unhandled\x20payment\x20status\x20\x27'+_0x18d54f+'\x27\x20for\x20order\x20'+_0x402caa+'.\x20Reason:\x20'+_0x14d273);}const _0x27c8ec=Math['floor'](Date['now']()/0x3e8),_0x58a1d3=_0x402caa+';accept;'+_0x27c8ec,_0xd03daf=a5_0x5d6c4d['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x58a1d3)['digest']('hex'),_0xc8d4c={'orderReference':_0x402caa,'status':'accept','time':_0x27c8ec,'signature':_0xd03daf};return NextResponse['json'](_0xc8d4c,{'status':0xc8});}catch(_0x15f9c0){console['error']('Error\x20in\x20WayForPay\x20webhook\x20handler:',_0x15f9c0);_0x15f9c0 instanceof Error&&(console['error']('Error\x20details:',{'message':_0x15f9c0['message'],'stack':_0x15f9c0['stack'],'name':_0x15f9c0['name']}),_0x15f9c0['message']['includes']('Insufficient\x20permissions')&&console['error']('SANITY\x20PERMISSION\x20ERROR\x20DETECTED:',{'hasAdminToken':!!process['env']['SANITY_API_ADMIN_TOKEN'],'tokenStart':process['env']['SANITY_API_ADMIN_TOKEN']?.['substring'](0x0,0x8)+_0x2160ee(0xdd),'projectId':process['env']['NEXT_PUBLIC_SANITY_PROJECT_ID'],'dataset':process['env']['NEXT_PUBLIC_SANITY_DATASET']}));const _0x5a3aab=_0x196ac5?.['orderReference']||'unknown_order_ref_error',_0xd9de93=Math['floor'](Date['now']()/0x3e8),_0x357ce6='error',_0x1c16f0=_0x5a3aab+';'+_0x357ce6+';'+_0xd9de93,_0x44cc53=a5_0x5d6c4d['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x1c16f0)['digest']('hex');return NextResponse['json']({'orderReference':_0x5a3aab,'status':_0x357ce6,'time':_0xd9de93,'signature':_0x44cc53},{'status':0x1f4});}}async function processApprovedPayment(_0x3984a6,_0x38fbae){const _0x5a9625=a5_0x26b4,_0x31a7d1=_0x3984a6['split']('--');if(_0x31a7d1[0x0]==='bundle'&&_0x31a7d1['length']>=0x4){const _0x48113d=_0x31a7d1[0x1],_0x3eae96=_0x31a7d1[0x2];console['log']('Processing\x20bundle\x20order:',{'bundleId':_0x48113d,'clerkUserId':_0x3eae96});const _0x6c3eb9=await getStudentByClerkId(_0x3eae96);if(!_0x6c3eb9?.['data']?.['_id'])console['error']('WayForPay\x20Webhook:\x20Student\x20not\x20found\x20for\x20clerkId\x20'+_0x3eae96+_0x5a9625(0xe1)+_0x3984a6);else{const _0x3fdef6=await getBundleById(_0x48113d);if(!_0x3fdef6)console['error']('WayForPay\x20Webhook:\x20Bundle\x20not\x20found\x20for\x20bundleId\x20'+_0x48113d+'\x20in\x20order\x20'+_0x3984a6);else{const _0x1ad9fe=_0x6c3eb9['data']['_id'];console['log']('Creating\x20bundle\x20enrollment\x20for:',{'sanityStudentId':_0x1ad9fe,'bundleId':_0x48113d,'orderReference':_0x3984a6,'paidAmount':_0x38fbae});try{const _0x201002=await client['fetch']('*[_type\x20==\x20\x22student\x22][0]');console['log']('Admin\x20client\x20read\x20test:',!!_0x201002);}catch(_0x5cab3e){console['error'](_0x5a9625(0xdf),_0x5cab3e);}await createBundleEnrollment({'studentId':_0x1ad9fe,'bundleId':_0x48113d,'paymentId':_0x3984a6,'amount':_0x38fbae,'paymentProvider':_0x5a9625(0xe8),'bundleData':_0x3fdef6}),console['log']('WayForPay\x20Webhook:\x20Bundle\x20enrollment\x20successfully\x20created\x20for\x20order\x20'+_0x3984a6),sendPaymentUpdate(_0x3984a6,{'type':'payment_approved','message':'Bundle\x20enrollment\x20successful!','bundleId':_0x48113d,'redirectUrl':_0x5a9625(0xe5)});}}}else{if(_0x31a7d1['length']>=0x3){const _0x51cf09=_0x31a7d1[0x0],_0x2d881f=_0x31a7d1[0x1],_0x32ae25=await getStudentByClerkId(_0x2d881f);if(!_0x32ae25?.['data']?.['_id'])console['error']('WayForPay\x20Webhook:\x20Student\x20not\x20found\x20for\x20clerkId\x20'+_0x2d881f+_0x5a9625(0xeb)+_0x3984a6);else{const _0x357410=_0x32ae25['data'][_0x5a9625(0xdb)];await createEnrollment({'studentId':_0x357410,'courseId':_0x51cf09,'paymentId':_0x3984a6,'amount':_0x38fbae,'paymentProvider':'wayforpay'}),console['log']('WayForPay\x20Webhook:\x20Course\x20enrollment\x20successfully\x20created\x20for\x20order\x20'+_0x3984a6),sendPaymentUpdate(_0x3984a6,{'type':'payment_approved','message':'Course\x20enrollment\x20successful!','courseId':_0x51cf09,'redirectUrl':'/payment/success?payment_success=wayforpay&type=course'});}}else console['error']('WayForPay\x20Webhook:\x20Invalid\x20orderReference\x20format',_0x3984a6);}}function a5_0x26b4(_0x3ce204,_0xa1e00){const _0xfae201=a5_0xfae2();return a5_0x26b4=function(_0x26b425,_0x320383){_0x26b425=_0x26b425-0xd8;let _0x26bfc9=_0xfae201[_0x26b425];return _0x26bfc9;},a5_0x26b4(_0x3ce204,_0xa1e00);}async function processPendingPayment(_0x15852a){console['log']('Payment\x20is\x20still\x20pending\x20for\x20'+_0x15852a+'.\x20No\x20enrollment\x20created\x20yet.'),sendPaymentUpdate(_0x15852a,{'type':'payment_pending','message':'Payment\x20is\x20still\x20being\x20processed\x20by\x20the\x20bank...'});}async function processDeclinedPayment(_0x34d5d2,_0x2cbb52){console['log']('Payment\x20declined\x20for\x20'+_0x34d5d2+'.\x20Reason:\x20'+_0x2cbb52),sendPaymentUpdate(_0x34d5d2,{'type':'payment_failed','message':'Payment\x20was\x20declined','reason':_0x2cbb52,'redirectUrl':'/payment/failed?provider=wayforpay&reason='+encodeURIComponent(_0x2cbb52)});}async function processExpiredPayment(_0x4c55ed){console['log']('Payment\x20expired\x20for\x20'+_0x4c55ed);}async function processRefundedPayment(_0x3082a2){console['log']('Payment\x20refunded\x20for\x20'+_0x3082a2);}