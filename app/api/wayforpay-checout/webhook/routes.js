function a3_0x429f(){const _0x34adb8=['6822552OuvgJg','1654118OfbRbl','log','219GjeIcj','227916XbwfFh','3066460psIRPA','\x20in\x20order\x20','28208GTvBUS','\x27\x20for\x20order\x20','6665067hNsLMW','37402gGgVEV','1589ZsTQbS','update','105HWSafI',';accept;'];a3_0x429f=function(){return _0x34adb8;};return a3_0x429f();}(function(_0x463201,_0x477cf4){const _0x782bfa=a3_0x40d6,_0x5f4a7f=_0x463201();while(!![]){try{const _0x2516a7=-parseInt(_0x782bfa(0xa5))/0x1+-parseInt(_0x782bfa(0xae))/0x2*(-parseInt(_0x782bfa(0xa7))/0x3)+parseInt(_0x782bfa(0xa4))/0x4+-parseInt(_0x782bfa(0xb1))/0x5*(parseInt(_0x782bfa(0xa8))/0x6)+-parseInt(_0x782bfa(0xaf))/0x7*(-parseInt(_0x782bfa(0xab))/0x8)+-parseInt(_0x782bfa(0xad))/0x9+parseInt(_0x782bfa(0xa9))/0xa;if(_0x2516a7===_0x477cf4)break;else _0x5f4a7f['push'](_0x5f4a7f['shift']());}catch(_0x2ec522){_0x5f4a7f['push'](_0x5f4a7f['shift']());}}}(a3_0x429f,0xf0980));import{NextResponse}from'next/server';import a3_0x439966 from'crypto';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';function a3_0x40d6(_0x3e30cf,_0x5d9adb){const _0x429f72=a3_0x429f();return a3_0x40d6=function(_0x40d65d,_0x26fd9c){_0x40d65d=_0x40d65d-0xa4;let _0x4b3e48=_0x429f72[_0x40d65d];return _0x4b3e48;},a3_0x40d6(_0x3e30cf,_0x5d9adb);}import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';const WAYFORPAY_MERCHANT_SECRET_KEY=process['env']['WAYFORPAY_MERCHANT_SECRET_KEY'];export async function POST(_0xc176be){const _0xf88e18=a3_0x40d6;let _0x266a36;try{_0x266a36=await _0xc176be['json'](),console['log']('WayForPay\x20webhook\x20received:',JSON['stringify'](_0x266a36,null,0x2));const {orderReference:_0x2e2939,transactionStatus:_0x495a8b,processingDate:_0x38482d,merchantSignature:_0x155a8e,amount:_0x3f77e4}=_0x266a36;if(!_0x2e2939||!_0x495a8b||_0x38482d===undefined||!_0x155a8e)return console['error']('WayForPay\x20Webhook:\x20Missing\x20critical\x20fields\x20from\x20payload:',{'orderReference':_0x2e2939,'transactionStatus':_0x495a8b,'processingDate':_0x38482d,'receivedSignature':_0x155a8e}),new NextResponse('Webhook\x20Error:\x20Missing\x20fields',{'status':0x190});const _0x532ed1=_0x2e2939+';'+_0x495a8b+';'+_0x38482d,_0x55731b=a3_0x439966['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)[_0xf88e18(0xb0)](_0x532ed1)['digest']('hex');if(_0x55731b!==_0x155a8e)return console['error']('WayForPay\x20Webhook:\x20Invalid\x20signature.',{'calculatedSignature':_0x55731b,'receivedSignature':_0x155a8e,'stringToSign':_0x532ed1}),new NextResponse('Webhook\x20Error:\x20Invalid\x20signature',{'status':0x190});if(_0x495a8b==='Approved'){const _0x8a9ebc=_0x2e2939['split']('_');if(_0x8a9ebc['length']<0x3)console['error']('WayForPay\x20Webhook:\x20Invalid\x20orderReference\x20format',_0x2e2939);else{const _0x10f56b=_0x8a9ebc[0x0],_0x500bf0=_0x8a9ebc[0x1],_0x2aee74=await getStudentByClerkId(_0x500bf0);if(!_0x2aee74?.['data']?.['_id'])console['error']('WayForPay\x20Webhook:\x20Student\x20not\x20found\x20for\x20clerkId\x20'+_0x500bf0+_0xf88e18(0xaa)+_0x2e2939);else{const _0x4e46fe=_0x2aee74['data']['_id'];await createEnrollment({'studentId':_0x4e46fe,'courseId':_0x10f56b,'paymentId':_0x2e2939,'amount':_0x3f77e4,'paymentProvider':'wayforpay'}),console['log']('WayForPay\x20Webhook:\x20Enrollment\x20successfully\x20created\x20for\x20order\x20'+_0x2e2939);}}}else console[_0xf88e18(0xa6)]('WayForPay\x20Webhook:\x20Received\x20status\x20\x27'+_0x495a8b+_0xf88e18(0xac)+_0x2e2939+'.\x20No\x20enrollment\x20action\x20taken.');const _0xc0a409=Math['floor'](Date['now']()/0x3e8),_0x4613e6=_0x2e2939+_0xf88e18(0xb2)+_0xc0a409,_0xbc29f9=a3_0x439966['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x4613e6)['digest']('hex'),_0x2ae1ea={'orderReference':_0x2e2939,'status':'accept','time':_0xc0a409,'signature':_0xbc29f9};return NextResponse['json'](_0x2ae1ea,{'status':0xc8});}catch(_0x5af052){console['error']('Error\x20in\x20WayForPay\x20webhook\x20handler:',_0x5af052);const _0x40e4b4=_0x266a36?.['orderReference']||'unknown_order_ref_error',_0x199a30=Math['floor'](Date['now']()/0x3e8),_0x33d1c0='error',_0x3fc363=_0x40e4b4+';'+_0x33d1c0+';'+_0x199a30,_0x3d2ba3=a3_0x439966['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)[_0xf88e18(0xb0)](_0x3fc363)['digest']('hex');return NextResponse['json']({'orderReference':_0x40e4b4,'status':_0x33d1c0,'time':_0x199a30,'signature':_0x3d2ba3},{'status':0x1f4});}}