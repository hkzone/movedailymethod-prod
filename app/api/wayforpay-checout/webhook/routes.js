const a3_0x108477=a3_0x4ea7;function a3_0x4ea7(_0x2f5efc,_0x2aec54){const _0x3a7724=a3_0x3a77();return a3_0x4ea7=function(_0x4ea796,_0x282c6a){_0x4ea796=_0x4ea796-0xe2;let _0x6184e9=_0x3a7724[_0x4ea796];if(a3_0x4ea7['mBeNRf']===undefined){var _0x4995f6=function(_0x568f22){const _0x7f30ea='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x4c84b9='',_0x39894c='';for(let _0x581600=0x0,_0x22b30d,_0xfba2f5,_0x5cc59c=0x0;_0xfba2f5=_0x568f22['charAt'](_0x5cc59c++);~_0xfba2f5&&(_0x22b30d=_0x581600%0x4?_0x22b30d*0x40+_0xfba2f5:_0xfba2f5,_0x581600++%0x4)?_0x4c84b9+=String['fromCharCode'](0xff&_0x22b30d>>(-0x2*_0x581600&0x6)):0x0){_0xfba2f5=_0x7f30ea['indexOf'](_0xfba2f5);}for(let _0x287950=0x0,_0x3fc3e5=_0x4c84b9['length'];_0x287950<_0x3fc3e5;_0x287950++){_0x39894c+='%'+('00'+_0x4c84b9['charCodeAt'](_0x287950)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x39894c);};a3_0x4ea7['aqIJdv']=_0x4995f6,_0x2f5efc=arguments,a3_0x4ea7['mBeNRf']=!![];}const _0x166562=_0x3a7724[0x0],_0x54b7c5=_0x4ea796+_0x166562,_0x3d2f19=_0x2f5efc[_0x54b7c5];return!_0x3d2f19?(_0x6184e9=a3_0x4ea7['aqIJdv'](_0x6184e9),_0x2f5efc[_0x54b7c5]=_0x6184e9):_0x6184e9=_0x3d2f19,_0x6184e9;},a3_0x4ea7(_0x2f5efc,_0x2aec54);}(function(_0x586f00,_0xdc7095){const _0xb8ed6=a3_0x4ea7,_0x4817c1=_0x586f00();while(!![]){try{const _0x3de8a2=parseInt(_0xb8ed6(0xfb))/0x1+-parseInt(_0xb8ed6(0xf7))/0x2*(-parseInt(_0xb8ed6(0x103))/0x3)+parseInt(_0xb8ed6(0xfa))/0x4+parseInt(_0xb8ed6(0xef))/0x5+parseInt(_0xb8ed6(0xee))/0x6*(-parseInt(_0xb8ed6(0xf4))/0x7)+parseInt(_0xb8ed6(0xfc))/0x8*(parseInt(_0xb8ed6(0xed))/0x9)+-parseInt(_0xb8ed6(0xf1))/0xa;if(_0x3de8a2===_0xdc7095)break;else _0x4817c1['push'](_0x4817c1['shift']());}catch(_0x21f1ac){_0x4817c1['push'](_0x4817c1['shift']());}}}(a3_0x3a77,0x9665d));import{NextResponse}from'next/server';import a3_0x568f22 from'crypto';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';const WAYFORPAY_MERCHANT_SECRET_KEY=process[a3_0x108477(0xfe)][a3_0x108477(0xea)];function a3_0x3a77(){const _0x3dccef=['ntiWmJm5mgzuy3PjvW','Bwq1','mtC0mZiWodbtuK9bCMq','rxjYB3iGAw4Gv2f5rM9Yugf5ihDLyMHVB2SGAgfUzgXLCJO','v2f5rM9Yugf5ihDLyMHVB2SGCMvJzwL2zwq6','n3LrtMrtwa','v2vIAg9VAYbfCNjVCJOGtwLZC2LUzYbMAwvSzhm','v2f5rM9Yugf5ifDLyMHVB2S6ifn0DwrLBNqGBM90igzVDw5KigzVCIbJBgvYA0LKia','odC3mtbhtwHZCee','zxjYB3i','ywnJzxb0','mJCXmdC0nfvdvgnOvW','mJqZnta3v0rABgHp','mZC5otjbC1rqDe8','ANnVBG','zw52','y3jLyxrLsg1HyW','igLUig9YzgvYia','v2vIAg9VAYbfCNjVCJOGsw52ywXPzcbZAwDUyxr1CMu','BM93','mtjKteHwyKG','Bg9N','DxbKyxrL','zMXVB3i','v2f5rM9Yugf5ifDLyMHVB2S6ie1PC3nPBMCGy3jPDgLJywWGzMLLBgrZigzYB20GCgf5Bg9HzdO','Agv4','v2f5rM9Yugf5ifDLyMHVB2S6ifjLy2vPDMvKihn0yxr1CYaN','BgvUz3rO','x2LK','qxbWCM92zwq','zgLNzxn0','v0fzrK9suefzx01fuKniqu5ux1nfq1jfvf9lrvK','B3jKzxjszwzLCMvUy2u','zgf0yq','nJaZvffHtw9M','ntC2mJiYCK50yu9c'];a3_0x3a77=function(){return _0x3dccef;};return a3_0x3a77();}export async function POST(_0x7f30ea){const _0x57907d=a3_0x108477;let _0x4c84b9;try{_0x4c84b9=await _0x7f30ea['json'](),console['log'](_0x57907d(0xf3),JSON['stringify'](_0x4c84b9,null,0x2));const {orderReference:_0x39894c,transactionStatus:_0x581600,processingDate:_0x22b30d,merchantSignature:_0xfba2f5,amount:_0x5cc59c}=_0x4c84b9;if(!_0x39894c||!_0x581600||_0x22b30d===undefined||!_0xfba2f5)return console['error'](_0x57907d(0xe3),{'orderReference':_0x39894c,'transactionStatus':_0x581600,'processingDate':_0x22b30d,'receivedSignature':_0xfba2f5}),new NextResponse(_0x57907d(0xf5),{'status':0x190});const _0x287950=_0x39894c+';'+_0x581600+';'+_0x22b30d,_0x3fc3e5=a3_0x568f22['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x287950)[_0x57907d(0xe9)](_0x57907d(0xe4));if(_0x3fc3e5!==_0xfba2f5)return console['error']('WayForPay\x20Webhook:\x20Invalid\x20signature.',{'calculatedSignature':_0x3fc3e5,'receivedSignature':_0xfba2f5,'stringToSign':_0x287950}),new NextResponse(_0x57907d(0x101),{'status':0x190});if(_0x581600===_0x57907d(0xe8)){const _0x1a58c5=_0x39894c['split']('_');if(_0x1a58c5[_0x57907d(0xe6)]<0x3)console['error']('WayForPay\x20Webhook:\x20Invalid\x20orderReference\x20format',_0x39894c);else{const _0x1081eb=_0x1a58c5[0x0],_0x57bf07=_0x1a58c5[0x1],_0x2b6a38=await getStudentByClerkId(_0x57bf07);if(!_0x2b6a38?.[_0x57907d(0xec)]?.[_0x57907d(0xe7)])console['error'](_0x57907d(0xf6)+_0x57bf07+_0x57907d(0x100)+_0x39894c);else{const _0x1f5290=_0x2b6a38[_0x57907d(0xec)][_0x57907d(0xe7)];await createEnrollment({'studentId':_0x1f5290,'courseId':_0x1081eb,'paymentId':_0x39894c,'amount':_0x5cc59c,'paymentProvider':'wayforpay'}),console[_0x57907d(0x104)]('WayForPay\x20Webhook:\x20Enrollment\x20successfully\x20created\x20for\x20order\x20'+_0x39894c);}}}else console['log'](_0x57907d(0xe5)+_0x581600+'\x27\x20for\x20order\x20'+_0x39894c+'.\x20No\x20enrollment\x20action\x20taken.');const _0x13fc8c=Math[_0x57907d(0xe2)](Date[_0x57907d(0x102)]()/0x3e8),_0x1cc701=_0x39894c+';accept;'+_0x13fc8c,_0xa5bfc2=a3_0x568f22['createHmac'](_0x57907d(0xf0),WAYFORPAY_MERCHANT_SECRET_KEY)[_0x57907d(0x105)](_0x1cc701)[_0x57907d(0xe9)](_0x57907d(0xe4)),_0x338322={'orderReference':_0x39894c,'status':_0x57907d(0xf9),'time':_0x13fc8c,'signature':_0xa5bfc2};return NextResponse['json'](_0x338322,{'status':0xc8});}catch(_0xdca733){console[_0x57907d(0xf8)](_0x57907d(0xf2),_0xdca733);const _0x597808=_0x4c84b9?.[_0x57907d(0xeb)]||'unknown_order_ref_error',_0x1f26c8=Math['floor'](Date[_0x57907d(0x102)]()/0x3e8),_0x531760=_0x57907d(0xf8),_0x2090f9=_0x597808+';'+_0x531760+';'+_0x1f26c8,_0x2f944a=a3_0x568f22[_0x57907d(0xff)]('md5',WAYFORPAY_MERCHANT_SECRET_KEY)[_0x57907d(0x105)](_0x2090f9)[_0x57907d(0xe9)]('hex');return NextResponse[_0x57907d(0xfd)]({'orderReference':_0x597808,'status':_0x531760,'time':_0x1f26c8,'signature':_0x2f944a},{'status':0x1f4});}}