(function(_0x4b9f46,_0x2cd720){const _0x5f0b46=a3_0x5167,_0x176eef=_0x4b9f46();while(!![]){try{const _0x525902=parseInt(_0x5f0b46(0x67))/0x1+-parseInt(_0x5f0b46(0x71))/0x2*(-parseInt(_0x5f0b46(0x73))/0x3)+-parseInt(_0x5f0b46(0x66))/0x4+-parseInt(_0x5f0b46(0x70))/0x5*(-parseInt(_0x5f0b46(0x6f))/0x6)+parseInt(_0x5f0b46(0x6b))/0x7+parseInt(_0x5f0b46(0x6d))/0x8*(-parseInt(_0x5f0b46(0x72))/0x9)+-parseInt(_0x5f0b46(0x6a))/0xa*(-parseInt(_0x5f0b46(0x6c))/0xb);if(_0x525902===_0x2cd720)break;else _0x176eef['push'](_0x176eef['shift']());}catch(_0xea2382){_0x176eef['push'](_0x176eef['shift']());}}}(a3_0x13a5,0x2816b));function a3_0x13a5(){const _0x1ca212=['mJa3mtG4mwr2v2TiwG','mte5mdrxuvzLuvK','mteYndy4nfHczwXhwq','mtCZmdu0v0ryEfvQ','qxbWCM92zwq','BM93','mtbWz3PbBLe','oty3otuZCuDiBwvq','mZeWnte5sK5MweHo','oe9dChfjuq','zxjYB3i','ndKYnde0CvrlCxrU','nxrSC0fYrG','mti4vfPRC1nw'];a3_0x13a5=function(){return _0x1ca212;};return a3_0x13a5();}import{NextResponse}from'next/server';import a3_0x1cf529 from'crypto';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';const WAYFORPAY_MERCHANT_SECRET_KEY=process['env']['WAYFORPAY_MERCHANT_SECRET_KEY'];function a3_0x5167(_0x119818,_0x1dcf44){const _0x13a586=a3_0x13a5();return a3_0x5167=function(_0x5167fe,_0x49ee27){_0x5167fe=_0x5167fe-0x66;let _0x4a1bb8=_0x13a586[_0x5167fe];if(a3_0x5167['ylxdjV']===undefined){var _0x3381ab=function(_0x1cf529){const _0x3d18b1='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x300d74='',_0x47a250='';for(let _0x188cb9=0x0,_0x221602,_0x243d61,_0x3da23c=0x0;_0x243d61=_0x1cf529['charAt'](_0x3da23c++);~_0x243d61&&(_0x221602=_0x188cb9%0x4?_0x221602*0x40+_0x243d61:_0x243d61,_0x188cb9++%0x4)?_0x300d74+=String['fromCharCode'](0xff&_0x221602>>(-0x2*_0x188cb9&0x6)):0x0){_0x243d61=_0x3d18b1['indexOf'](_0x243d61);}for(let _0x7c619a=0x0,_0x5d0ffa=_0x300d74['length'];_0x7c619a<_0x5d0ffa;_0x7c619a++){_0x47a250+='%'+('00'+_0x300d74['charCodeAt'](_0x7c619a)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x47a250);};a3_0x5167['xTnBph']=_0x3381ab,_0x119818=arguments,a3_0x5167['ylxdjV']=!![];}const _0x2e0d56=_0x13a586[0x0],_0x340fcb=_0x5167fe+_0x2e0d56,_0x5de962=_0x119818[_0x340fcb];return!_0x5de962?(_0x4a1bb8=a3_0x5167['xTnBph'](_0x4a1bb8),_0x119818[_0x340fcb]=_0x4a1bb8):_0x4a1bb8=_0x5de962,_0x4a1bb8;},a3_0x5167(_0x119818,_0x1dcf44);}export async function POST(_0x3d18b1){const _0x3179b9=a3_0x5167;let _0x300d74;try{_0x300d74=await _0x3d18b1['json'](),console['log']('WayForPay\x20webhook\x20received:',JSON['stringify'](_0x300d74,null,0x2));const {orderReference:_0x47a250,transactionStatus:_0x188cb9,processingDate:_0x221602,merchantSignature:_0x243d61,amount:_0x3da23c}=_0x300d74;if(!_0x47a250||!_0x188cb9||_0x221602===undefined||!_0x243d61)return console['error']('WayForPay\x20Webhook:\x20Missing\x20critical\x20fields\x20from\x20payload:',{'orderReference':_0x47a250,'transactionStatus':_0x188cb9,'processingDate':_0x221602,'receivedSignature':_0x243d61}),new NextResponse('Webhook\x20Error:\x20Missing\x20fields',{'status':0x190});const _0x7c619a=_0x47a250+';'+_0x188cb9+';'+_0x221602,_0x5d0ffa=a3_0x1cf529['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x7c619a)['digest']('hex');if(_0x5d0ffa!==_0x243d61)return console[_0x3179b9(0x6e)]('WayForPay\x20Webhook:\x20Invalid\x20signature.',{'calculatedSignature':_0x5d0ffa,'receivedSignature':_0x243d61,'stringToSign':_0x7c619a}),new NextResponse('Webhook\x20Error:\x20Invalid\x20signature',{'status':0x190});if(_0x188cb9===_0x3179b9(0x68)){const _0x5c25f9=_0x47a250['split']('_');if(_0x5c25f9['length']<0x3)console['error']('WayForPay\x20Webhook:\x20Invalid\x20orderReference\x20format',_0x47a250);else{const _0x2f56a9=_0x5c25f9[0x0],_0x1ae30e=_0x5c25f9[0x1],_0x1a6205=await getStudentByClerkId(_0x1ae30e);if(!_0x1a6205?.['data']?.['_id'])console['error']('WayForPay\x20Webhook:\x20Student\x20not\x20found\x20for\x20clerkId\x20'+_0x1ae30e+'\x20in\x20order\x20'+_0x47a250);else{const _0x2c5205=_0x1a6205['data']['_id'];await createEnrollment({'studentId':_0x2c5205,'courseId':_0x2f56a9,'paymentId':_0x47a250,'amount':_0x3da23c,'paymentProvider':'wayforpay'}),console['log']('WayForPay\x20Webhook:\x20Enrollment\x20successfully\x20created\x20for\x20order\x20'+_0x47a250);}}}else console['log']('WayForPay\x20Webhook:\x20Received\x20status\x20\x27'+_0x188cb9+'\x27\x20for\x20order\x20'+_0x47a250+'.\x20No\x20enrollment\x20action\x20taken.');const _0x5ee7a4=Math['floor'](Date[_0x3179b9(0x69)]()/0x3e8),_0x423850=_0x47a250+';accept;'+_0x5ee7a4,_0x357b3d=a3_0x1cf529['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x423850)['digest']('hex'),_0x58a718={'orderReference':_0x47a250,'status':'accept','time':_0x5ee7a4,'signature':_0x357b3d};return NextResponse['json'](_0x58a718,{'status':0xc8});}catch(_0x48896f){console['error']('Error\x20in\x20WayForPay\x20webhook\x20handler:',_0x48896f);const _0x3660ca=_0x300d74?.['orderReference']||'unknown_order_ref_error',_0x283248=Math['floor'](Date['now']()/0x3e8),_0x38ca7c='error',_0x1794f5=_0x3660ca+';'+_0x38ca7c+';'+_0x283248,_0x321a0a=a3_0x1cf529['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x1794f5)['digest']('hex');return NextResponse['json']({'orderReference':_0x3660ca,'status':_0x38ca7c,'time':_0x283248,'signature':_0x321a0a},{'status':0x1f4});}}