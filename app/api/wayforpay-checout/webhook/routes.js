function a3_0x3544(){const _0x2aeb74=['floor','65040gUZDno','60VxftoV','1356028KupuvN','hex','log','2998650kfNpOu','error','92897XwpckU','10418310BIfpWL','277852cFUvVC','4TtgSJc','length','264EHwwKI','428865deHFak','\x27\x20for\x20order\x20'];a3_0x3544=function(){return _0x2aeb74;};return a3_0x3544();}(function(_0x3564db,_0x12977b){const _0x3daf77=a3_0x56f9,_0x5b58c8=_0x3564db();while(!![]){try{const _0xd0a5d1=-parseInt(_0x3daf77(0x141))/0x1*(-parseInt(_0x3daf77(0x142))/0x2)+-parseInt(_0x3daf77(0x13d))/0x3+parseInt(_0x3daf77(0x14a))/0x4+-parseInt(_0x3daf77(0x145))/0x5*(parseInt(_0x3daf77(0x149))/0x6)+-parseInt(_0x3daf77(0x13f))/0x7*(-parseInt(_0x3daf77(0x144))/0x8)+parseInt(_0x3daf77(0x140))/0x9+-parseInt(_0x3daf77(0x148))/0xa;if(_0xd0a5d1===_0x12977b)break;else _0x5b58c8['push'](_0x5b58c8['shift']());}catch(_0x286786){_0x5b58c8['push'](_0x5b58c8['shift']());}}}(a3_0x3544,0x98f1c));import{NextResponse}from'next/server';import a3_0x25368b from'crypto';function a3_0x56f9(_0x32fd0b,_0x2c1b08){const _0x3544d4=a3_0x3544();return a3_0x56f9=function(_0x56f9bb,_0x268e3f){_0x56f9bb=_0x56f9bb-0x13b;let _0x1ec175=_0x3544d4[_0x56f9bb];return _0x1ec175;},a3_0x56f9(_0x32fd0b,_0x2c1b08);}import{createEnrollment}from'@/sanity/lib/student/createEnrollment';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';const WAYFORPAY_MERCHANT_SECRET_KEY=process['env']['WAYFORPAY_MERCHANT_SECRET_KEY'];export async function POST(_0x1604b8){const _0x3e29a1=a3_0x56f9;let _0x3801bb;try{_0x3801bb=await _0x1604b8['json'](),console['log']('WayForPay\x20webhook\x20received:',JSON['stringify'](_0x3801bb,null,0x2));const {orderReference:_0x33732e,transactionStatus:_0x7865e9,processingDate:_0x2b5e25,merchantSignature:_0x5d7fd1,amount:_0x1e7209}=_0x3801bb;if(!_0x33732e||!_0x7865e9||_0x2b5e25===undefined||!_0x5d7fd1)return console['error']('WayForPay\x20Webhook:\x20Missing\x20critical\x20fields\x20from\x20payload:',{'orderReference':_0x33732e,'transactionStatus':_0x7865e9,'processingDate':_0x2b5e25,'receivedSignature':_0x5d7fd1}),new NextResponse('Webhook\x20Error:\x20Missing\x20fields',{'status':0x190});const _0x5741a4=_0x33732e+';'+_0x7865e9+';'+_0x2b5e25,_0x183c29=a3_0x25368b['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x5741a4)['digest']('hex');if(_0x183c29!==_0x5d7fd1)return console['error']('WayForPay\x20Webhook:\x20Invalid\x20signature.',{'calculatedSignature':_0x183c29,'receivedSignature':_0x5d7fd1,'stringToSign':_0x5741a4}),new NextResponse('Webhook\x20Error:\x20Invalid\x20signature',{'status':0x190});if(_0x7865e9==='Approved'){const _0x11a431=_0x33732e['split']('_');if(_0x11a431[_0x3e29a1(0x143)]<0x3)console[_0x3e29a1(0x13e)]('WayForPay\x20Webhook:\x20Invalid\x20orderReference\x20format',_0x33732e);else{const _0xab009a=_0x11a431[0x0],_0x52dfee=_0x11a431[0x1],_0x243c4b=await getStudentByClerkId(_0x52dfee);if(!_0x243c4b?.['data']?.['_id'])console[_0x3e29a1(0x13e)]('WayForPay\x20Webhook:\x20Student\x20not\x20found\x20for\x20clerkId\x20'+_0x52dfee+'\x20in\x20order\x20'+_0x33732e);else{const _0x3c561b=_0x243c4b['data']['_id'];await createEnrollment({'studentId':_0x3c561b,'courseId':_0xab009a,'paymentId':_0x33732e,'amount':_0x1e7209,'paymentProvider':'wayforpay'}),console[_0x3e29a1(0x13c)]('WayForPay\x20Webhook:\x20Enrollment\x20successfully\x20created\x20for\x20order\x20'+_0x33732e);}}}else console['log']('WayForPay\x20Webhook:\x20Received\x20status\x20\x27'+_0x7865e9+_0x3e29a1(0x146)+_0x33732e+'.\x20No\x20enrollment\x20action\x20taken.');const _0x2755fb=Math[_0x3e29a1(0x147)](Date['now']()/0x3e8),_0x10f357=_0x33732e+';accept;'+_0x2755fb,_0x1cddc1=a3_0x25368b['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x10f357)['digest'](_0x3e29a1(0x13b)),_0x367c74={'orderReference':_0x33732e,'status':'accept','time':_0x2755fb,'signature':_0x1cddc1};return NextResponse['json'](_0x367c74,{'status':0xc8});}catch(_0x337142){console['error']('Error\x20in\x20WayForPay\x20webhook\x20handler:',_0x337142);const _0x1484bf=_0x3801bb?.['orderReference']||'unknown_order_ref_error',_0x40be2a=Math['floor'](Date['now']()/0x3e8),_0x374338='error',_0x27d4ab=_0x1484bf+';'+_0x374338+';'+_0x40be2a,_0x71db84=a3_0x25368b['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x27d4ab)['digest']('hex');return NextResponse['json']({'orderReference':_0x1484bf,'status':_0x374338,'time':_0x40be2a,'signature':_0x71db84},{'status':0x1f4});}}