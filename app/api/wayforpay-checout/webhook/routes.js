(function(_0x4665d2,_0x547d6e){const _0x1e93e3=a3_0x41cf,_0x1b7364=_0x4665d2();while(!![]){try{const _0x1f97f3=parseInt(_0x1e93e3(0x191))/0x1+parseInt(_0x1e93e3(0x18f))/0x2+-parseInt(_0x1e93e3(0x185))/0x3+-parseInt(_0x1e93e3(0x18a))/0x4+-parseInt(_0x1e93e3(0x190))/0x5+-parseInt(_0x1e93e3(0x189))/0x6*(parseInt(_0x1e93e3(0x188))/0x7)+parseInt(_0x1e93e3(0x18c))/0x8;if(_0x1f97f3===_0x547d6e)break;else _0x1b7364['push'](_0x1b7364['shift']());}catch(_0x1934de){_0x1b7364['push'](_0x1b7364['shift']());}}}(a3_0x3ca1,0x9a8f4));import{NextResponse}from'next/server';function a3_0x41cf(_0x5aab61,_0x20fbd8){const _0x3ca1d7=a3_0x3ca1();return a3_0x41cf=function(_0x41cf82,_0x40a2c6){_0x41cf82=_0x41cf82-0x185;let _0x568d65=_0x3ca1d7[_0x41cf82];return _0x568d65;},a3_0x41cf(_0x5aab61,_0x20fbd8);}import a3_0x23fdbf from'crypto';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';function a3_0x3ca1(){const _0x68d02=['896586czCZnq','423996GPeRfI','length','15618832NWNGeK','digest','WayForPay\x20Webhook:\x20Invalid\x20signature.','1055098mPSoSa','1721285DYbHsM','283710vONvOj','3695964LmSvyD','split','hex','21JvKXsU'];a3_0x3ca1=function(){return _0x68d02;};return a3_0x3ca1();}const WAYFORPAY_MERCHANT_SECRET_KEY=process['env']['WAYFORPAY_MERCHANT_SECRET_KEY'];export async function POST(_0x5f3917){const _0x98c6b6=a3_0x41cf;let _0x1681c3;try{_0x1681c3=await _0x5f3917['json'](),console['log']('WayForPay\x20webhook\x20received:',JSON['stringify'](_0x1681c3,null,0x2));const {orderReference:_0x29d246,transactionStatus:_0x30070f,processingDate:_0x483fb0,merchantSignature:_0x163d58,amount:_0x5cce36}=_0x1681c3;if(!_0x29d246||!_0x30070f||_0x483fb0===undefined||!_0x163d58)return console['error']('WayForPay\x20Webhook:\x20Missing\x20critical\x20fields\x20from\x20payload:',{'orderReference':_0x29d246,'transactionStatus':_0x30070f,'processingDate':_0x483fb0,'receivedSignature':_0x163d58}),new NextResponse('Webhook\x20Error:\x20Missing\x20fields',{'status':0x190});const _0xe42604=_0x29d246+';'+_0x30070f+';'+_0x483fb0,_0x2ea6e3=a3_0x23fdbf['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0xe42604)['digest']('hex');if(_0x2ea6e3!==_0x163d58)return console['error'](_0x98c6b6(0x18e),{'calculatedSignature':_0x2ea6e3,'receivedSignature':_0x163d58,'stringToSign':_0xe42604}),new NextResponse('Webhook\x20Error:\x20Invalid\x20signature',{'status':0x190});if(_0x30070f==='Approved'){const _0x29fcb6=_0x29d246[_0x98c6b6(0x186)]('_');if(_0x29fcb6[_0x98c6b6(0x18b)]<0x3)console['error']('WayForPay\x20Webhook:\x20Invalid\x20orderReference\x20format',_0x29d246);else{const _0x2a436c=_0x29fcb6[0x0],_0x1c9b08=_0x29fcb6[0x1],_0x20ccd8=await getStudentByClerkId(_0x1c9b08);if(!_0x20ccd8?.['data']?.['_id'])console['error']('WayForPay\x20Webhook:\x20Student\x20not\x20found\x20for\x20clerkId\x20'+_0x1c9b08+'\x20in\x20order\x20'+_0x29d246);else{const _0x3e7dbe=_0x20ccd8['data']['_id'];await createEnrollment({'studentId':_0x3e7dbe,'courseId':_0x2a436c,'paymentId':_0x29d246,'amount':_0x5cce36,'paymentProvider':'wayforpay'}),console['log']('WayForPay\x20Webhook:\x20Enrollment\x20successfully\x20created\x20for\x20order\x20'+_0x29d246);}}}else console['log']('WayForPay\x20Webhook:\x20Received\x20status\x20\x27'+_0x30070f+'\x27\x20for\x20order\x20'+_0x29d246+'.\x20No\x20enrollment\x20action\x20taken.');const _0x24d92a=Math['floor'](Date['now']()/0x3e8),_0x290eea=_0x29d246+';accept;'+_0x24d92a,_0x1d0228=a3_0x23fdbf['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x290eea)['digest'](_0x98c6b6(0x187)),_0x2f6818={'orderReference':_0x29d246,'status':'accept','time':_0x24d92a,'signature':_0x1d0228};return NextResponse['json'](_0x2f6818,{'status':0xc8});}catch(_0x2beefb){console['error']('Error\x20in\x20WayForPay\x20webhook\x20handler:',_0x2beefb);const _0x56a09e=_0x1681c3?.['orderReference']||'unknown_order_ref_error',_0xd09283=Math['floor'](Date['now']()/0x3e8),_0x35f253='error',_0x13df23=_0x56a09e+';'+_0x35f253+';'+_0xd09283,_0x168905=a3_0x23fdbf['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x13df23)[_0x98c6b6(0x18d)]('hex');return NextResponse['json']({'orderReference':_0x56a09e,'status':_0x35f253,'time':_0xd09283,'signature':_0x168905},{'status':0x1f4});}}