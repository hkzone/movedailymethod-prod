const a3_0x205ece=a3_0x2e48;(function(_0x1cd5f9,_0x364363){const _0x2b58da=a3_0x2e48,_0x4d6e26=_0x1cd5f9();while(!![]){try{const _0x564e4b=-parseInt(_0x2b58da(0x139))/0x1*(-parseInt(_0x2b58da(0x13c))/0x2)+parseInt(_0x2b58da(0x13a))/0x3+parseInt(_0x2b58da(0x12d))/0x4+parseInt(_0x2b58da(0x133))/0x5*(-parseInt(_0x2b58da(0x13b))/0x6)+-parseInt(_0x2b58da(0x143))/0x7+parseInt(_0x2b58da(0x137))/0x8*(-parseInt(_0x2b58da(0x135))/0x9)+parseInt(_0x2b58da(0x127))/0xa*(-parseInt(_0x2b58da(0x147))/0xb);if(_0x564e4b===_0x364363)break;else _0x4d6e26['push'](_0x4d6e26['shift']());}catch(_0x4441e1){_0x4d6e26['push'](_0x4d6e26['shift']());}}}(a3_0xb807,0x74be6));import{NextResponse}from'next/server';import a3_0x3656d5 from'crypto';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';function a3_0x2e48(_0x1884e6,_0x4edc50){const _0xb807dd=a3_0xb807();return a3_0x2e48=function(_0x2e4884,_0xed9940){_0x2e4884=_0x2e4884-0x125;let _0x2601ef=_0xb807dd[_0x2e4884];if(a3_0x2e48['oZyZVC']===undefined){var _0x215d4c=function(_0x3656d5){const _0xa3d1f7='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x253566='',_0x520a45='';for(let _0x306a28=0x0,_0x4ba229,_0x1f56cc,_0x58f2ec=0x0;_0x1f56cc=_0x3656d5['charAt'](_0x58f2ec++);~_0x1f56cc&&(_0x4ba229=_0x306a28%0x4?_0x4ba229*0x40+_0x1f56cc:_0x1f56cc,_0x306a28++%0x4)?_0x253566+=String['fromCharCode'](0xff&_0x4ba229>>(-0x2*_0x306a28&0x6)):0x0){_0x1f56cc=_0xa3d1f7['indexOf'](_0x1f56cc);}for(let _0x4cd300=0x0,_0x542092=_0x253566['length'];_0x4cd300<_0x542092;_0x4cd300++){_0x520a45+='%'+('00'+_0x253566['charCodeAt'](_0x4cd300)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x520a45);};a3_0x2e48['ZOfZEK']=_0x215d4c,_0x1884e6=arguments,a3_0x2e48['oZyZVC']=!![];}const _0x46fd86=_0xb807dd[0x0],_0x3757d3=_0x2e4884+_0x46fd86,_0x39180f=_0x1884e6[_0x3757d3];return!_0x39180f?(_0x2601ef=a3_0x2e48['ZOfZEK'](_0x2601ef),_0x1884e6[_0x3757d3]=_0x2601ef):_0x2601ef=_0x39180f,_0x2601ef;},a3_0x2e48(_0x1884e6,_0x4edc50);}const WAYFORPAY_MERCHANT_SECRET_KEY=process[a3_0x205ece(0x128)]['WAYFORPAY_MERCHANT_SECRET_KEY'];function a3_0xb807(){const _0x19afab=['zgLNzxn0','v2f5rM9Yugf5ihDLyMHVB2SGCMvJzwL2zwq6','mtmZmty4B2DoBhHK','v2f5rM9Yugf5ifDLyMHVB2S6ifjLy2vPDMvKihn0yxr1CYaN','D2f5zM9YCgf5','BM93','ndiZmtDLzu9NsMS','Agv4','Bg9N','mZGWrhLcyvzZ','zw52','DxbKyxrL','o2fJy2vWDdS','ANnVBG','igLUig9YzgvYia','mJe4mJu5mNDXBK9Wuq','jYbMB3iGB3jKzxiG','v2f5rM9Yugf5ifDLyMHVB2S6ievUCM9SBg1LBNqGC3vJy2vZC2z1BgX5ignYzwf0zwqGzM9Yig9YzgvYia','Bwq1','qxbWCM92zwq','C3bSAxq','nZvpt1rRwgC','C3rYAw5NAwz5','mtHdtLbAEu0','rxjYB3iGAw4Gv2f5rM9Yugf5ihDLyMHVB2SGAgfUzgXLCJO','mZmXmJuYoePKwK5kAG','B3jKzxjszwzLCMvUy2u','odvXzeH5A0W','mJC4ntq4ohzQBwjLrq','mtqZnta4tKz6zuvP','odm4mfbJrgPnwG','zxjYB3i','v2vIAg9VAYbfCNjVCJOGtwLZC2LUzYbMAwvSzhm','x2LK','y3jLyxrLsg1HyW'];a3_0xb807=function(){return _0x19afab;};return a3_0xb807();}export async function POST(_0xa3d1f7){const _0x365647=a3_0x205ece;let _0x253566;try{_0x253566=await _0xa3d1f7[_0x365647(0x12b)](),console[_0x365647(0x126)](_0x365647(0x142),JSON[_0x365647(0x134)](_0x253566,null,0x2));const {orderReference:_0x520a45,transactionStatus:_0x306a28,processingDate:_0x4ba229,merchantSignature:_0x1f56cc,amount:_0x58f2ec}=_0x253566;if(!_0x520a45||!_0x306a28||_0x4ba229===undefined||!_0x1f56cc)return console[_0x365647(0x13d)]('WayForPay\x20Webhook:\x20Missing\x20critical\x20fields\x20from\x20payload:',{'orderReference':_0x520a45,'transactionStatus':_0x306a28,'processingDate':_0x4ba229,'receivedSignature':_0x1f56cc}),new NextResponse(_0x365647(0x13e),{'status':0x190});const _0x4cd300=_0x520a45+';'+_0x306a28+';'+_0x4ba229,_0x542092=a3_0x3656d5[_0x365647(0x140)](_0x365647(0x130),WAYFORPAY_MERCHANT_SECRET_KEY)[_0x365647(0x129)](_0x4cd300)[_0x365647(0x141)](_0x365647(0x125));if(_0x542092!==_0x1f56cc)return console['error']('WayForPay\x20Webhook:\x20Invalid\x20signature.',{'calculatedSignature':_0x542092,'receivedSignature':_0x1f56cc,'stringToSign':_0x4cd300}),new NextResponse('Webhook\x20Error:\x20Invalid\x20signature',{'status':0x190});if(_0x306a28===_0x365647(0x131)){const _0x9cbbd3=_0x520a45[_0x365647(0x132)]('_');if(_0x9cbbd3['length']<0x3)console['error']('WayForPay\x20Webhook:\x20Invalid\x20orderReference\x20format',_0x520a45);else{const _0x321956=_0x9cbbd3[0x0],_0x2ef54f=_0x9cbbd3[0x1],_0x4c5b15=await getStudentByClerkId(_0x2ef54f);if(!_0x4c5b15?.['data']?.[_0x365647(0x13f)])console[_0x365647(0x13d)]('WayForPay\x20Webhook:\x20Student\x20not\x20found\x20for\x20clerkId\x20'+_0x2ef54f+_0x365647(0x12c)+_0x520a45);else{const _0x197074=_0x4c5b15['data']['_id'];await createEnrollment({'studentId':_0x197074,'courseId':_0x321956,'paymentId':_0x520a45,'amount':_0x58f2ec,'paymentProvider':_0x365647(0x145)}),console[_0x365647(0x126)](_0x365647(0x12f)+_0x520a45);}}}else console['log'](_0x365647(0x144)+_0x306a28+_0x365647(0x12e)+_0x520a45+'.\x20No\x20enrollment\x20action\x20taken.');const _0x4a2676=Math['floor'](Date[_0x365647(0x146)]()/0x3e8),_0x40a970=_0x520a45+_0x365647(0x12a)+_0x4a2676,_0x41b8be=a3_0x3656d5['createHmac'](_0x365647(0x130),WAYFORPAY_MERCHANT_SECRET_KEY)[_0x365647(0x129)](_0x40a970)['digest']('hex'),_0x42a6d6={'orderReference':_0x520a45,'status':'accept','time':_0x4a2676,'signature':_0x41b8be};return NextResponse['json'](_0x42a6d6,{'status':0xc8});}catch(_0x5929d8){console['error'](_0x365647(0x136),_0x5929d8);const _0x4915c5=_0x253566?.[_0x365647(0x138)]||'unknown_order_ref_error',_0x58971f=Math['floor'](Date['now']()/0x3e8),_0x3c32be='error',_0x20ade7=_0x4915c5+';'+_0x3c32be+';'+_0x58971f,_0x4f9a0b=a3_0x3656d5[_0x365647(0x140)]('md5',WAYFORPAY_MERCHANT_SECRET_KEY)[_0x365647(0x129)](_0x20ade7)['digest']('hex');return NextResponse[_0x365647(0x12b)]({'orderReference':_0x4915c5,'status':_0x3c32be,'time':_0x58971f,'signature':_0x4f9a0b},{'status':0x1f4});}}