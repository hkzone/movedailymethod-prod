(function(_0x457cf7,_0x4247be){const _0x3dfccb=a3_0x1b3c,_0x23d75c=_0x457cf7();while(!![]){try{const _0x3ed850=-parseInt(_0x3dfccb(0x15e))/0x1+-parseInt(_0x3dfccb(0x15f))/0x2+-parseInt(_0x3dfccb(0x15a))/0x3+-parseInt(_0x3dfccb(0x15c))/0x4*(parseInt(_0x3dfccb(0x153))/0x5)+parseInt(_0x3dfccb(0x15d))/0x6+-parseInt(_0x3dfccb(0x159))/0x7*(-parseInt(_0x3dfccb(0x154))/0x8)+parseInt(_0x3dfccb(0x156))/0x9*(parseInt(_0x3dfccb(0x155))/0xa);if(_0x3ed850===_0x4247be)break;else _0x23d75c['push'](_0x23d75c['shift']());}catch(_0x545f1a){_0x23d75c['push'](_0x23d75c['shift']());}}}(a3_0x4135,0x2595c));import{NextResponse}from'next/server';function a3_0x1b3c(_0x488a1b,_0x304859){const _0x4135a9=a3_0x4135();return a3_0x1b3c=function(_0x1b3c48,_0x53227c){_0x1b3c48=_0x1b3c48-0x153;let _0x1c75e8=_0x4135a9[_0x1b3c48];return _0x1c75e8;},a3_0x1b3c(_0x488a1b,_0x304859);}function a3_0x4135(){const _0x22676a=['2409690CTZSTs','18XOvnhX','hex','now','35EGcPFN','243234NoRRtS','md5','188qphniz','1378410JPyWfy','155461qiqBdI','604620olBjfJ','9915BIJAsH','118920rPMGUw'];a3_0x4135=function(){return _0x22676a;};return a3_0x4135();}import a3_0x96e716 from'crypto';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';const WAYFORPAY_MERCHANT_SECRET_KEY=process['env']['WAYFORPAY_MERCHANT_SECRET_KEY'];export async function POST(_0x628768){const _0xac484=a3_0x1b3c;let _0x2a6ab3;try{_0x2a6ab3=await _0x628768['json'](),console['log']('WayForPay\x20webhook\x20received:',JSON['stringify'](_0x2a6ab3,null,0x2));const {orderReference:_0x28c1f8,transactionStatus:_0x15427d,processingDate:_0x3299bc,merchantSignature:_0x4857e3,amount:_0x511e50}=_0x2a6ab3;if(!_0x28c1f8||!_0x15427d||_0x3299bc===undefined||!_0x4857e3)return console['error']('WayForPay\x20Webhook:\x20Missing\x20critical\x20fields\x20from\x20payload:',{'orderReference':_0x28c1f8,'transactionStatus':_0x15427d,'processingDate':_0x3299bc,'receivedSignature':_0x4857e3}),new NextResponse('Webhook\x20Error:\x20Missing\x20fields',{'status':0x190});const _0x5b7de4=_0x28c1f8+';'+_0x15427d+';'+_0x3299bc,_0x278eac=a3_0x96e716['createHmac'](_0xac484(0x15b),WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x5b7de4)['digest']('hex');if(_0x278eac!==_0x4857e3)return console['error']('WayForPay\x20Webhook:\x20Invalid\x20signature.',{'calculatedSignature':_0x278eac,'receivedSignature':_0x4857e3,'stringToSign':_0x5b7de4}),new NextResponse('Webhook\x20Error:\x20Invalid\x20signature',{'status':0x190});if(_0x15427d==='Approved'){const _0xa991f0=_0x28c1f8['split']('_');if(_0xa991f0['length']<0x3)console['error']('WayForPay\x20Webhook:\x20Invalid\x20orderReference\x20format',_0x28c1f8);else{const _0x1b54bc=_0xa991f0[0x0],_0x3d5f98=_0xa991f0[0x1],_0x2a898d=await getStudentByClerkId(_0x3d5f98);if(!_0x2a898d?.['data']?.['_id'])console['error']('WayForPay\x20Webhook:\x20Student\x20not\x20found\x20for\x20clerkId\x20'+_0x3d5f98+'\x20in\x20order\x20'+_0x28c1f8);else{const _0x28e12f=_0x2a898d['data']['_id'];await createEnrollment({'studentId':_0x28e12f,'courseId':_0x1b54bc,'paymentId':_0x28c1f8,'amount':_0x511e50,'paymentProvider':'wayforpay'}),console['log']('WayForPay\x20Webhook:\x20Enrollment\x20successfully\x20created\x20for\x20order\x20'+_0x28c1f8);}}}else console['log']('WayForPay\x20Webhook:\x20Received\x20status\x20\x27'+_0x15427d+'\x27\x20for\x20order\x20'+_0x28c1f8+'.\x20No\x20enrollment\x20action\x20taken.');const _0x12702a=Math['floor'](Date[_0xac484(0x158)]()/0x3e8),_0x2f6863=_0x28c1f8+';accept;'+_0x12702a,_0x577213=a3_0x96e716['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x2f6863)['digest'](_0xac484(0x157)),_0x5e1f52={'orderReference':_0x28c1f8,'status':'accept','time':_0x12702a,'signature':_0x577213};return NextResponse['json'](_0x5e1f52,{'status':0xc8});}catch(_0x141d17){console['error']('Error\x20in\x20WayForPay\x20webhook\x20handler:',_0x141d17);const _0x42aa91=_0x2a6ab3?.['orderReference']||'unknown_order_ref_error',_0x5ccb8f=Math['floor'](Date['now']()/0x3e8),_0x162338='error',_0x1f919a=_0x42aa91+';'+_0x162338+';'+_0x5ccb8f,_0x8fd527=a3_0x96e716['createHmac']('md5',WAYFORPAY_MERCHANT_SECRET_KEY)['update'](_0x1f919a)['digest']('hex');return NextResponse['json']({'orderReference':_0x42aa91,'status':_0x162338,'time':_0x5ccb8f,'signature':_0x8fd527},{'status':0x1f4});}}