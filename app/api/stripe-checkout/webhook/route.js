(function(_0x4374ee,_0x2e4d28){const _0x57e229=a2_0xfd7b,_0x8dc28f=_0x4374ee();while(!![]){try{const _0x23a546=-parseInt(_0x57e229(0x109))/0x1*(parseInt(_0x57e229(0x10c))/0x2)+parseInt(_0x57e229(0x106))/0x3*(parseInt(_0x57e229(0x10e))/0x4)+-parseInt(_0x57e229(0x115))/0x5*(-parseInt(_0x57e229(0x10d))/0x6)+-parseInt(_0x57e229(0x114))/0x7+parseInt(_0x57e229(0x107))/0x8*(-parseInt(_0x57e229(0x112))/0x9)+parseInt(_0x57e229(0x113))/0xa*(-parseInt(_0x57e229(0x117))/0xb)+-parseInt(_0x57e229(0x108))/0xc*(-parseInt(_0x57e229(0x10b))/0xd);if(_0x23a546===_0x2e4d28)break;else _0x8dc28f['push'](_0x8dc28f['shift']());}catch(_0x249b48){_0x8dc28f['push'](_0x8dc28f['shift']());}}}(a2_0x3c55,0x1fdec));import{headers}from'next/headers';import{NextResponse}from'next/server';import a2_0x2f26b4 from'stripe';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';function a2_0xfd7b(_0x18e7e3,_0x1fc8ca){const _0x3c555b=a2_0x3c55();return a2_0xfd7b=function(_0xfd7bdc,_0x3b591d){_0xfd7bdc=_0xfd7bdc-0x106;let _0x397008=_0x3c555b[_0xfd7bdc];if(a2_0xfd7b['GmFYJx']===undefined){var _0x543bf2=function(_0x2f26b4){const _0x242c49='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x1bb5dc='',_0x394838='';for(let _0x8dafe6=0x0,_0x29f42c,_0x5ccb39,_0x1e2824=0x0;_0x5ccb39=_0x2f26b4['charAt'](_0x1e2824++);~_0x5ccb39&&(_0x29f42c=_0x8dafe6%0x4?_0x29f42c*0x40+_0x5ccb39:_0x5ccb39,_0x8dafe6++%0x4)?_0x1bb5dc+=String['fromCharCode'](0xff&_0x29f42c>>(-0x2*_0x8dafe6&0x6)):0x0){_0x5ccb39=_0x242c49['indexOf'](_0x5ccb39);}for(let _0x26b961=0x0,_0x4fa1d9=_0x1bb5dc['length'];_0x26b961<_0x4fa1d9;_0x26b961++){_0x394838+='%'+('00'+_0x1bb5dc['charCodeAt'](_0x26b961)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x394838);};a2_0xfd7b['XWuPCl']=_0x543bf2,_0x18e7e3=arguments,a2_0xfd7b['GmFYJx']=!![];}const _0x58a5d8=_0x3c555b[0x0],_0x3b0250=_0xfd7bdc+_0x58a5d8,_0x33d64f=_0x18e7e3[_0x3b0250];return!_0x33d64f?(_0x397008=a2_0xfd7b['XWuPCl'](_0x397008),_0x18e7e3[_0x3b0250]=_0x397008):_0x397008=_0x33d64f,_0x397008;},a2_0xfd7b(_0x18e7e3,_0x1fc8ca);}import{createEnrollment}from'@/sanity/lib/student/createEnrollment';const stripe=new a2_0x2f26b4(process['env']['STRIPE_SECRET_KEY'],{'apiVersion':'2023-10-16'}),webhookSecret=process['env']['STRIPE_WEBHOOK_SECRET'];export async function POST(_0x242c49){const _0xe86e2a=a2_0xfd7b;try{const _0x1bb5dc=await _0x242c49['text'](),_0x394838=await headers(),_0x8dafe6=_0x394838['get']('stripe-signature');if(!_0x8dafe6)return new NextResponse('No\x20signature\x20found',{'status':0x190});let _0x29f42c;try{_0x29f42c=stripe['webhooks']['constructEvent'](_0x1bb5dc,_0x8dafe6,webhookSecret);}catch(_0x5ccb39){const _0x1e2824=_0x5ccb39 instanceof Error?_0x5ccb39[_0xe86e2a(0x116)]:'Unknown\x20error';return console['error']('Webhook\x20signature\x20verification\x20failed:\x20'+_0x1e2824),new NextResponse(_0xe86e2a(0x10f)+_0x1e2824,{'status':0x190});}if(_0x29f42c['type']==='checkout.session.completed'){const _0x26b961=_0x29f42c['data']['object'],_0x4fa1d9=_0x26b961[_0xe86e2a(0x111)]?.['courseId'],_0x3a7bc9=_0x26b961['metadata']?.['userId'];if(!_0x4fa1d9||!_0x3a7bc9)return new NextResponse('Missing\x20metadata',{'status':0x190});const _0xb7097d=await getStudentByClerkId(_0x3a7bc9);if(!_0xb7097d[_0xe86e2a(0x110)])return new NextResponse('Student\x20not\x20found',{'status':0x190});return await createEnrollment({'studentId':_0xb7097d['data']['_id'],'courseId':_0x4fa1d9,'paymentId':_0x26b961['id'],'amount':_0x26b961['amount_total']/0x64,'paymentProvider':_0xe86e2a(0x10a)}),new NextResponse(null,{'status':0xc8});}return new NextResponse(null,{'status':0xc8});}catch(_0x2fa6aa){return console['error']('Error\x20in\x20webhook\x20handler:',_0x2fa6aa),new NextResponse('Webhook\x20handler\x20failed',{'status':0x1f4});}}function a2_0x3c55(){const _0x7ed248=['nKDnvxbqBW','mtyYmZjYuM9kCMu','v2vIAg9VAYbfCNjVCJOG','zgf0yq','Bwv0ywrHDge','oxvJzeDetW','mtqXntKWuNreven5','mZC5mdKYwLjIrvfV','nJa4nZuWEK9tD3nW','BwvZC2fNzq','mtiXwunVAxDf','nZv0s1HRs1e','mta0mdKXmLPKA0DwzW','mtjLBLHMDLy','mNvWCe5XuG','C3rYAxbL','ntKZodu0m1jVBxPyvG','mJa5nduYEe1nwNjb'];a2_0x3c55=function(){return _0x7ed248;};return a2_0x3c55();}