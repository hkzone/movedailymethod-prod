(function(_0x1f8237,_0x15ec7c){const _0x2604ab=a4_0xa3e1,_0x1c5c25=_0x1f8237();while(!![]){try{const _0x19ef83=parseInt(_0x2604ab(0x194))/0x1+-parseInt(_0x2604ab(0x18b))/0x2+-parseInt(_0x2604ab(0x198))/0x3+-parseInt(_0x2604ab(0x193))/0x4*(-parseInt(_0x2604ab(0x197))/0x5)+-parseInt(_0x2604ab(0x18d))/0x6*(parseInt(_0x2604ab(0x18c))/0x7)+-parseInt(_0x2604ab(0x196))/0x8*(parseInt(_0x2604ab(0x191))/0x9)+parseInt(_0x2604ab(0x190))/0xa*(parseInt(_0x2604ab(0x195))/0xb);if(_0x19ef83===_0x15ec7c)break;else _0x1c5c25['push'](_0x1c5c25['shift']());}catch(_0x111309){_0x1c5c25['push'](_0x1c5c25['shift']());}}}(a4_0x3ac5,0x66e6f));import{headers}from'next/headers';function a4_0x3ac5(){const _0xddba58=['9555381LlGUsg','13264YWHKuw','586825nsqsPA','708492pWQFKB','843410iHxSri','444227ppQOOz','12yBjOus','courseId','stripe-signature','10qNnzlL','2781EydlEY','Missing\x20courseId\x20or\x20bundleId\x20in\x20metadata','24AZpnIW','145739RdpTPZ'];a4_0x3ac5=function(){return _0xddba58;};return a4_0x3ac5();}import{NextResponse}from'next/server';import a4_0x2e0f33 from'stripe';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';import{getBundleById}from'@/sanity/lib/courses/getBundleById';function a4_0xa3e1(_0x4019cd,_0x5eff95){const _0x3ac574=a4_0x3ac5();return a4_0xa3e1=function(_0xa3e1d7,_0x3d2cb8){_0xa3e1d7=_0xa3e1d7-0x18b;let _0x577a52=_0x3ac574[_0xa3e1d7];return _0x577a52;},a4_0xa3e1(_0x4019cd,_0x5eff95);}const stripe=new a4_0x2e0f33(process['env']['STRIPE_SECRET_KEY'],{'apiVersion':'2023-10-16'}),webhookSecret=process['env']['STRIPE_WEBHOOK_SECRET'];export async function POST(_0x1f4405){const _0x17e072=a4_0xa3e1;try{const _0x4999c7=await _0x1f4405['text'](),_0x15b3ef=await headers(),_0x330d17=_0x15b3ef['get'](_0x17e072(0x18f));if(!_0x330d17)return new NextResponse('No\x20signature\x20found',{'status':0x190});let _0x224e93;try{_0x224e93=stripe['webhooks']['constructEvent'](_0x4999c7,_0x330d17,webhookSecret);}catch(_0x270f63){const _0x36b341=_0x270f63 instanceof Error?_0x270f63['message']:'Unknown\x20error';return console['error']('Webhook\x20signature\x20verification\x20failed:\x20'+_0x36b341),new NextResponse('Webhook\x20Error:\x20'+_0x36b341,{'status':0x190});}if(_0x224e93['type']==='checkout.session.completed'){const _0x18f6e9=_0x224e93['data']['object'],_0x1064eb=_0x18f6e9['metadata']?.['bundleId'],_0x50519a=_0x18f6e9['metadata']?.[_0x17e072(0x18e)],_0x2c8462=_0x18f6e9['metadata']?.['userId'],_0x20d399=_0x18f6e9['metadata']?.['type'];if(!_0x2c8462)return new NextResponse('Missing\x20userId\x20in\x20metadata',{'status':0x190});const _0x5a17c3=await getStudentByClerkId(_0x2c8462);if(!_0x5a17c3['data'])return new NextResponse('Student\x20not\x20found',{'status':0x190});if(_0x20d399==='bundle'&&_0x1064eb){const _0x43010c=await getBundleById(_0x1064eb);if(!_0x43010c)return new NextResponse('Bundle\x20not\x20found',{'status':0x190});return await createBundleEnrollment({'studentId':_0x5a17c3['data']['_id'],'bundleId':_0x1064eb,'paymentId':_0x18f6e9['id'],'amount':_0x18f6e9['amount_total']/0x64,'paymentProvider':'stripe','bundleData':_0x43010c}),new NextResponse(null,{'status':0xc8});}if(_0x50519a)return await createEnrollment({'studentId':_0x5a17c3['data']['_id'],'courseId':_0x50519a,'paymentId':_0x18f6e9['id'],'amount':_0x18f6e9['amount_total']/0x64,'paymentProvider':'stripe'}),new NextResponse(null,{'status':0xc8});return new NextResponse(_0x17e072(0x192),{'status':0x190});}return new NextResponse(null,{'status':0xc8});}catch(_0x44c9f6){return console['error']('Error\x20in\x20webhook\x20handler:',_0x44c9f6),new NextResponse('Webhook\x20handler\x20failed',{'status':0x1f4});}}