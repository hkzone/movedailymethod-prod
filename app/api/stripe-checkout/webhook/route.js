const a4_0x240008=a4_0x5eb6;(function(_0x5245d2,_0x38e27a){const _0x4df381=a4_0x5eb6,_0x3b2a6f=_0x5245d2();while(!![]){try{const _0x5206c6=-parseInt(_0x4df381(0x160))/0x1*(parseInt(_0x4df381(0x162))/0x2)+parseInt(_0x4df381(0x159))/0x3*(-parseInt(_0x4df381(0x161))/0x4)+parseInt(_0x4df381(0x15d))/0x5+parseInt(_0x4df381(0x15b))/0x6*(parseInt(_0x4df381(0x165))/0x7)+-parseInt(_0x4df381(0x156))/0x8+parseInt(_0x4df381(0x155))/0x9*(parseInt(_0x4df381(0x164))/0xa)+parseInt(_0x4df381(0x15a))/0xb*(-parseInt(_0x4df381(0x15c))/0xc);if(_0x5206c6===_0x38e27a)break;else _0x3b2a6f['push'](_0x3b2a6f['shift']());}catch(_0x525bea){_0x3b2a6f['push'](_0x3b2a6f['shift']());}}}(a4_0x3cdb,0x9e0d1));import{headers}from'next/headers';import{NextResponse}from'next/server';import a4_0x2247d7 from'stripe';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';import{getBundleById}from'@/sanity/lib/courses/getBundleById';function a4_0x5eb6(_0x289b97,_0x43556d){const _0x3cdbc1=a4_0x3cdb();return a4_0x5eb6=function(_0x5eb625,_0x3281ef){_0x5eb625=_0x5eb625-0x155;let _0x4d188a=_0x3cdbc1[_0x5eb625];return _0x4d188a;},a4_0x5eb6(_0x289b97,_0x43556d);}const stripe=new a4_0x2247d7(process[a4_0x240008(0x166)]['STRIPE_SECRET_KEY'],{'apiVersion':'2023-10-16'}),webhookSecret=process['env']['STRIPE_WEBHOOK_SECRET'];export async function POST(_0x42c5d9){const _0xbbd99a=a4_0x240008;try{const _0x15cd33=await _0x42c5d9['text'](),_0x5a9c55=await headers(),_0x4605d3=_0x5a9c55['get'](_0xbbd99a(0x157));if(!_0x4605d3)return new NextResponse('No\x20signature\x20found',{'status':0x190});let _0x24b461;try{_0x24b461=stripe['webhooks']['constructEvent'](_0x15cd33,_0x4605d3,webhookSecret);}catch(_0x2d1afa){const _0x13b30c=_0x2d1afa instanceof Error?_0x2d1afa[_0xbbd99a(0x15f)]:'Unknown\x20error';return console['error']('Webhook\x20signature\x20verification\x20failed:\x20'+_0x13b30c),new NextResponse('Webhook\x20Error:\x20'+_0x13b30c,{'status':0x190});}if(_0x24b461['type']==='checkout.session.completed'){const _0xc961ab=_0x24b461['data']['object'],_0x3600cd=_0xc961ab['metadata']?.['bundleId'],_0x322310=_0xc961ab['metadata']?.[_0xbbd99a(0x163)],_0x2bb660=_0xc961ab['metadata']?.['userId'],_0x1cd05a=_0xc961ab['metadata']?.['type'];if(!_0x2bb660)return new NextResponse('Missing\x20userId\x20in\x20metadata',{'status':0x190});const _0x28f0fd=await getStudentByClerkId(_0x2bb660);if(!_0x28f0fd['data'])return new NextResponse('Student\x20not\x20found',{'status':0x190});if(_0x1cd05a==='bundle'&&_0x3600cd){const _0x8cc004=await getBundleById(_0x3600cd);if(!_0x8cc004)return new NextResponse('Bundle\x20not\x20found',{'status':0x190});return await createBundleEnrollment({'studentId':_0x28f0fd['data'][_0xbbd99a(0x158)],'bundleId':_0x3600cd,'paymentId':_0xc961ab['id'],'amount':_0xc961ab['amount_total']/0x64,'paymentProvider':'stripe','bundleData':_0x8cc004}),new NextResponse(null,{'status':0xc8});}if(_0x322310)return await createEnrollment({'studentId':_0x28f0fd['data']['_id'],'courseId':_0x322310,'paymentId':_0xc961ab['id'],'amount':_0xc961ab['amount_total']/0x64,'paymentProvider':'stripe'}),new NextResponse(null,{'status':0xc8});return new NextResponse('Missing\x20courseId\x20or\x20bundleId\x20in\x20metadata',{'status':0x190});}return new NextResponse(null,{'status':0xc8});}catch(_0x1cc9b9){return console[_0xbbd99a(0x15e)]('Error\x20in\x20webhook\x20handler:',_0x1cc9b9),new NextResponse('Webhook\x20handler\x20failed',{'status':0x1f4});}}function a4_0x3cdb(){const _0x1408cb=['53TQQnsV','64DqMMss','40854VxVBHe','courseId','1040gcDnig','7iZinrC','env','103851yFmWXh','4458128blEmYT','stripe-signature','_id','20058eDLTBO','3699289ICAIbF','7421232FWRTfl','12linwGC','1468105OxMhMg','error','message'];a4_0x3cdb=function(){return _0x1408cb;};return a4_0x3cdb();}