(function(_0x1fa9f7,_0x1fc327){const _0x55b61c=a2_0x3134,_0x11328a=_0x1fa9f7();while(!![]){try{const _0x414ab6=-parseInt(_0x55b61c(0x1a7))/0x1*(-parseInt(_0x55b61c(0x1a5))/0x2)+-parseInt(_0x55b61c(0x1b2))/0x3*(parseInt(_0x55b61c(0x1a3))/0x4)+parseInt(_0x55b61c(0x1b3))/0x5*(parseInt(_0x55b61c(0x1ad))/0x6)+-parseInt(_0x55b61c(0x1a9))/0x7*(-parseInt(_0x55b61c(0x1b0))/0x8)+-parseInt(_0x55b61c(0x1a6))/0x9*(-parseInt(_0x55b61c(0x1b1))/0xa)+-parseInt(_0x55b61c(0x1ab))/0xb+-parseInt(_0x55b61c(0x1ac))/0xc*(parseInt(_0x55b61c(0x1a8))/0xd);if(_0x414ab6===_0x1fc327)break;else _0x11328a['push'](_0x11328a['shift']());}catch(_0x479b74){_0x11328a['push'](_0x11328a['shift']());}}}(a2_0x3194,0x842ff));function a2_0x3134(_0x160dcd,_0x2a5ebd){const _0x3194d3=a2_0x3194();return a2_0x3134=function(_0x3134e6,_0x58bcb9){_0x3134e6=_0x3134e6-0x1a3;let _0x2b4c86=_0x3194d3[_0x3134e6];return _0x2b4c86;},a2_0x3134(_0x160dcd,_0x2a5ebd);}import{headers}from'next/headers';import{NextResponse}from'next/server';import a2_0x1659cf from'stripe';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';function a2_0x3194(){const _0x2df9d8=['879080kfHEAK','21stYwPV','166205oqLJJQ','188540agbRtC','Webhook\x20signature\x20verification\x20failed:\x20','58QNXTmS','9NcIlGT','15109lDzoVc','3592199KepKPs','2198upExjV','Error\x20in\x20webhook\x20handler:','8711813iKpOAB','24BxHHxA','132eJZOfx','constructEvent','No\x20signature\x20found','24424pFHVlu'];a2_0x3194=function(){return _0x2df9d8;};return a2_0x3194();}import{createEnrollment}from'@/sanity/lib/student/createEnrollment';const stripe=new a2_0x1659cf(process['env']['STRIPE_SECRET_KEY'],{'apiVersion':'2023-10-16'}),webhookSecret=process['env']['STRIPE_WEBHOOK_SECRET'];export async function POST(_0x1e6198){const _0x3602d3=a2_0x3134;try{const _0x1c06a6=await _0x1e6198['text'](),_0x39c660=await headers(),_0x4037a2=_0x39c660['get']('stripe-signature');if(!_0x4037a2)return new NextResponse(_0x3602d3(0x1af),{'status':0x190});let _0x1dbfca;try{_0x1dbfca=stripe['webhooks'][_0x3602d3(0x1ae)](_0x1c06a6,_0x4037a2,webhookSecret);}catch(_0x4976ec){const _0x17f0ad=_0x4976ec instanceof Error?_0x4976ec['message']:'Unknown\x20error';return console['error'](_0x3602d3(0x1a4)+_0x17f0ad),new NextResponse('Webhook\x20Error:\x20'+_0x17f0ad,{'status':0x190});}if(_0x1dbfca['type']==='checkout.session.completed'){const _0x495aee=_0x1dbfca['data']['object'],_0x16ad9f=_0x495aee['metadata']?.['courseId'],_0x2aae6c=_0x495aee['metadata']?.['userId'];if(!_0x16ad9f||!_0x2aae6c)return new NextResponse('Missing\x20metadata',{'status':0x190});const _0x57c785=await getStudentByClerkId(_0x2aae6c);if(!_0x57c785['data'])return new NextResponse('Student\x20not\x20found',{'status':0x190});return await createEnrollment({'studentId':_0x57c785['data']['_id'],'courseId':_0x16ad9f,'paymentId':_0x495aee['id'],'amount':_0x495aee['amount_total']/0x64,'paymentProvider':'stripe'}),new NextResponse(null,{'status':0xc8});}return new NextResponse(null,{'status':0xc8});}catch(_0x3aaa64){return console['error'](_0x3602d3(0x1aa),_0x3aaa64),new NextResponse('Webhook\x20handler\x20failed',{'status':0x1f4});}}