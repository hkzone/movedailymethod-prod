(function(_0x4e63cf,_0x1f89cb){const _0x10cde0=a2_0x3d65,_0x3444ce=_0x4e63cf();while(!![]){try{const _0x5bcf8f=parseInt(_0x10cde0(0x1d4))/0x1*(parseInt(_0x10cde0(0x1ca))/0x2)+-parseInt(_0x10cde0(0x1d1))/0x3*(-parseInt(_0x10cde0(0x1d3))/0x4)+parseInt(_0x10cde0(0x1cc))/0x5*(-parseInt(_0x10cde0(0x1d6))/0x6)+-parseInt(_0x10cde0(0x1cf))/0x7*(parseInt(_0x10cde0(0x1ce))/0x8)+parseInt(_0x10cde0(0x1cb))/0x9+parseInt(_0x10cde0(0x1d5))/0xa+parseInt(_0x10cde0(0x1d0))/0xb*(-parseInt(_0x10cde0(0x1d2))/0xc);if(_0x5bcf8f===_0x1f89cb)break;else _0x3444ce['push'](_0x3444ce['shift']());}catch(_0x1018f2){_0x3444ce['push'](_0x3444ce['shift']());}}}(a2_0x107d,0x2abbd));import{headers}from'next/headers';import{NextResponse}from'next/server';import a2_0x5d1251 from'stripe';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';const stripe=new a2_0x5d1251(process['env']['STRIPE_SECRET_KEY'],{'apiVersion':'2023-10-16'}),webhookSecret=process['env']['STRIPE_WEBHOOK_SECRET'];export async function POST(_0x475a63){const _0x4a9b4a=a2_0x3d65;try{const _0x58c946=await _0x475a63['text'](),_0x42080e=await headers(),_0xb14f2e=_0x42080e[_0x4a9b4a(0x1cd)]('stripe-signature');if(!_0xb14f2e)return new NextResponse('No\x20signature\x20found',{'status':0x190});let _0x1b3256;try{_0x1b3256=stripe['webhooks']['constructEvent'](_0x58c946,_0xb14f2e,webhookSecret);}catch(_0x6521c5){const _0xd6a9f2=_0x6521c5 instanceof Error?_0x6521c5['message']:'Unknown\x20error';return console['error']('Webhook\x20signature\x20verification\x20failed:\x20'+_0xd6a9f2),new NextResponse('Webhook\x20Error:\x20'+_0xd6a9f2,{'status':0x190});}if(_0x1b3256['type']==='checkout.session.completed'){const _0xc5aeaa=_0x1b3256['data']['object'],_0x509d7e=_0xc5aeaa['metadata']?.['courseId'],_0x47886f=_0xc5aeaa['metadata']?.['userId'];if(!_0x509d7e||!_0x47886f)return new NextResponse('Missing\x20metadata',{'status':0x190});const _0x36fd82=await getStudentByClerkId(_0x47886f);if(!_0x36fd82['data'])return new NextResponse('Student\x20not\x20found',{'status':0x190});return await createEnrollment({'studentId':_0x36fd82['data']['_id'],'courseId':_0x509d7e,'paymentId':_0xc5aeaa['id'],'amount':_0xc5aeaa['amount_total']/0x64,'paymentProvider':'stripe'}),new NextResponse(null,{'status':0xc8});}return new NextResponse(null,{'status':0xc8});}catch(_0x54084a){return console['error']('Error\x20in\x20webhook\x20handler:',_0x54084a),new NextResponse('Webhook\x20handler\x20failed',{'status':0x1f4});}}function a2_0x3d65(_0x47f1b5,_0x5046b0){const _0x107de0=a2_0x107d();return a2_0x3d65=function(_0x3d658a,_0xbfa2bd){_0x3d658a=_0x3d658a-0x1ca;let _0x24d76a=_0x107de0[_0x3d658a];return _0x24d76a;},a2_0x3d65(_0x47f1b5,_0x5046b0);}function a2_0x107d(){const _0x8c7a25=['2147121rjfFRx','645910zVIAOH','get','2384504bUHgzp','7QtqhFn','371701lYgwLD','902793ndDqav','216mDSgYG','4bsdPFe','69zhedZB','3311260RgmYEp','6WYxvjM','9852ROhpSE'];a2_0x107d=function(){return _0x8c7a25;};return a2_0x107d();}