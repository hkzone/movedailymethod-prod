const a2_0x853f64=a2_0x41a5;(function(_0x24a014,_0x287ed3){const _0x50f422=a2_0x41a5,_0xdb4ae1=_0x24a014();while(!![]){try{const _0x2fc17c=-parseInt(_0x50f422(0x15c))/0x1*(parseInt(_0x50f422(0x167))/0x2)+-parseInt(_0x50f422(0x168))/0x3*(parseInt(_0x50f422(0x15e))/0x4)+-parseInt(_0x50f422(0x156))/0x5+parseInt(_0x50f422(0x162))/0x6+-parseInt(_0x50f422(0x155))/0x7+-parseInt(_0x50f422(0x160))/0x8+parseInt(_0x50f422(0x165))/0x9;if(_0x2fc17c===_0x287ed3)break;else _0xdb4ae1['push'](_0xdb4ae1['shift']());}catch(_0x2ada64){_0xdb4ae1['push'](_0xdb4ae1['shift']());}}}(a2_0xb0f9,0x4e5fb));import{headers}from'next/headers';import{NextResponse}from'next/server';import a2_0x3b80d4 from'stripe';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';function a2_0xb0f9(){const _0x5a6568=['mtq3ote3mgXPAvLfyq','u1rssvbfx1nfq1jfvf9lrvK','y2HLy2TVDxqUC2vZC2LVBI5JB21WBgv0zwq','rxjYB3iGAw4GD2vIAg9VAYbOyw5KBgvYoG','z2v0','zw52','nJaXodbzCNjOseS','mJaYmY0Xmc0XnG','ne5psvLvyW','Bwv0ywrHDge','mZqZntq0q3HeBxfQ','zgf0yq','mte3mJyWneDctgzrwa','DhLWzq','y291CNnLswq','mty0mZq2mZbmwKzQqKy','B2jQzwn0','mtHgAenKq1a','mtKXntC0m1zWy2jxAG','u3r1zgvUDcbUB3qGzM91BMq','zxjYB3i','C3rYAxbLlxnPz25HDhvYzq','mti3mdu0owTRr1vPAG'];a2_0xb0f9=function(){return _0x5a6568;};return a2_0xb0f9();}const stripe=new a2_0x3b80d4(process['env'][a2_0x853f64(0x157)],{'apiVersion':a2_0x853f64(0x15d)}),webhookSecret=process[a2_0x853f64(0x15b)]['STRIPE_WEBHOOK_SECRET'];function a2_0x41a5(_0x49b370,_0x403cb3){const _0xb0f94c=a2_0xb0f9();return a2_0x41a5=function(_0x41a59b,_0x239883){_0x41a59b=_0x41a59b-0x154;let _0x3fe2f1=_0xb0f94c[_0x41a59b];if(a2_0x41a5['wVHstQ']===undefined){var _0xba64b0=function(_0x3b80d4){const _0x3495be='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x459aeb='',_0x3f6c4b='';for(let _0x587786=0x0,_0x56b074,_0x1982b3,_0x69fccf=0x0;_0x1982b3=_0x3b80d4['charAt'](_0x69fccf++);~_0x1982b3&&(_0x56b074=_0x587786%0x4?_0x56b074*0x40+_0x1982b3:_0x1982b3,_0x587786++%0x4)?_0x459aeb+=String['fromCharCode'](0xff&_0x56b074>>(-0x2*_0x587786&0x6)):0x0){_0x1982b3=_0x3495be['indexOf'](_0x1982b3);}for(let _0x51c401=0x0,_0x4f35db=_0x459aeb['length'];_0x51c401<_0x4f35db;_0x51c401++){_0x3f6c4b+='%'+('00'+_0x459aeb['charCodeAt'](_0x51c401)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x3f6c4b);};a2_0x41a5['MnFcHC']=_0xba64b0,_0x49b370=arguments,a2_0x41a5['wVHstQ']=!![];}const _0x5ee2a5=_0xb0f94c[0x0],_0xeed02b=_0x41a59b+_0x5ee2a5,_0x38bbd1=_0x49b370[_0xeed02b];return!_0x38bbd1?(_0x3fe2f1=a2_0x41a5['MnFcHC'](_0x3fe2f1),_0x49b370[_0xeed02b]=_0x3fe2f1):_0x3fe2f1=_0x38bbd1,_0x3fe2f1;},a2_0x41a5(_0x49b370,_0x403cb3);}export async function POST(_0x3495be){const _0xd90b5d=a2_0x853f64;try{const _0x459aeb=await _0x3495be['text'](),_0x3f6c4b=await headers(),_0x587786=_0x3f6c4b[_0xd90b5d(0x15a)](_0xd90b5d(0x154));if(!_0x587786)return new NextResponse('No\x20signature\x20found',{'status':0x190});let _0x56b074;try{_0x56b074=stripe['webhooks']['constructEvent'](_0x459aeb,_0x587786,webhookSecret);}catch(_0x1982b3){const _0x69fccf=_0x1982b3 instanceof Error?_0x1982b3['message']:'Unknown\x20error';return console[_0xd90b5d(0x16a)]('Webhook\x20signature\x20verification\x20failed:\x20'+_0x69fccf),new NextResponse('Webhook\x20Error:\x20'+_0x69fccf,{'status':0x190});}if(_0x56b074[_0xd90b5d(0x163)]===_0xd90b5d(0x158)){const _0x51c401=_0x56b074[_0xd90b5d(0x161)][_0xd90b5d(0x166)],_0x4f35db=_0x51c401[_0xd90b5d(0x15f)]?.[_0xd90b5d(0x164)],_0x321cf5=_0x51c401['metadata']?.['userId'];if(!_0x4f35db||!_0x321cf5)return new NextResponse('Missing\x20metadata',{'status':0x190});const _0x31bc64=await getStudentByClerkId(_0x321cf5);if(!_0x31bc64[_0xd90b5d(0x161)])return new NextResponse(_0xd90b5d(0x169),{'status':0x190});return await createEnrollment({'studentId':_0x31bc64[_0xd90b5d(0x161)]['_id'],'courseId':_0x4f35db,'paymentId':_0x51c401['id'],'amount':_0x51c401['amount_total']/0x64,'paymentProvider':'stripe'}),new NextResponse(null,{'status':0xc8});}return new NextResponse(null,{'status':0xc8});}catch(_0x33949f){return console[_0xd90b5d(0x16a)](_0xd90b5d(0x159),_0x33949f),new NextResponse('Webhook\x20handler\x20failed',{'status':0x1f4});}}