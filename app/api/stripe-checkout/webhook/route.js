(function(_0x56ea62,_0x2ec98d){const _0x341ca7=a4_0xcbc3,_0x8d233=_0x56ea62();while(!![]){try{const _0x404f7a=-parseInt(_0x341ca7(0xed))/0x1+parseInt(_0x341ca7(0xf0))/0x2+-parseInt(_0x341ca7(0xf2))/0x3+parseInt(_0x341ca7(0xf3))/0x4+-parseInt(_0x341ca7(0xea))/0x5+-parseInt(_0x341ca7(0xef))/0x6*(parseInt(_0x341ca7(0xf1))/0x7)+parseInt(_0x341ca7(0xec))/0x8;if(_0x404f7a===_0x2ec98d)break;else _0x8d233['push'](_0x8d233['shift']());}catch(_0x5e4945){_0x8d233['push'](_0x8d233['shift']());}}}(a4_0x23a1,0x3eefb));function a4_0xcbc3(_0x48788d,_0x258d02){const _0x23a16a=a4_0x23a1();return a4_0xcbc3=function(_0xcbc3dd,_0x4fa411){_0xcbc3dd=_0xcbc3dd-0xe9;let _0x2336e4=_0x23a16a[_0xcbc3dd];return _0x2336e4;},a4_0xcbc3(_0x48788d,_0x258d02);}import{headers}from'next/headers';import{NextResponse}from'next/server';import a4_0x57b64c from'stripe';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';import{getBundleById}from'@/sanity/lib/courses/getBundleById';const stripe=new a4_0x57b64c(process['env']['STRIPE_SECRET_KEY'],{'apiVersion':'2023-10-16'}),webhookSecret=process['env']['STRIPE_WEBHOOK_SECRET'];function a4_0x23a1(){const _0x19be9f=['1192134VrXeii','392420MjwrNx','7vWikJK','1355949DGhRSe','1704180OlySYK','constructEvent','2576740dfXeex','Missing\x20userId\x20in\x20metadata','8542552hRwJPd','266267cTAyTT','webhooks'];a4_0x23a1=function(){return _0x19be9f;};return a4_0x23a1();}export async function POST(_0x40ebbf){const _0x44a66a=a4_0xcbc3;try{const _0xd265ae=await _0x40ebbf['text'](),_0x2f3cc6=await headers(),_0x3008b8=_0x2f3cc6['get']('stripe-signature');if(!_0x3008b8)return new NextResponse('No\x20signature\x20found',{'status':0x190});let _0x452e6c;try{_0x452e6c=stripe[_0x44a66a(0xee)][_0x44a66a(0xe9)](_0xd265ae,_0x3008b8,webhookSecret);}catch(_0x4fde9d){const _0x381116=_0x4fde9d instanceof Error?_0x4fde9d['message']:'Unknown\x20error';return console['error']('Webhook\x20signature\x20verification\x20failed:\x20'+_0x381116),new NextResponse('Webhook\x20Error:\x20'+_0x381116,{'status':0x190});}if(_0x452e6c['type']==='checkout.session.completed'){const _0x3dfaf6=_0x452e6c['data']['object'],_0x1821c4=_0x3dfaf6['metadata']?.['bundleId'],_0x386438=_0x3dfaf6['metadata']?.['courseId'],_0x12faca=_0x3dfaf6['metadata']?.['userId'],_0x429737=_0x3dfaf6['metadata']?.['type'];if(!_0x12faca)return new NextResponse(_0x44a66a(0xeb),{'status':0x190});const _0x2ac3e6=await getStudentByClerkId(_0x12faca);if(!_0x2ac3e6['data'])return new NextResponse('Student\x20not\x20found',{'status':0x190});if(_0x429737==='bundle'&&_0x1821c4){const _0xb42fbc=await getBundleById(_0x1821c4);if(!_0xb42fbc)return new NextResponse('Bundle\x20not\x20found',{'status':0x190});return await createBundleEnrollment({'studentId':_0x2ac3e6['data']['_id'],'bundleId':_0x1821c4,'paymentId':_0x3dfaf6['id'],'amount':_0x3dfaf6['amount_total']/0x64,'paymentProvider':'stripe','bundleData':_0xb42fbc}),new NextResponse(null,{'status':0xc8});}if(_0x386438)return await createEnrollment({'studentId':_0x2ac3e6['data']['_id'],'courseId':_0x386438,'paymentId':_0x3dfaf6['id'],'amount':_0x3dfaf6['amount_total']/0x64,'paymentProvider':'stripe'}),new NextResponse(null,{'status':0xc8});return new NextResponse('Missing\x20courseId\x20or\x20bundleId\x20in\x20metadata',{'status':0x190});}return new NextResponse(null,{'status':0xc8});}catch(_0xa7dd04){return console['error']('Error\x20in\x20webhook\x20handler:',_0xa7dd04),new NextResponse('Webhook\x20handler\x20failed',{'status':0x1f4});}}