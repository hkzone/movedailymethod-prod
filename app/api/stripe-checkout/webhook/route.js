const a4_0x3925a5=a4_0xf1bf;(function(_0x548837,_0x53f2b9){const _0x483115=a4_0xf1bf,_0x36877e=_0x548837();while(!![]){try{const _0x4c23a4=parseInt(_0x483115(0x12c))/0x1+-parseInt(_0x483115(0x125))/0x2+parseInt(_0x483115(0x11f))/0x3+parseInt(_0x483115(0x122))/0x4+-parseInt(_0x483115(0x126))/0x5+parseInt(_0x483115(0x12a))/0x6+parseInt(_0x483115(0x123))/0x7*(-parseInt(_0x483115(0x120))/0x8);if(_0x4c23a4===_0x53f2b9)break;else _0x36877e['push'](_0x36877e['shift']());}catch(_0x2d5bba){_0x36877e['push'](_0x36877e['shift']());}}}(a4_0x279b,0x4aa6d));import{headers}from'next/headers';function a4_0x279b(){const _0x396688=['env','error','665682xSfwxE','courseId','175624fTcAHP','1032138qnBIof','136DksEbB','data','2082260lGuOIi','17136FDFgrX','object','1171764FnBEfZ','1089555SvGSdp','_id'];a4_0x279b=function(){return _0x396688;};return a4_0x279b();}import{NextResponse}from'next/server';import a4_0xa11baf from'stripe';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';function a4_0xf1bf(_0x48b845,_0x134812){const _0x279bcc=a4_0x279b();return a4_0xf1bf=function(_0xf1bfb6,_0x4727cc){_0xf1bfb6=_0xf1bfb6-0x11f;let _0x256f34=_0x279bcc[_0xf1bfb6];return _0x256f34;},a4_0xf1bf(_0x48b845,_0x134812);}import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';import{getBundleById}from'@/sanity/lib/courses/getBundleById';const stripe=new a4_0xa11baf(process[a4_0x3925a5(0x128)]['STRIPE_SECRET_KEY'],{'apiVersion':'2023-10-16'}),webhookSecret=process['env']['STRIPE_WEBHOOK_SECRET'];export async function POST(_0x4922c7){const _0x1761a5=a4_0x3925a5;try{const _0x2699b8=await _0x4922c7['text'](),_0x39ca71=await headers(),_0x10085e=_0x39ca71['get']('stripe-signature');if(!_0x10085e)return new NextResponse('No\x20signature\x20found',{'status':0x190});let _0x4f02c4;try{_0x4f02c4=stripe['webhooks']['constructEvent'](_0x2699b8,_0x10085e,webhookSecret);}catch(_0x5eb0c2){const _0x160aff=_0x5eb0c2 instanceof Error?_0x5eb0c2['message']:'Unknown\x20error';return console[_0x1761a5(0x129)]('Webhook\x20signature\x20verification\x20failed:\x20'+_0x160aff),new NextResponse('Webhook\x20Error:\x20'+_0x160aff,{'status':0x190});}if(_0x4f02c4['type']==='checkout.session.completed'){const _0x5ab791=_0x4f02c4['data'][_0x1761a5(0x124)],_0x53c28b=_0x5ab791['metadata']?.['bundleId'],_0x6fbebc=_0x5ab791['metadata']?.[_0x1761a5(0x12b)],_0x37c346=_0x5ab791['metadata']?.['userId'],_0x99d32f=_0x5ab791['metadata']?.['type'];if(!_0x37c346)return new NextResponse('Missing\x20userId\x20in\x20metadata',{'status':0x190});const _0x3aacc7=await getStudentByClerkId(_0x37c346);if(!_0x3aacc7['data'])return new NextResponse('Student\x20not\x20found',{'status':0x190});if(_0x99d32f==='bundle'&&_0x53c28b){const _0x246f6d=await getBundleById(_0x53c28b);if(!_0x246f6d)return new NextResponse('Bundle\x20not\x20found',{'status':0x190});return await createBundleEnrollment({'studentId':_0x3aacc7[_0x1761a5(0x121)]['_id'],'bundleId':_0x53c28b,'paymentId':_0x5ab791['id'],'amount':_0x5ab791['amount_total']/0x64,'paymentProvider':'stripe','bundleData':_0x246f6d}),new NextResponse(null,{'status':0xc8});}if(_0x6fbebc)return await createEnrollment({'studentId':_0x3aacc7[_0x1761a5(0x121)][_0x1761a5(0x127)],'courseId':_0x6fbebc,'paymentId':_0x5ab791['id'],'amount':_0x5ab791['amount_total']/0x64,'paymentProvider':'stripe'}),new NextResponse(null,{'status':0xc8});return new NextResponse('Missing\x20courseId\x20or\x20bundleId\x20in\x20metadata',{'status':0x190});}return new NextResponse(null,{'status':0xc8});}catch(_0xa4143e){return console['error']('Error\x20in\x20webhook\x20handler:',_0xa4143e),new NextResponse('Webhook\x20handler\x20failed',{'status':0x1f4});}}