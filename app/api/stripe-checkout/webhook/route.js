(function(_0xb95eea,_0x3d655e){const _0x4b0502=a2_0x4b81,_0x125a7a=_0xb95eea();while(!![]){try{const _0x126dc9=parseInt(_0x4b0502(0xe4))/0x1+parseInt(_0x4b0502(0xe8))/0x2+parseInt(_0x4b0502(0xe2))/0x3+parseInt(_0x4b0502(0xe7))/0x4+-parseInt(_0x4b0502(0xe0))/0x5+parseInt(_0x4b0502(0xe9))/0x6*(parseInt(_0x4b0502(0xe5))/0x7)+-parseInt(_0x4b0502(0xe3))/0x8;if(_0x126dc9===_0x3d655e)break;else _0x125a7a['push'](_0x125a7a['shift']());}catch(_0x249b41){_0x125a7a['push'](_0x125a7a['shift']());}}}(a2_0x1d45,0x9620e));import{headers}from'next/headers';import{NextResponse}from'next/server';function a2_0x4b81(_0x1804b4,_0x177a79){const _0x1d45fb=a2_0x1d45();return a2_0x4b81=function(_0x4b819a,_0x466abe){_0x4b819a=_0x4b819a-0xe0;let _0x3fe610=_0x1d45fb[_0x4b819a];return _0x3fe610;},a2_0x4b81(_0x1804b4,_0x177a79);}import a2_0x1cae4b from'stripe';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';function a2_0x1d45(){const _0x3e5c9a=['670296DxGlej','1043418YPcCoP','474Kpspmu','2162045AzIXJn','Webhook\x20Error:\x20','3067191oXvCzX','12086688ZZVQNQ','322WNSWmD','74977WLqFCh','data'];a2_0x1d45=function(){return _0x3e5c9a;};return a2_0x1d45();}const stripe=new a2_0x1cae4b(process['env']['STRIPE_SECRET_KEY'],{'apiVersion':'2023-10-16'}),webhookSecret=process['env']['STRIPE_WEBHOOK_SECRET'];export async function POST(_0x7eac7a){const _0x1941f3=a2_0x4b81;try{const _0x3b5731=await _0x7eac7a['text'](),_0x12a9bd=await headers(),_0x13b9ef=_0x12a9bd['get']('stripe-signature');if(!_0x13b9ef)return new NextResponse('No\x20signature\x20found',{'status':0x190});let _0x2a4a36;try{_0x2a4a36=stripe['webhooks']['constructEvent'](_0x3b5731,_0x13b9ef,webhookSecret);}catch(_0x4d59ec){const _0x2d7fe1=_0x4d59ec instanceof Error?_0x4d59ec['message']:'Unknown\x20error';return console['error']('Webhook\x20signature\x20verification\x20failed:\x20'+_0x2d7fe1),new NextResponse(_0x1941f3(0xe1)+_0x2d7fe1,{'status':0x190});}if(_0x2a4a36['type']==='checkout.session.completed'){const _0x51c81e=_0x2a4a36['data']['object'],_0x1f90ab=_0x51c81e['metadata']?.['courseId'],_0x11c960=_0x51c81e['metadata']?.['userId'];if(!_0x1f90ab||!_0x11c960)return new NextResponse('Missing\x20metadata',{'status':0x190});const _0x1145b0=await getStudentByClerkId(_0x11c960);if(!_0x1145b0['data'])return new NextResponse('Student\x20not\x20found',{'status':0x190});return await createEnrollment({'studentId':_0x1145b0[_0x1941f3(0xe6)]['_id'],'courseId':_0x1f90ab,'paymentId':_0x51c81e['id'],'amount':_0x51c81e['amount_total']/0x64,'paymentProvider':'stripe'}),new NextResponse(null,{'status':0xc8});}return new NextResponse(null,{'status':0xc8});}catch(_0x5a7aa0){return console['error']('Error\x20in\x20webhook\x20handler:',_0x5a7aa0),new NextResponse('Webhook\x20handler\x20failed',{'status':0x1f4});}}