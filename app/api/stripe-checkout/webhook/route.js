const a2_0x5aa7b0=a2_0x5e46;(function(_0x39d0c8,_0x1af70a){const _0x2cc1f5=a2_0x5e46,_0x3f30c1=_0x39d0c8();while(!![]){try{const _0x25f2ce=parseInt(_0x2cc1f5(0x162))/0x1*(parseInt(_0x2cc1f5(0x15f))/0x2)+-parseInt(_0x2cc1f5(0x15c))/0x3+-parseInt(_0x2cc1f5(0x15d))/0x4+parseInt(_0x2cc1f5(0x160))/0x5+parseInt(_0x2cc1f5(0x15e))/0x6+-parseInt(_0x2cc1f5(0x163))/0x7+-parseInt(_0x2cc1f5(0x15b))/0x8*(-parseInt(_0x2cc1f5(0x15a))/0x9);if(_0x25f2ce===_0x1af70a)break;else _0x3f30c1['push'](_0x3f30c1['shift']());}catch(_0x45d29b){_0x3f30c1['push'](_0x3f30c1['shift']());}}}(a2_0x1c2d,0x6d317));import{headers}from'next/headers';import{NextResponse}from'next/server';import a2_0xc20fcf from'stripe';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';function a2_0x5e46(_0x58f85c,_0x17b82e){const _0x1c2d75=a2_0x1c2d();return a2_0x5e46=function(_0x5e46f1,_0x3db361){_0x5e46f1=_0x5e46f1-0x159;let _0x31b06c=_0x1c2d75[_0x5e46f1];return _0x31b06c;},a2_0x5e46(_0x58f85c,_0x17b82e);}function a2_0x1c2d(){const _0x3bca31=['checkout.session.completed','35452nLPQWL','4357766CKchPV','2023-10-16','type','2752209KqkkwO','24MzJuYc','2042841ujnFcI','1199612PvLcYu','3676536RDRjAD','2NJWmsH','2425160wqbqQh'];a2_0x1c2d=function(){return _0x3bca31;};return a2_0x1c2d();}import{createEnrollment}from'@/sanity/lib/student/createEnrollment';const stripe=new a2_0xc20fcf(process['env']['STRIPE_SECRET_KEY'],{'apiVersion':a2_0x5aa7b0(0x164)}),webhookSecret=process['env']['STRIPE_WEBHOOK_SECRET'];export async function POST(_0x2c48f1){const _0x314065=a2_0x5aa7b0;try{const _0x511408=await _0x2c48f1['text'](),_0x14c817=await headers(),_0x6e7139=_0x14c817['get']('stripe-signature');if(!_0x6e7139)return new NextResponse('No\x20signature\x20found',{'status':0x190});let _0xc82cce;try{_0xc82cce=stripe['webhooks']['constructEvent'](_0x511408,_0x6e7139,webhookSecret);}catch(_0x466808){const _0x1a3f0b=_0x466808 instanceof Error?_0x466808['message']:'Unknown\x20error';return console['error']('Webhook\x20signature\x20verification\x20failed:\x20'+_0x1a3f0b),new NextResponse('Webhook\x20Error:\x20'+_0x1a3f0b,{'status':0x190});}if(_0xc82cce[_0x314065(0x159)]===_0x314065(0x161)){const _0x7c20f0=_0xc82cce['data']['object'],_0x5cfbed=_0x7c20f0['metadata']?.['courseId'],_0x29d6f2=_0x7c20f0['metadata']?.['userId'];if(!_0x5cfbed||!_0x29d6f2)return new NextResponse('Missing\x20metadata',{'status':0x190});const _0x94969b=await getStudentByClerkId(_0x29d6f2);if(!_0x94969b['data'])return new NextResponse('Student\x20not\x20found',{'status':0x190});return await createEnrollment({'studentId':_0x94969b['data']['_id'],'courseId':_0x5cfbed,'paymentId':_0x7c20f0['id'],'amount':_0x7c20f0['amount_total']/0x64,'paymentProvider':'stripe'}),new NextResponse(null,{'status':0xc8});}return new NextResponse(null,{'status':0xc8});}catch(_0x160a27){return console['error']('Error\x20in\x20webhook\x20handler:',_0x160a27),new NextResponse('Webhook\x20handler\x20failed',{'status':0x1f4});}}