const a4_0x3260e1=a4_0x5d40;(function(_0x3e83a2,_0x1c9f2c){const _0x1d420f=a4_0x5d40,_0x47809a=_0x3e83a2();while(!![]){try{const _0x1cfe19=-parseInt(_0x1d420f(0x196))/0x1*(-parseInt(_0x1d420f(0x193))/0x2)+parseInt(_0x1d420f(0x195))/0x3+parseInt(_0x1d420f(0x197))/0x4+-parseInt(_0x1d420f(0x191))/0x5*(-parseInt(_0x1d420f(0x18a))/0x6)+parseInt(_0x1d420f(0x199))/0x7+-parseInt(_0x1d420f(0x18c))/0x8+-parseInt(_0x1d420f(0x194))/0x9;if(_0x1cfe19===_0x1c9f2c)break;else _0x47809a['push'](_0x47809a['shift']());}catch(_0x5f018a){_0x47809a['push'](_0x47809a['shift']());}}}(a4_0x8bd4,0xd4892));function a4_0x5d40(_0xdaceb1,_0x26f771){const _0x8bd478=a4_0x8bd4();return a4_0x5d40=function(_0x5d4017,_0x1616a6){_0x5d4017=_0x5d4017-0x18a;let _0x52589a=_0x8bd478[_0x5d4017];return _0x52589a;},a4_0x5d40(_0xdaceb1,_0x26f771);}import{headers}from'next/headers';import{NextResponse}from'next/server';import a4_0xd55a39 from'stripe';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';import{getBundleById}from'@/sanity/lib/courses/getBundleById';function a4_0x8bd4(){const _0x408329=['5vUlaJp','env','172426jJxcXG','8883279RfkYSG','4338489LHSWqB','9eKhwSa','1477260zgxaAR','Webhook\x20handler\x20failed','4535048YGlTZA','803016AITGVo','2023-10-16','12124144ZeqOzi','_id','Missing\x20courseId\x20or\x20bundleId\x20in\x20metadata','STRIPE_SECRET_KEY','Missing\x20userId\x20in\x20metadata'];a4_0x8bd4=function(){return _0x408329;};return a4_0x8bd4();}const stripe=new a4_0xd55a39(process['env'][a4_0x3260e1(0x18f)],{'apiVersion':a4_0x3260e1(0x18b)}),webhookSecret=process[a4_0x3260e1(0x192)]['STRIPE_WEBHOOK_SECRET'];export async function POST(_0x1cdee8){const _0x2c72ce=a4_0x3260e1;try{const _0x37fbbb=await _0x1cdee8['text'](),_0x79d02b=await headers(),_0x2a28c9=_0x79d02b['get']('stripe-signature');if(!_0x2a28c9)return new NextResponse('No\x20signature\x20found',{'status':0x190});let _0xf10119;try{_0xf10119=stripe['webhooks']['constructEvent'](_0x37fbbb,_0x2a28c9,webhookSecret);}catch(_0x594376){const _0x3aa866=_0x594376 instanceof Error?_0x594376['message']:'Unknown\x20error';return console['error']('Webhook\x20signature\x20verification\x20failed:\x20'+_0x3aa866),new NextResponse('Webhook\x20Error:\x20'+_0x3aa866,{'status':0x190});}if(_0xf10119['type']==='checkout.session.completed'){const _0x27b7cb=_0xf10119['data']['object'],_0x3ec615=_0x27b7cb['metadata']?.['bundleId'],_0x183423=_0x27b7cb['metadata']?.['courseId'],_0x5a7c72=_0x27b7cb['metadata']?.['userId'],_0x107004=_0x27b7cb['metadata']?.['type'];if(!_0x5a7c72)return new NextResponse(_0x2c72ce(0x190),{'status':0x190});const _0x49e868=await getStudentByClerkId(_0x5a7c72);if(!_0x49e868['data'])return new NextResponse('Student\x20not\x20found',{'status':0x190});if(_0x107004==='bundle'&&_0x3ec615){const _0x3f8066=await getBundleById(_0x3ec615);if(!_0x3f8066)return new NextResponse('Bundle\x20not\x20found',{'status':0x190});return await createBundleEnrollment({'studentId':_0x49e868['data']['_id'],'bundleId':_0x3ec615,'paymentId':_0x27b7cb['id'],'amount':_0x27b7cb['amount_total']/0x64,'paymentProvider':'stripe','bundleData':_0x3f8066}),new NextResponse(null,{'status':0xc8});}if(_0x183423)return await createEnrollment({'studentId':_0x49e868['data'][_0x2c72ce(0x18d)],'courseId':_0x183423,'paymentId':_0x27b7cb['id'],'amount':_0x27b7cb['amount_total']/0x64,'paymentProvider':'stripe'}),new NextResponse(null,{'status':0xc8});return new NextResponse(_0x2c72ce(0x18e),{'status':0x190});}return new NextResponse(null,{'status':0xc8});}catch(_0x22e67e){return console['error']('Error\x20in\x20webhook\x20handler:',_0x22e67e),new NextResponse(_0x2c72ce(0x198),{'status':0x1f4});}}