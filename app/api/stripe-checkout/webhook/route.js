const a4_0x310cd9=a4_0x442c;(function(_0x5a3ae5,_0x111e41){const _0x2b0571=a4_0x442c,_0x305ae8=_0x5a3ae5();while(!![]){try{const _0x1cb16e=-parseInt(_0x2b0571(0x1c0))/0x1+-parseInt(_0x2b0571(0x1c5))/0x2*(-parseInt(_0x2b0571(0x1bf))/0x3)+parseInt(_0x2b0571(0x1c3))/0x4*(-parseInt(_0x2b0571(0x1b8))/0x5)+parseInt(_0x2b0571(0x1c6))/0x6*(-parseInt(_0x2b0571(0x1bb))/0x7)+-parseInt(_0x2b0571(0x1ba))/0x8+parseInt(_0x2b0571(0x1b9))/0x9*(-parseInt(_0x2b0571(0x1c2))/0xa)+parseInt(_0x2b0571(0x1bd))/0xb;if(_0x1cb16e===_0x111e41)break;else _0x305ae8['push'](_0x305ae8['shift']());}catch(_0x9410a){_0x305ae8['push'](_0x305ae8['shift']());}}}(a4_0x1311,0x2170c));function a4_0x1311(){const _0x520e0f=['message','4196NdsmYD','6066eFfMZl','stripe','1415XXPOfX','207xHgRuR','802456hofBxW','1813itLAdK','Student\x20not\x20found','8454017JorqNB','STRIPE_WEBHOOK_SECRET','111gCVosu','196640TDAdWj','Webhook\x20Error:\x20','47060PEIRRx','596rPTJxL'];a4_0x1311=function(){return _0x520e0f;};return a4_0x1311();}import{headers}from'next/headers';import{NextResponse}from'next/server';function a4_0x442c(_0x5e0583,_0x2332a9){const _0x1311b3=a4_0x1311();return a4_0x442c=function(_0x442c50,_0x88a570){_0x442c50=_0x442c50-0x1b7;let _0x283334=_0x1311b3[_0x442c50];return _0x283334;},a4_0x442c(_0x5e0583,_0x2332a9);}import a4_0x351e43 from'stripe';import{getStudentByClerkId}from'@/sanity/lib/student/getStudentByClerkId';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';import{getBundleById}from'@/sanity/lib/courses/getBundleById';const stripe=new a4_0x351e43(process['env']['STRIPE_SECRET_KEY'],{'apiVersion':'2023-10-16'}),webhookSecret=process['env'][a4_0x310cd9(0x1be)];export async function POST(_0x3d3775){const _0x3370ce=a4_0x310cd9;try{const _0x10841d=await _0x3d3775['text'](),_0x5325de=await headers(),_0x16d12a=_0x5325de['get']('stripe-signature');if(!_0x16d12a)return new NextResponse('No\x20signature\x20found',{'status':0x190});let _0x2908c8;try{_0x2908c8=stripe['webhooks']['constructEvent'](_0x10841d,_0x16d12a,webhookSecret);}catch(_0x460170){const _0x3de35b=_0x460170 instanceof Error?_0x460170[_0x3370ce(0x1c4)]:'Unknown\x20error';return console['error']('Webhook\x20signature\x20verification\x20failed:\x20'+_0x3de35b),new NextResponse(_0x3370ce(0x1c1)+_0x3de35b,{'status':0x190});}if(_0x2908c8['type']==='checkout.session.completed'){const _0xaa8c08=_0x2908c8['data']['object'],_0x3061e9=_0xaa8c08['metadata']?.['bundleId'],_0x2d5a4b=_0xaa8c08['metadata']?.['courseId'],_0x338d2b=_0xaa8c08['metadata']?.['userId'],_0x3dd41d=_0xaa8c08['metadata']?.['type'];if(!_0x338d2b)return new NextResponse('Missing\x20userId\x20in\x20metadata',{'status':0x190});const _0x2ee055=await getStudentByClerkId(_0x338d2b);if(!_0x2ee055['data'])return new NextResponse(_0x3370ce(0x1bc),{'status':0x190});if(_0x3dd41d==='bundle'&&_0x3061e9){const _0x356d22=await getBundleById(_0x3061e9);if(!_0x356d22)return new NextResponse('Bundle\x20not\x20found',{'status':0x190});return await createBundleEnrollment({'studentId':_0x2ee055['data']['_id'],'bundleId':_0x3061e9,'paymentId':_0xaa8c08['id'],'amount':_0xaa8c08['amount_total']/0x64,'paymentProvider':_0x3370ce(0x1b7),'bundleData':_0x356d22}),new NextResponse(null,{'status':0xc8});}if(_0x2d5a4b)return await createEnrollment({'studentId':_0x2ee055['data']['_id'],'courseId':_0x2d5a4b,'paymentId':_0xaa8c08['id'],'amount':_0xaa8c08['amount_total']/0x64,'paymentProvider':'stripe'}),new NextResponse(null,{'status':0xc8});return new NextResponse('Missing\x20courseId\x20or\x20bundleId\x20in\x20metadata',{'status':0x190});}return new NextResponse(null,{'status':0xc8});}catch(_0x23e5bb){return console['error']('Error\x20in\x20webhook\x20handler:',_0x23e5bb),new NextResponse('Webhook\x20handler\x20failed',{'status':0x1f4});}}