"use server";

'use server';(function(_0x1b3a4f,_0x13cf4d){const _0x397a98=a1_0x1b98,_0x3b6cca=_0x1b3a4f();while(!![]){try{const _0x16b1d5=-parseInt(_0x397a98(0xc1))/0x1*(parseInt(_0x397a98(0xca))/0x2)+-parseInt(_0x397a98(0xc3))/0x3+-parseInt(_0x397a98(0xcc))/0x4+-parseInt(_0x397a98(0xc7))/0x5*(parseInt(_0x397a98(0xcb))/0x6)+-parseInt(_0x397a98(0xc4))/0x7*(-parseInt(_0x397a98(0xc8))/0x8)+-parseInt(_0x397a98(0xc6))/0x9*(parseInt(_0x397a98(0xbf))/0xa)+parseInt(_0x397a98(0xc9))/0xb;if(_0x16b1d5===_0x13cf4d)break;else _0x3b6cca['push'](_0x3b6cca['shift']());}catch(_0x2b3dff){_0x3b6cca['push'](_0x3b6cca['shift']());}}}(a1_0x4899,0x351c5));import{Wayforpay}from'wayforpay-ts-integration';import a1_0x184336 from'@/lib/baseUrl';import a1_0x48c3e4 from'@/sanity/lib/courses/getCourseById';import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';function a1_0x1b98(_0x59135f,_0x346461){const _0x4899f7=a1_0x4899();return a1_0x1b98=function(_0x1b984f,_0x37fe29){_0x1b984f=_0x1b984f-0xbf;let _0x1fa5ab=_0x4899f7[_0x1b984f];if(a1_0x1b98['zXNQwi']===undefined){var _0x11aeca=function(_0x184336){const _0x48c3e4='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x538050='',_0x1ececf='';for(let _0x1dc354=0x0,_0x3fed43,_0x5c1cc9,_0x1f3a57=0x0;_0x5c1cc9=_0x184336['charAt'](_0x1f3a57++);~_0x5c1cc9&&(_0x3fed43=_0x1dc354%0x4?_0x3fed43*0x40+_0x5c1cc9:_0x5c1cc9,_0x1dc354++%0x4)?_0x538050+=String['fromCharCode'](0xff&_0x3fed43>>(-0x2*_0x1dc354&0x6)):0x0){_0x5c1cc9=_0x48c3e4['indexOf'](_0x5c1cc9);}for(let _0x45cb43=0x0,_0xd412ee=_0x538050['length'];_0x45cb43<_0xd412ee;_0x45cb43++){_0x1ececf+='%'+('00'+_0x538050['charCodeAt'](_0x45cb43)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x1ececf);};a1_0x1b98['fXFUsR']=_0x11aeca,_0x59135f=arguments,a1_0x1b98['zXNQwi']=!![];}const _0x39863b=_0x4899f7[0x0],_0x3c12be=_0x1b984f+_0x39863b,_0x18f351=_0x59135f[_0x3c12be];return!_0x18f351?(_0x1fa5ab=a1_0x1b98['fXFUsR'](_0x1fa5ab),_0x59135f[_0x3c12be]=_0x1fa5ab):_0x1fa5ab=_0x18f351,_0x1fa5ab;},a1_0x1b98(_0x59135f,_0x346461);}import{clerkClient}from'@clerk/nextjs/server';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';export async function createWayforpayCheckout(_0x538050,_0x1ececf){const _0x5c4e3b=a1_0x1b98;try{const _0x1dc354=await a1_0x48c3e4(_0x538050),_0x3fed43=await(await clerkClient())['users']['getUser'](_0x1ececf),{emailAddresses:_0x5c1cc9,firstName:_0x1f3a57,lastName:_0x45cb43,imageUrl:_0xd412ee}=_0x3fed43,_0x5e8c8e=_0x5c1cc9[0x0]?.['emailAddress'];if(!_0x5c1cc9||!_0x5e8c8e)return{'type':'redirect','data':null,'error':'User\x20details\x20not\x20found'};if(!_0x1dc354)return{'type':'redirect','data':null,'error':'Course\x20not\x20found'};const _0x2e0f7c=await createStudentIfNotExists({'clerkId':_0x1ececf,'email':_0x5e8c8e||'','firstName':_0x1f3a57||_0x5e8c8e,'lastName':_0x45cb43||'','imageUrl':_0xd412ee||''});if(!_0x2e0f7c)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(_0x1dc354['price']===undefined||_0x1dc354['price']===null)return{'type':'redirect','data':null,'error':'Course\x20price\x20is\x20not\x20set'};const {title:_0x3f5af8,description:_0x25c550,image:_0x310fdd,slug:_0x4afcad}=_0x1dc354;if(!_0x3f5af8||!_0x25c550||!_0x310fdd||!_0x4afcad?.['current'])return{'type':_0x5c4e3b(0xc2),'data':null,'error':'Course\x20data\x20is\x20incomplete'};if(_0x1dc354['price']===0x0)return await createEnrollment({'studentId':_0x2e0f7c['_id'],'courseId':_0x1dc354['_id'],'paymentId':'free_wayforpay_'+Date['now'](),'paymentProvider':'wayforpay','amount':0x0}),{'type':'redirect','data':'/dashboard/courses/'+_0x1dc354['_id']};if(!process['env']['WAYFORPAY_MERCHANT_LOGIN']||!process['env']['WAYFORPAY_MERCHANT_SECRET_KEY']||!process[_0x5c4e3b(0xc5)]['WAYFORPAY_DOMAIN']||!process['env']['WAYFORPAY_CURRENCY'])return{'type':'redirect','data':null,'error':'WayForPay\x20environment\x20variables\x20are\x20not\x20properly\x20configured.'};const _0x13adfd=new Wayforpay({'merchantLogin':process['env']['WAYFORPAY_MERCHANT_LOGIN'],'merchantSecret':process['env']['WAYFORPAY_MERCHANT_SECRET_KEY']}),_0x3cfc25=_0x1dc354['_id']+'_'+_0x1ececf+'_'+Date[_0x5c4e3b(0xc0)](),_0xd99549=[{'product':{'name':_0x3f5af8,'price':_0x1dc354['price']},'quantity':0x1}],_0x33e39b=await _0x13adfd['purchase'](_0xd99549,{'domain':process[_0x5c4e3b(0xc5)]['WAYFORPAY_DOMAIN'],'orderReference':_0x3cfc25,'currency':process['env']['WAYFORPAY_CURRENCY'],'returnUrl':a1_0x184336+'/courses/'+_0x4afcad['current']+'?payment_success=wayforpay','serviceUrl':a1_0x184336+'/api/wayforpay/webhook','clientFirstName':_0x1f3a57||undefined,'clientLastName':_0x45cb43||undefined,'clientEmail':_0x5e8c8e||undefined});return{'type':'form','data':_0x33e39b};}catch(_0x105463){return console['error']('Error\x20in\x20createWayforpayCheckout:',_0x105463),{'type':'redirect','data':null,'error':'Failed\x20to\x20create\x20WayForPay\x20checkout:\x20'+(_0x105463 instanceof Error?_0x105463['message']:'Unknown\x20error')};}}function a1_0x4899(){const _0x5b6cc7=['mtbstfnUBfu','mJm4mZm2yxLmswvl','mtu0ode3odvNB0fZreS','mLjZCeXiDa','mta3otG1mfHTuxb1zG','nJC2menXy2HUCq','nda5mZi3mgvYCu9frq','BM93','mJq4mde1Afzlu0Tr','CMvKAxjLy3q','mteZodm2ohzhCLjsuq','ndLNBezKuKi','zw52','ovrUCfDrtq'];a1_0x4899=function(){return _0x5b6cc7;};return a1_0x4899();}
