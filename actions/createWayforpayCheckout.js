"use server";

'use server';function a1_0x23e6(){const _0x3e02a9=['4GBpFvp','166391oUnqUU','121734KqXLbH','price','8qKUGbg','env','475139ykCgow','WAYFORPAY_MERCHANT_LOGIN','73557bWklhr','10wknqyR','914250ioxkpL','redirect','2780129guaKDK','155565QyxshX','12UjHutl'];a1_0x23e6=function(){return _0x3e02a9;};return a1_0x23e6();}(function(_0x5930f8,_0x1ad48d){const _0x37264d=a1_0x40e4,_0x61d65=_0x5930f8();while(!![]){try{const _0xde13=parseInt(_0x37264d(0x8f))/0x1+-parseInt(_0x37264d(0x9d))/0x2*(-parseInt(_0x37264d(0x96))/0x3)+parseInt(_0x37264d(0x9c))/0x4*(-parseInt(_0x37264d(0x9b))/0x5)+parseInt(_0x37264d(0x98))/0x6+parseInt(_0x37264d(0x94))/0x7*(parseInt(_0x37264d(0x92))/0x8)+parseInt(_0x37264d(0x90))/0x9+parseInt(_0x37264d(0x97))/0xa*(-parseInt(_0x37264d(0x9a))/0xb);if(_0xde13===_0x1ad48d)break;else _0x61d65['push'](_0x61d65['shift']());}catch(_0x383025){_0x61d65['push'](_0x61d65['shift']());}}}(a1_0x23e6,0x192d9));function a1_0x40e4(_0x46c519,_0x363994){const _0x23e683=a1_0x23e6();return a1_0x40e4=function(_0x40e48c,_0x4f944a){_0x40e48c=_0x40e48c-0x8f;let _0x2ac22e=_0x23e683[_0x40e48c];return _0x2ac22e;},a1_0x40e4(_0x46c519,_0x363994);}import{Wayforpay}from'wayforpay-ts-integration';import a1_0x1e37ad from'@/lib/baseUrl';import a1_0x5a74b7 from'@/sanity/lib/courses/getCourseById';import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';import{clerkClient}from'@clerk/nextjs/server';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';export async function createWayforpayCheckout(_0x3d82e4,_0x299bbd){const _0x6c76c9=a1_0x40e4;try{const _0x43da71=await a1_0x5a74b7(_0x3d82e4),_0xdaa468=await(await clerkClient())['users']['getUser'](_0x299bbd),{emailAddresses:_0x159945,firstName:_0x2288e6,lastName:_0x257f4d,imageUrl:_0x5ee6ee}=_0xdaa468,_0x23edca=_0x159945[0x0]?.['emailAddress'];if(!_0x159945||!_0x23edca)return{'type':'redirect','data':null,'error':'User\x20details\x20not\x20found'};if(!_0x43da71)return{'type':'redirect','data':null,'error':'Course\x20not\x20found'};const _0x191325=await createStudentIfNotExists({'clerkId':_0x299bbd,'email':_0x23edca||'','firstName':_0x2288e6||_0x23edca,'lastName':_0x257f4d||'','imageUrl':_0x5ee6ee||''});if(!_0x191325)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(_0x43da71['price']===undefined||_0x43da71['price']===null)return{'type':'redirect','data':null,'error':'Course\x20price\x20is\x20not\x20set'};const {title:_0x3f2f4e,description:_0x18f771,image:_0x1983ff,slug:_0x19f24f}=_0x43da71;if(!_0x3f2f4e||!_0x18f771||!_0x1983ff||!_0x19f24f?.['current'])return{'type':'redirect','data':null,'error':'Course\x20data\x20is\x20incomplete'};if(_0x43da71['price']===0x0)return await createEnrollment({'studentId':_0x191325['_id'],'courseId':_0x43da71['_id'],'paymentId':'free_wayforpay_'+Date['now'](),'paymentProvider':'wayforpay','amount':0x0}),{'type':_0x6c76c9(0x99),'data':'/dashboard/courses/'+_0x43da71['_id']};if(!process['env'][_0x6c76c9(0x95)]||!process['env']['WAYFORPAY_MERCHANT_SECRET_KEY']||!process['env']['WAYFORPAY_DOMAIN']||!process['env']['WAYFORPAY_CURRENCY'])return{'type':'redirect','data':null,'error':'WayForPay environment variables are not properly configured.'};const _0x201da2=new Wayforpay({'merchantLogin':process[_0x6c76c9(0x93)]['WAYFORPAY_MERCHANT_LOGIN'],'merchantSecret':process['env']['WAYFORPAY_MERCHANT_SECRET_KEY']}),_0x5a08cd=_0x43da71['_id']+'_'+_0x299bbd+'_'+Date['now'](),_0x3dd052=[{'product':{'name':_0x3f2f4e,'price':_0x43da71[_0x6c76c9(0x91)]},'quantity':0x1}],_0x5820da=await _0x201da2['purchase'](_0x3dd052,{'domain':process['env']['WAYFORPAY_DOMAIN'],'orderReference':_0x5a08cd,'currency':process[_0x6c76c9(0x93)]['WAYFORPAY_CURRENCY'],'returnUrl':a1_0x1e37ad+'/courses/'+_0x19f24f['current']+'?payment_success=wayforpay','serviceUrl':a1_0x1e37ad+'/api/wayforpay/webhook','clientFirstName':_0x2288e6||undefined,'clientLastName':_0x257f4d||undefined,'clientEmail':_0x23edca||undefined});return{'type':'form','data':_0x5820da};}catch(_0x47428f){return console['error']('Error\x20in\x20createWayforpayCheckout:',_0x47428f),{'type':_0x6c76c9(0x99),'data':null,'error':'Failed\x20to\x20create\x20WayForPay\x20checkout:\x20'+(_0x47428f instanceof Error?_0x47428f['message']:'Unknown\x20error')};}}
