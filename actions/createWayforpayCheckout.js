"use server";

'use server';(function(_0x32bd8a,_0x570b27){const _0x2d59c1=a3_0x2e83,_0x5d28f2=_0x32bd8a();while(!![]){try{const _0x4e5ab1=-parseInt(_0x2d59c1(0x108))/0x1*(-parseInt(_0x2d59c1(0x109))/0x2)+-parseInt(_0x2d59c1(0x100))/0x3*(parseInt(_0x2d59c1(0x105))/0x4)+-parseInt(_0x2d59c1(0x10c))/0x5+-parseInt(_0x2d59c1(0x101))/0x6+-parseInt(_0x2d59c1(0x102))/0x7*(parseInt(_0x2d59c1(0x107))/0x8)+parseInt(_0x2d59c1(0x10a))/0x9+parseInt(_0x2d59c1(0xff))/0xa*(parseInt(_0x2d59c1(0x106))/0xb);if(_0x4e5ab1===_0x570b27)break;else _0x5d28f2['push'](_0x5d28f2['shift']());}catch(_0x292789){_0x5d28f2['push'](_0x5d28f2['shift']());}}}(a3_0x153c,0x3eeeb));function a3_0x153c(){const _0x4f4dd0=['184hOgKXk','218339IboKPf','104yavfql','29xUMEiG','8480KNPVSW','1620414zqCBlv','redirect','942280DEpdIm','free_wayforpay_','260KzAqCx','16158PlZfHb','603162SZndTe','13230AqEQHP','_id','WAYFORPAY_DOMAIN'];a3_0x153c=function(){return _0x4f4dd0;};return a3_0x153c();}function a3_0x2e83(_0x53ac0c,_0xff94f1){const _0x153cf8=a3_0x153c();return a3_0x2e83=function(_0x2e83a7,_0x38545b){_0x2e83a7=_0x2e83a7-0xff;let _0x4c05dc=_0x153cf8[_0x2e83a7];return _0x4c05dc;},a3_0x2e83(_0x53ac0c,_0xff94f1);}import{Wayforpay}from'wayforpay-ts-integration';import a3_0x3777c3 from'@/lib/baseUrl';import a3_0x401fc0 from'@/sanity/lib/courses/getCourseById';import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';import{clerkClient}from'@clerk/nextjs/server';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';export async function createWayforpayCheckout(_0x5ef3f6,_0xb0c011){const _0x303652=a3_0x2e83;try{const [_0x2905e8,_0x46e3d9]=await Promise['all']([a3_0x401fc0(_0x5ef3f6),(await clerkClient())['users']['getUser'](_0xb0c011)]),{emailAddresses:_0x5a531f,firstName:_0x16a5d5,lastName:_0x8e8bb5,imageUrl:_0x1503b0}=_0x46e3d9,_0x4728e0=_0x5a531f[0x0]?.['emailAddress'];if(!_0x5a531f||!_0x4728e0)return{'type':'redirect','data':null,'error':'User\x20details\x20not\x20found'};if(!_0x2905e8)return{'type':_0x303652(0x10b),'data':null,'error':'Course\x20not\x20found'};const _0x83c4a5=await createStudentIfNotExists({'clerkId':_0xb0c011,'email':_0x4728e0||'','firstName':_0x16a5d5||_0x4728e0,'lastName':_0x8e8bb5||'','imageUrl':_0x1503b0||''});if(!_0x83c4a5)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(_0x2905e8['price']===undefined||_0x2905e8['price']===null)return{'type':'redirect','data':null,'error':'Course\x20price\x20is\x20not\x20set'};const {title:_0x4dcbd7,description:_0xe9c4ab,image:_0x12623f,slug:_0x3948bf}=_0x2905e8;if(!_0x4dcbd7||!_0xe9c4ab||!_0x12623f||!_0x3948bf?.['current'])return{'type':'redirect','data':null,'error':'Course\x20data\x20is\x20incomplete'};if(_0x2905e8['price']===0x0)return await createEnrollment({'studentId':_0x83c4a5['_id'],'courseId':_0x2905e8['_id'],'paymentId':_0x303652(0x10d)+Date['now'](),'paymentProvider':'wayforpay','amount':0x0}),{'type':'redirect','data':'/dashboard/courses/'+_0x2905e8[_0x303652(0x103)]};const _0x5e0e46={'merchantLogin':process['env']['WAYFORPAY_MERCHANT_LOGIN'],'merchantSecret':process['env']['WAYFORPAY_MERCHANT_SECRET_KEY'],'domain':process['env'][_0x303652(0x104)],'currency':process['env']['WAYFORPAY_CURRENCY']};if(!_0x5e0e46['merchantLogin']||!_0x5e0e46['merchantSecret']||!_0x5e0e46['domain']||!_0x5e0e46['currency'])return{'type':'redirect','data':null,'error':'WayForPay environment variables are not properly configured.'};const _0x2c77b5=_0x2905e8['_id']+'--'+_0xb0c011+'--'+Date['now'](),_0x30d9c6=[{'product':{'name':_0x4dcbd7,'price':_0x2905e8['price']},'quantity':0x1}],_0x4905ed=new Wayforpay({'merchantLogin':_0x5e0e46['merchantLogin'],'merchantSecret':_0x5e0e46['merchantSecret']}),_0x4763bd=await _0x4905ed['purchase'](_0x30d9c6,{'domain':_0x5e0e46['domain'],'orderReference':_0x2c77b5,'currency':_0x5e0e46['currency'],'returnUrl':a3_0x3777c3+'/payment/redirect?provider=wayforpay&type=course&order='+_0x2c77b5,'serviceUrl':a3_0x3777c3+'/api/wayforpay/webhook','clientFirstName':_0x16a5d5||undefined,'clientLastName':_0x8e8bb5||undefined,'clientEmail':_0x4728e0||undefined});return{'type':'form','data':_0x4763bd};}catch(_0x2802e9){return console['error']('Error\x20in\x20createWayforpayCheckout:',_0x2802e9),{'type':'redirect','data':null,'error':'Failed\x20to\x20create\x20WayForPay\x20checkout:\x20'+(_0x2802e9 instanceof Error?_0x2802e9['message']:'Unknown\x20error')};}}
