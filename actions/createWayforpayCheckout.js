"use server";

'use server';(function(_0x34eced,_0x2d2270){const _0x270d18=a3_0xccdb,_0x3db215=_0x34eced();while(!![]){try{const _0x187b85=parseInt(_0x270d18(0x6d))/0x1+parseInt(_0x270d18(0x75))/0x2*(-parseInt(_0x270d18(0x6b))/0x3)+-parseInt(_0x270d18(0x72))/0x4*(parseInt(_0x270d18(0x74))/0x5)+-parseInt(_0x270d18(0x6e))/0x6+parseInt(_0x270d18(0x70))/0x7+parseInt(_0x270d18(0x6f))/0x8*(parseInt(_0x270d18(0x73))/0x9)+-parseInt(_0x270d18(0x6a))/0xa;if(_0x187b85===_0x2d2270)break;else _0x3db215['push'](_0x3db215['shift']());}catch(_0x2c353b){_0x3db215['push'](_0x3db215['shift']());}}}(a3_0x5786,0x28df4));function a3_0x5786(){const _0x59a5bb=['2322OaWnuz','146795wXOubF','22hNiccr','now','users','1635880KZgkxC','49863aAKPjG','wayforpay','266774epbKWg','62814kmFLMF','8992gXPvKy','389277RHbqXm','env','12dWEQfE'];a3_0x5786=function(){return _0x59a5bb;};return a3_0x5786();}import{Wayforpay}from'wayforpay-ts-integration';import a3_0x35e9b0 from'@/lib/baseUrl';import a3_0x5cb3ab from'@/sanity/lib/courses/getCourseById';import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';import{clerkClient}from'@clerk/nextjs/server';function a3_0xccdb(_0x54fd5f,_0x412001){const _0x578677=a3_0x5786();return a3_0xccdb=function(_0xccdb1a,_0x2bf88c){_0xccdb1a=_0xccdb1a-0x69;let _0x3641c5=_0x578677[_0xccdb1a];return _0x3641c5;},a3_0xccdb(_0x54fd5f,_0x412001);}import{createEnrollment}from'@/sanity/lib/student/createEnrollment';export async function createWayforpayCheckout(_0x3552a8,_0x43a62c){const _0x15c10b=a3_0xccdb;try{const [_0x365aba,_0x5e2b8c]=await Promise['all']([a3_0x5cb3ab(_0x3552a8),(await clerkClient())[_0x15c10b(0x69)]['getUser'](_0x43a62c)]),{emailAddresses:_0x28dda1,firstName:_0x3cde8e,lastName:_0xc3fd1a,imageUrl:_0x1b9e8a}=_0x5e2b8c,_0x1bb716=_0x28dda1[0x0]?.['emailAddress'];if(!_0x28dda1||!_0x1bb716)return{'type':'redirect','data':null,'error':'User\x20details\x20not\x20found'};if(!_0x365aba)return{'type':'redirect','data':null,'error':'Course\x20not\x20found'};const _0xa1e861=await createStudentIfNotExists({'clerkId':_0x43a62c,'email':_0x1bb716||'','firstName':_0x3cde8e||_0x1bb716,'lastName':_0xc3fd1a||'','imageUrl':_0x1b9e8a||''});if(!_0xa1e861)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(_0x365aba['price']===undefined||_0x365aba['price']===null)return{'type':'redirect','data':null,'error':'Course\x20price\x20is\x20not\x20set'};const {title:_0x119cb9,description:_0xc7e6f6,image:_0x220122,slug:_0x13f2c8}=_0x365aba;if(!_0x119cb9||!_0xc7e6f6||!_0x220122||!_0x13f2c8?.['current'])return{'type':'redirect','data':null,'error':'Course\x20data\x20is\x20incomplete'};if(_0x365aba['price']===0x0)return await createEnrollment({'studentId':_0xa1e861['_id'],'courseId':_0x365aba['_id'],'paymentId':'free_wayforpay_'+Date[_0x15c10b(0x76)](),'paymentProvider':_0x15c10b(0x6c),'amount':0x0}),{'type':'redirect','data':'/dashboard/courses/'+_0x365aba['_id']};const _0x243f6f={'merchantLogin':process['env']['WAYFORPAY_MERCHANT_LOGIN'],'merchantSecret':process['env']['WAYFORPAY_MERCHANT_SECRET_KEY'],'domain':process['env']['WAYFORPAY_DOMAIN'],'currency':process[_0x15c10b(0x71)]['WAYFORPAY_CURRENCY']};if(!_0x243f6f['merchantLogin']||!_0x243f6f['merchantSecret']||!_0x243f6f['domain']||!_0x243f6f['currency'])return{'type':'redirect','data':null,'error':'WayForPay environment variables are not properly configured.'};const _0x452df6=_0x365aba['_id']+'--'+_0x43a62c+'--'+Date['now'](),_0x5bc38f=[{'product':{'name':_0x119cb9,'price':_0x365aba['price']},'quantity':0x1}],_0x154f6d=new Wayforpay({'merchantLogin':_0x243f6f['merchantLogin'],'merchantSecret':_0x243f6f['merchantSecret']}),_0x5b886f=await _0x154f6d['purchase'](_0x5bc38f,{'domain':_0x243f6f['domain'],'orderReference':_0x452df6,'currency':_0x243f6f['currency'],'returnUrl':a3_0x35e9b0+'/payment/redirect?provider=wayforpay&type=course&order='+_0x452df6,'serviceUrl':a3_0x35e9b0+'/api/wayforpay/webhook','clientFirstName':_0x3cde8e||undefined,'clientLastName':_0xc3fd1a||undefined,'clientEmail':_0x1bb716||undefined});return{'type':'form','data':_0x5b886f};}catch(_0x89c9f4){return console['error']('Error\x20in\x20createWayforpayCheckout:',_0x89c9f4),{'type':'redirect','data':null,'error':'Failed\x20to\x20create\x20WayForPay\x20checkout:\x20'+(_0x89c9f4 instanceof Error?_0x89c9f4['message']:'Unknown\x20error')};}}
