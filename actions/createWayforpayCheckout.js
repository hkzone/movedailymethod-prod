"use server";

'use server';(function(_0x230ad7,_0x348656){const _0x4e08b1=a1_0x5564,_0xf27aa6=_0x230ad7();while(!![]){try{const _0x10da2e=parseInt(_0x4e08b1(0x1e1))/0x1*(parseInt(_0x4e08b1(0x1d8))/0x2)+-parseInt(_0x4e08b1(0x1d7))/0x3+-parseInt(_0x4e08b1(0x1dc))/0x4+-parseInt(_0x4e08b1(0x1e2))/0x5*(parseInt(_0x4e08b1(0x1dd))/0x6)+-parseInt(_0x4e08b1(0x1d9))/0x7+parseInt(_0x4e08b1(0x1df))/0x8+parseInt(_0x4e08b1(0x1db))/0x9;if(_0x10da2e===_0x348656)break;else _0xf27aa6['push'](_0xf27aa6['shift']());}catch(_0x1d1f11){_0xf27aa6['push'](_0xf27aa6['shift']());}}}(a1_0x9a71,0x61455));import{Wayforpay}from'wayforpay-ts-integration';import a1_0x28b10e from'@/lib/baseUrl';import a1_0xf28407 from'@/sanity/lib/courses/getCourseById';import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';import{clerkClient}from'@clerk/nextjs/server';function a1_0x5564(_0x2f43e5,_0x3b8a6b){const _0x9a7176=a1_0x9a71();return a1_0x5564=function(_0x556452,_0x2dc19d){_0x556452=_0x556452-0x1d6;let _0x19abf6=_0x9a7176[_0x556452];return _0x19abf6;},a1_0x5564(_0x2f43e5,_0x3b8a6b);}import{createEnrollment}from'@/sanity/lib/student/createEnrollment';function a1_0x9a71(){const _0x236740=['4yXtcWE','669690dlaNfK','_id','10021293zQnIjz','2121496lpTIAT','68682tdFypg','users','4912360derYkf','env','212767wgDnoE','215LNwJrW','wayforpay','1909110oOpcdR'];a1_0x9a71=function(){return _0x236740;};return a1_0x9a71();}export async function createWayforpayCheckout(_0x6be7df,_0x5edf83){const _0x2ea135=a1_0x5564;try{const _0x5d5644=await a1_0xf28407(_0x6be7df),_0x25e9a4=await(await clerkClient())[_0x2ea135(0x1de)]['getUser'](_0x5edf83),{emailAddresses:_0x41d36c,firstName:_0x355f99,lastName:_0x40993f,imageUrl:_0x191049}=_0x25e9a4,_0x47aac4=_0x41d36c[0x0]?.['emailAddress'];if(!_0x41d36c||!_0x47aac4)return{'type':'redirect','data':null,'error':'User\x20details\x20not\x20found'};if(!_0x5d5644)return{'type':'redirect','data':null,'error':'Course\x20not\x20found'};const _0x35314e=await createStudentIfNotExists({'clerkId':_0x5edf83,'email':_0x47aac4||'','firstName':_0x355f99||_0x47aac4,'lastName':_0x40993f||'','imageUrl':_0x191049||''});if(!_0x35314e)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(_0x5d5644['price']===undefined||_0x5d5644['price']===null)return{'type':'redirect','data':null,'error':'Course\x20price\x20is\x20not\x20set'};const {title:_0x254daf,description:_0x3ec357,image:_0x1183ba,slug:_0x85b0cd}=_0x5d5644;if(!_0x254daf||!_0x3ec357||!_0x1183ba||!_0x85b0cd?.['current'])return{'type':'redirect','data':null,'error':'Course\x20data\x20is\x20incomplete'};if(_0x5d5644['price']===0x0)return await createEnrollment({'studentId':_0x35314e['_id'],'courseId':_0x5d5644['_id'],'paymentId':'free_wayforpay_'+Date['now'](),'paymentProvider':_0x2ea135(0x1d6),'amount':0x0}),{'type':'redirect','data':'/dashboard/courses/'+_0x5d5644[_0x2ea135(0x1da)]};if(!process[_0x2ea135(0x1e0)]['WAYFORPAY_MERCHANT_LOGIN']||!process['env']['WAYFORPAY_MERCHANT_SECRET_KEY']||!process['env']['WAYFORPAY_DOMAIN']||!process['env']['WAYFORPAY_CURRENCY'])return{'type':'redirect','data':null,'error':'WayForPay environment variables are not properly configured.'};const _0x182332=new Wayforpay({'merchantLogin':process['env']['WAYFORPAY_MERCHANT_LOGIN'],'merchantSecret':process[_0x2ea135(0x1e0)]['WAYFORPAY_MERCHANT_SECRET_KEY']}),_0x275eae=_0x5d5644['_id']+'_'+_0x5edf83+'_'+Date['now'](),_0x5f217d=[{'product':{'name':_0x254daf,'price':_0x5d5644['price']},'quantity':0x1}],_0x3125cc=await _0x182332['purchase'](_0x5f217d,{'domain':process['env']['WAYFORPAY_DOMAIN'],'orderReference':_0x275eae,'currency':process['env']['WAYFORPAY_CURRENCY'],'returnUrl':a1_0x28b10e+'/courses/'+_0x85b0cd['current']+'?payment_success=wayforpay','serviceUrl':a1_0x28b10e+'/api/wayforpay/webhook','clientFirstName':_0x355f99||undefined,'clientLastName':_0x40993f||undefined,'clientEmail':_0x47aac4||undefined});return{'type':'form','data':_0x3125cc};}catch(_0x13bd15){return console['error']('Error\x20in\x20createWayforpayCheckout:',_0x13bd15),{'type':'redirect','data':null,'error':'Failed\x20to\x20create\x20WayForPay\x20checkout:\x20'+(_0x13bd15 instanceof Error?_0x13bd15['message']:'Unknown\x20error')};}}
