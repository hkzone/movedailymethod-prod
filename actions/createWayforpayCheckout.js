"use server";

'use server';function a3_0x576e(){const _0x31d3c2=['_id','24kFwTji','528018pxgqPC','User\x20details\x20not\x20found','env','2861663bfAkUU','530829IYOwDO','685830smKaZs','40RiDxZg','35405iJFJgt','8jLnfAd','2807568jZkpYT','216SMrPAq','1750001ZLHYXY','1tDDJXG','redirect'];a3_0x576e=function(){return _0x31d3c2;};return a3_0x576e();}(function(_0x3717d9,_0x19c27a){const _0x3064f6=a3_0x2d8e,_0x31b6f1=_0x3717d9();while(!![]){try{const _0x5e87c4=-parseInt(_0x3064f6(0x130))/0x1*(parseInt(_0x3064f6(0x129))/0x2)+-parseInt(_0x3064f6(0x134))/0x3*(parseInt(_0x3064f6(0x12c))/0x4)+parseInt(_0x3064f6(0x12b))/0x5*(-parseInt(_0x3064f6(0x12e))/0x6)+parseInt(_0x3064f6(0x137))/0x7+parseInt(_0x3064f6(0x12d))/0x8+-parseInt(_0x3064f6(0x138))/0x9*(-parseInt(_0x3064f6(0x12a))/0xa)+parseInt(_0x3064f6(0x12f))/0xb*(parseInt(_0x3064f6(0x133))/0xc);if(_0x5e87c4===_0x19c27a)break;else _0x31b6f1['push'](_0x31b6f1['shift']());}catch(_0x21ea3f){_0x31b6f1['push'](_0x31b6f1['shift']());}}}(a3_0x576e,0x58df2));import{Wayforpay}from'wayforpay-ts-integration';import a3_0x47c3a3 from'@/lib/baseUrl';import a3_0x49e63c from'@/sanity/lib/courses/getCourseById';import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';import{clerkClient}from'@clerk/nextjs/server';function a3_0x2d8e(_0x3693a0,_0x152ef9){const _0x576eda=a3_0x576e();return a3_0x2d8e=function(_0x2d8ec5,_0x39cdf2){_0x2d8ec5=_0x2d8ec5-0x129;let _0x2ee4db=_0x576eda[_0x2d8ec5];return _0x2ee4db;},a3_0x2d8e(_0x3693a0,_0x152ef9);}import{createEnrollment}from'@/sanity/lib/student/createEnrollment';export async function createWayforpayCheckout(_0x2e0d58,_0x46b1b0){const _0x596fe5=a3_0x2d8e;try{const [_0x58901f,_0x677291]=await Promise['all']([a3_0x49e63c(_0x2e0d58),(await clerkClient())['users']['getUser'](_0x46b1b0)]),{emailAddresses:_0x213d6e,firstName:_0x48e95e,lastName:_0x31aa22,imageUrl:_0x51488e}=_0x677291,_0x1823b1=_0x213d6e[0x0]?.['emailAddress'];if(!_0x213d6e||!_0x1823b1)return{'type':'redirect','data':null,'error':_0x596fe5(0x135)};if(!_0x58901f)return{'type':'redirect','data':null,'error':'Course\x20not\x20found'};const _0x4f1976=await createStudentIfNotExists({'clerkId':_0x46b1b0,'email':_0x1823b1||'','firstName':_0x48e95e||_0x1823b1,'lastName':_0x31aa22||'','imageUrl':_0x51488e||''});if(!_0x4f1976)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(_0x58901f['price']===undefined||_0x58901f['price']===null)return{'type':_0x596fe5(0x131),'data':null,'error':'Course\x20price\x20is\x20not\x20set'};const {title:_0xe04917,description:_0x394846,image:_0xbcd2a2,slug:_0x17b4e3}=_0x58901f;if(!_0xe04917||!_0x394846||!_0xbcd2a2||!_0x17b4e3?.['current'])return{'type':'redirect','data':null,'error':'Course\x20data\x20is\x20incomplete'};if(_0x58901f['price']===0x0)return await createEnrollment({'studentId':_0x4f1976[_0x596fe5(0x132)],'courseId':_0x58901f['_id'],'paymentId':'free_wayforpay_'+Date['now'](),'paymentProvider':'wayforpay','amount':0x0}),{'type':'redirect','data':'/dashboard/courses/'+_0x58901f['_id']};const _0x5c86bd={'merchantLogin':process['env']['WAYFORPAY_MERCHANT_LOGIN'],'merchantSecret':process['env']['WAYFORPAY_MERCHANT_SECRET_KEY'],'domain':process[_0x596fe5(0x136)]['WAYFORPAY_DOMAIN'],'currency':process['env']['WAYFORPAY_CURRENCY']};if(!_0x5c86bd['merchantLogin']||!_0x5c86bd['merchantSecret']||!_0x5c86bd['domain']||!_0x5c86bd['currency'])return{'type':'redirect','data':null,'error':'WayForPay environment variables are not properly configured.'};const _0x339ebc=_0x58901f['_id']+'--'+_0x46b1b0+'--'+Date['now'](),_0x1cd9ee=[{'product':{'name':_0xe04917,'price':_0x58901f['price']},'quantity':0x1}],_0x47b5ec=new Wayforpay({'merchantLogin':_0x5c86bd['merchantLogin'],'merchantSecret':_0x5c86bd['merchantSecret']}),_0x55c40d=await _0x47b5ec['purchase'](_0x1cd9ee,{'domain':_0x5c86bd['domain'],'orderReference':_0x339ebc,'currency':_0x5c86bd['currency'],'returnUrl':a3_0x47c3a3+'/payment/redirect?provider=wayforpay&type=course&order='+_0x339ebc,'serviceUrl':a3_0x47c3a3+'/api/wayforpay/webhook','clientFirstName':_0x48e95e||undefined,'clientLastName':_0x31aa22||undefined,'clientEmail':_0x1823b1||undefined});return{'type':'form','data':_0x55c40d};}catch(_0x376b72){return console['error']('Error\x20in\x20createWayforpayCheckout:',_0x376b72),{'type':'redirect','data':null,'error':'Failed\x20to\x20create\x20WayForPay\x20checkout:\x20'+(_0x376b72 instanceof Error?_0x376b72['message']:'Unknown\x20error')};}}
