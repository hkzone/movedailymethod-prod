"use server";

'use server';function a0_0x1277(_0x41f9da,_0x3152b9){const _0x1d739f=a0_0x1d73();return a0_0x1277=function(_0x127768,_0x151749){_0x127768=_0x127768-0xcf;let _0x4071bc=_0x1d739f[_0x127768];return _0x4071bc;},a0_0x1277(_0x41f9da,_0x3152b9);}(function(_0xd7b01,_0x478246){const _0x13f281=a0_0x1277,_0x3d87bc=_0xd7b01();while(!![]){try{const _0xb67020=-parseInt(_0x13f281(0xd8))/0x1*(-parseInt(_0x13f281(0xd3))/0x2)+parseInt(_0x13f281(0xd0))/0x3*(-parseInt(_0x13f281(0xd6))/0x4)+-parseInt(_0x13f281(0xd4))/0x5+-parseInt(_0x13f281(0xda))/0x6*(parseInt(_0x13f281(0xdd))/0x7)+-parseInt(_0x13f281(0xd5))/0x8+parseInt(_0x13f281(0xd7))/0x9*(parseInt(_0x13f281(0xcf))/0xa)+parseInt(_0x13f281(0xd2))/0xb*(parseInt(_0x13f281(0xde))/0xc);if(_0xb67020===_0x478246)break;else _0x3d87bc['push'](_0x3d87bc['shift']());}catch(_0x2a68ff){_0x3d87bc['push'](_0x3d87bc['shift']());}}}(a0_0x1d73,0x6fe89));import a0_0x182d29 from'@/lib/stripe';import a0_0x4a6ba4 from'@/lib/baseUrl';function a0_0x1d73(){const _0x23bf78=['984144bGaypU','9SIFJDK','219ksolSt','redirect','498252NTtDxZ','price','url','7XoExkQ','13743732ZIpAeq','7245330ronFSN','6bGxhhy','emailAddress','11QDHSzX','2188eUgqPe','4220135ZUJeeH','1855296dktIJI'];a0_0x1d73=function(){return _0x23bf78;};return a0_0x1d73();}import{urlFor}from'@/sanity/lib/image';import{getBundleById}from'@/sanity/lib/courses/getBundleById';import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';import{clerkClient}from'@clerk/nextjs/server';import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';export async function createBundleCheckout(_0x8e6506,_0x38b6f6){const _0x49d6a4=a0_0x1277;try{const _0x44456c=await getBundleById(_0x8e6506),_0x2d3618=await(await clerkClient())['users']['getUser'](_0x38b6f6),{emailAddresses:_0x2ad03f,firstName:_0x5dc632,lastName:_0x1b8312,imageUrl:_0x296d41}=_0x2d3618,_0x3e3064=_0x2ad03f[0x0]?.[_0x49d6a4(0xd1)];if(!_0x2ad03f||!_0x3e3064)return{'type':'redirect','data':null,'error':'User\x20details\x20not\x20found'};if(!_0x44456c)return{'type':'redirect','data':null,'error':'Bundle\x20not\x20found'};const _0x448eef=await createStudentIfNotExists({'clerkId':_0x38b6f6,'email':_0x3e3064||'','firstName':_0x5dc632||_0x3e3064,'lastName':_0x1b8312||'','imageUrl':_0x296d41||''});if(!_0x448eef)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(!_0x44456c['price']===undefined||_0x44456c['price']===null)return{'type':_0x49d6a4(0xd9),'data':null,'error':'Bundle\x20price\x20is\x20not\x20set'};const {title:_0x315633,description:_0x37fd45,backgroundImage:_0x5ab42d,slug:_0x428205}=_0x44456c;if(!_0x315633||!_0x37fd45||!_0x428205)return{'type':'redirect','data':null,'error':'Bundle\x20data\x20is\x20incomplete'};if(_0x44456c[_0x49d6a4(0xdb)]===0x0)return await createBundleEnrollment({'studentId':_0x448eef['_id'],'bundleId':_0x44456c['_id'],'paymentId':'free_stripe_bundle_'+Date['now'](),'paymentProvider':'stripe','amount':0x0,'bundleData':_0x44456c}),{'type':'redirect','data':'/my-courses'};const _0x306b84=Math['round'](_0x44456c['price']*0x64),_0x1745f9=await a0_0x182d29['checkout']['sessions']['create']({'line_items':[{'price_data':{'currency':'usd','product_data':{'name':_0x315633+'\x20-\x20Course\x20Bundle','description':_0x37fd45,'images':_0x5ab42d?[urlFor(_0x5ab42d)['url']()||'']:[]},'unit_amount':_0x306b84},'quantity':0x1}],'mode':'payment','success_url':a0_0x4a6ba4+'/payment/success?payment_success=stripe&type=bundle','cancel_url':a0_0x4a6ba4+'/payment/failed?provider=stripe&type=bundle&reason=Payment\x20cancelled\x20by\x20user','metadata':{'bundleId':_0x44456c['_id'],'userId':_0x38b6f6,'sanityStudentId':_0x448eef['_id'],'type':'bundle'}});if(!_0x1745f9[_0x49d6a4(0xdc)])return{'type':'url','data':null,'error':'Could\x20not\x20create\x20Stripe\x20session\x20URL.'};return{'type':'url','data':_0x1745f9['url']};}catch(_0xa35286){return console['error']('Error\x20in\x20createBundleCheckout:',_0xa35286),{'type':'redirect','data':null,'error':'Failed\x20to\x20create\x20Stripe\x20checkout\x20session:\x20'+(_0xa35286 instanceof Error?_0xa35286['message']:'Unknown\x20error')};}}
