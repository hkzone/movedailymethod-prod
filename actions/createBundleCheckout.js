"use server";

'use server';(function(_0x2a31fa,_0x2b929d){const _0x48afbc=a0_0x4e4f,_0x6511c9=_0x2a31fa();while(!![]){try{const _0x3a3df8=-parseInt(_0x48afbc(0x1df))/0x1+-parseInt(_0x48afbc(0x1d7))/0x2*(-parseInt(_0x48afbc(0x1da))/0x3)+parseInt(_0x48afbc(0x1db))/0x4+parseInt(_0x48afbc(0x1e0))/0x5*(-parseInt(_0x48afbc(0x1d8))/0x6)+parseInt(_0x48afbc(0x1e2))/0x7+parseInt(_0x48afbc(0x1e1))/0x8+-parseInt(_0x48afbc(0x1d9))/0x9;if(_0x3a3df8===_0x2b929d)break;else _0x6511c9['push'](_0x6511c9['shift']());}catch(_0x146c55){_0x6511c9['push'](_0x6511c9['shift']());}}}(a0_0x5b7c,0x8d09e));import a0_0x383957 from'@/lib/stripe';function a0_0x5b7c(){const _0x4fbf8c=['2945440lkDzsD','7125888OBkYiD','2sERPUi','12vECPVn','20972421ZIuMno','3320652lCXdWS','4538048ElAnZg','round','url','Unknown\x20error','598865gfTKjw','301830TlNarw'];a0_0x5b7c=function(){return _0x4fbf8c;};return a0_0x5b7c();}import a0_0x28ae94 from'@/lib/baseUrl';function a0_0x4e4f(_0x17384f,_0x3210f9){const _0x5b7c7f=a0_0x5b7c();return a0_0x4e4f=function(_0x4e4f62,_0x36df4c){_0x4e4f62=_0x4e4f62-0x1d7;let _0x5985e3=_0x5b7c7f[_0x4e4f62];return _0x5985e3;},a0_0x4e4f(_0x17384f,_0x3210f9);}import{urlFor}from'@/sanity/lib/image';import{getBundleById}from'@/sanity/lib/courses/getBundleById';import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';import{clerkClient}from'@clerk/nextjs/server';import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';export async function createBundleCheckout(_0x7d44ec,_0x35f74b){const _0x373798=a0_0x4e4f;try{const _0xf52733=await getBundleById(_0x7d44ec),_0xb8983c=await(await clerkClient())['users']['getUser'](_0x35f74b),{emailAddresses:_0x1bb476,firstName:_0x157e97,lastName:_0x14e024,imageUrl:_0x5b0946}=_0xb8983c,_0x27d8ba=_0x1bb476[0x0]?.['emailAddress'];if(!_0x1bb476||!_0x27d8ba)return{'type':'redirect','data':null,'error':'User\x20details\x20not\x20found'};if(!_0xf52733)return{'type':'redirect','data':null,'error':'Bundle\x20not\x20found'};const _0x2f586a=await createStudentIfNotExists({'clerkId':_0x35f74b,'email':_0x27d8ba||'','firstName':_0x157e97||_0x27d8ba,'lastName':_0x14e024||'','imageUrl':_0x5b0946||''});if(!_0x2f586a)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(!_0xf52733['price']===undefined||_0xf52733['price']===null)return{'type':'redirect','data':null,'error':'Bundle\x20price\x20is\x20not\x20set'};const {title:_0xb1f19a,description:_0x6a817f,backgroundImage:_0x295ade,slug:_0x237316}=_0xf52733;if(!_0xb1f19a||!_0x6a817f||!_0x237316)return{'type':'redirect','data':null,'error':'Bundle\x20data\x20is\x20incomplete'};if(_0xf52733['price']===0x0)return await createBundleEnrollment({'studentId':_0x2f586a['_id'],'bundleId':_0xf52733['_id'],'paymentId':'free_stripe_bundle_'+Date['now'](),'paymentProvider':'stripe','amount':0x0,'bundleData':_0xf52733}),{'type':'redirect','data':'/my-courses'};const _0x3697d7=Math[_0x373798(0x1dc)](_0xf52733['price']*0x64),_0x5176c7=await a0_0x383957['checkout']['sessions']['create']({'line_items':[{'price_data':{'currency':'usd','product_data':{'name':_0xb1f19a+'\x20-\x20Course\x20Bundle','description':_0x6a817f,'images':_0x295ade?[urlFor(_0x295ade)['url']()||'']:[]},'unit_amount':_0x3697d7},'quantity':0x1}],'mode':'payment','success_url':a0_0x28ae94+'/payment/success?payment_success=stripe&type=bundle','cancel_url':a0_0x28ae94+'/payment/failed?provider=stripe&type=bundle&reason=Payment\x20cancelled\x20by\x20user','metadata':{'bundleId':_0xf52733['_id'],'userId':_0x35f74b,'sanityStudentId':_0x2f586a['_id'],'type':'bundle'}});if(!_0x5176c7['url'])return{'type':'url','data':null,'error':'Could\x20not\x20create\x20Stripe\x20session\x20URL.'};return{'type':_0x373798(0x1dd),'data':_0x5176c7['url']};}catch(_0x2b60cc){return console['error']('Error\x20in\x20createBundleCheckout:',_0x2b60cc),{'type':'redirect','data':null,'error':'Failed\x20to\x20create\x20Stripe\x20checkout\x20session:\x20'+(_0x2b60cc instanceof Error?_0x2b60cc['message']:_0x373798(0x1de))};}}
