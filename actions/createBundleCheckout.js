"use server";

'use server';(function(_0x2cb888,_0x5bb186){const _0x13ed54=a0_0x1295,_0x250162=_0x2cb888();while(!![]){try{const _0x3fa9af=parseInt(_0x13ed54(0x1ce))/0x1*(-parseInt(_0x13ed54(0x1d5))/0x2)+parseInt(_0x13ed54(0x1cf))/0x3*(parseInt(_0x13ed54(0x1cc))/0x4)+parseInt(_0x13ed54(0x1cb))/0x5*(-parseInt(_0x13ed54(0x1c9))/0x6)+parseInt(_0x13ed54(0x1c6))/0x7*(parseInt(_0x13ed54(0x1c8))/0x8)+-parseInt(_0x13ed54(0x1d2))/0x9+-parseInt(_0x13ed54(0x1d4))/0xa*(parseInt(_0x13ed54(0x1c7))/0xb)+-parseInt(_0x13ed54(0x1d0))/0xc*(-parseInt(_0x13ed54(0x1ca))/0xd);if(_0x3fa9af===_0x5bb186)break;else _0x250162['push'](_0x250162['shift']());}catch(_0x525441){_0x250162['push'](_0x250162['shift']());}}}(a0_0x34d3,0xb8673));function a0_0x34d3(){const _0x30e33b=['checkout','24EsdyXl','57tWUDTh','204RRuoMu','Could\x20not\x20create\x20Stripe\x20session\x20URL.','3078612ILEzMU','url','3440PZzkfi','71966hAHOay','message','168MfgRYh','15543hdSDjF','115552GtPfrd','366RBkKtY','1266655azBPwH','34765xAEzLk','182764AxomNi'];a0_0x34d3=function(){return _0x30e33b;};return a0_0x34d3();}import a0_0x3fc7be from'@/lib/stripe';import a0_0x1da5cc from'@/lib/baseUrl';import{urlFor}from'@/sanity/lib/image';function a0_0x1295(_0x13f582,_0xcb05f4){const _0x34d3f8=a0_0x34d3();return a0_0x1295=function(_0x129528,_0xbbb63e){_0x129528=_0x129528-0x1c6;let _0x523857=_0x34d3f8[_0x129528];return _0x523857;},a0_0x1295(_0x13f582,_0xcb05f4);}import{getBundleById}from'@/sanity/lib/courses/getBundleById';import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';import{clerkClient}from'@clerk/nextjs/server';import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';export async function createBundleCheckout(_0x4720f3,_0x391d0c){const _0x1c6ecc=a0_0x1295;try{const _0x1be59d=await getBundleById(_0x4720f3),_0x657d7a=await(await clerkClient())['users']['getUser'](_0x391d0c),{emailAddresses:_0x479ee4,firstName:_0x2e11b9,lastName:_0x413950,imageUrl:_0x2477c4}=_0x657d7a,_0x3bce72=_0x479ee4[0x0]?.['emailAddress'];if(!_0x479ee4||!_0x3bce72)return{'type':'redirect','data':null,'error':'User\x20details\x20not\x20found'};if(!_0x1be59d)return{'type':'redirect','data':null,'error':'Bundle\x20not\x20found'};const _0x299917=await createStudentIfNotExists({'clerkId':_0x391d0c,'email':_0x3bce72||'','firstName':_0x2e11b9||_0x3bce72,'lastName':_0x413950||'','imageUrl':_0x2477c4||''});if(!_0x299917)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(!_0x1be59d['price']===undefined||_0x1be59d['price']===null)return{'type':'redirect','data':null,'error':'Bundle\x20price\x20is\x20not\x20set'};const {title:_0x4e939c,description:_0x424eb8,backgroundImage:_0x13092f,slug:_0x653419}=_0x1be59d;if(!_0x4e939c||!_0x424eb8||!_0x653419)return{'type':'redirect','data':null,'error':'Bundle\x20data\x20is\x20incomplete'};if(_0x1be59d['price']===0x0)return await createBundleEnrollment({'studentId':_0x299917['_id'],'bundleId':_0x1be59d['_id'],'paymentId':'free_stripe_bundle_'+Date['now'](),'paymentProvider':'stripe','amount':0x0,'bundleData':_0x1be59d}),{'type':'redirect','data':'/my-courses'};const _0x478a1a=Math['round'](_0x1be59d['price']*0x64),_0x1f4c52=await a0_0x3fc7be[_0x1c6ecc(0x1cd)]['sessions']['create']({'line_items':[{'price_data':{'currency':'usd','product_data':{'name':_0x4e939c+'\x20-\x20Course\x20Bundle','description':_0x424eb8,'images':_0x13092f?[urlFor(_0x13092f)['url']()||'']:[]},'unit_amount':_0x478a1a},'quantity':0x1}],'mode':'payment','success_url':a0_0x1da5cc+'/payment/success?payment_success=stripe&type=bundle','cancel_url':a0_0x1da5cc+'/payment/failed?provider=stripe&type=bundle&reason=Payment\x20cancelled\x20by\x20user','metadata':{'bundleId':_0x1be59d['_id'],'userId':_0x391d0c,'sanityStudentId':_0x299917['_id'],'type':'bundle'}});if(!_0x1f4c52['url'])return{'type':'url','data':null,'error':_0x1c6ecc(0x1d1)};return{'type':'url','data':_0x1f4c52[_0x1c6ecc(0x1d3)]};}catch(_0x5e07a6){return console['error']('Error\x20in\x20createBundleCheckout:',_0x5e07a6),{'type':'redirect','data':null,'error':'Failed\x20to\x20create\x20Stripe\x20checkout\x20session:\x20'+(_0x5e07a6 instanceof Error?_0x5e07a6[_0x1c6ecc(0x1d6)]:'Unknown\x20error')};}}
