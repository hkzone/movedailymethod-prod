"use server";

'use server';(function(_0xd2a9b5,_0x87ec54){const _0x4458b8=a0_0x305a,_0x80d2f8=_0xd2a9b5();while(!![]){try{const _0x3448fe=-parseInt(_0x4458b8(0xec))/0x1+-parseInt(_0x4458b8(0xea))/0x2*(-parseInt(_0x4458b8(0xe8))/0x3)+parseInt(_0x4458b8(0xf3))/0x4+parseInt(_0x4458b8(0xf0))/0x5+parseInt(_0x4458b8(0xe7))/0x6+-parseInt(_0x4458b8(0xed))/0x7*(-parseInt(_0x4458b8(0xf1))/0x8)+-parseInt(_0x4458b8(0xef))/0x9;if(_0x3448fe===_0x87ec54)break;else _0x80d2f8['push'](_0x80d2f8['shift']());}catch(_0x2fc417){_0x80d2f8['push'](_0x80d2f8['shift']());}}}(a0_0x357c,0x607fd));import a0_0x12a4ce from'@/lib/stripe';import a0_0x17dc72 from'@/lib/baseUrl';import{urlFor}from'@/sanity/lib/image';function a0_0x305a(_0x28442c,_0x49da81){const _0x357c9c=a0_0x357c();return a0_0x305a=function(_0x305a81,_0x3a4590){_0x305a81=_0x305a81-0xe6;let _0x593bc1=_0x357c9c[_0x305a81];return _0x593bc1;},a0_0x305a(_0x28442c,_0x49da81);}import{getBundleById}from'@/sanity/lib/courses/getBundleById';import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';import{clerkClient}from'@clerk/nextjs/server';function a0_0x357c(){const _0x2243b2=['177114dVarcU','payment','269965TJmumH','7smVqUz','price','10503504OAXrsW','10600SsVePY','4661608PFrbpK','Bundle\x20not\x20found','1640132MEdiAY','round','redirect','4493226cqWERc','3tbPWWB','\x20-\x20Course\x20Bundle'];a0_0x357c=function(){return _0x2243b2;};return a0_0x357c();}import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';export async function createBundleCheckout(_0xf342f0,_0x1bdb94){const _0x46b111=a0_0x305a;try{const _0xc67174=await getBundleById(_0xf342f0),_0xad16f0=await(await clerkClient())['users']['getUser'](_0x1bdb94),{emailAddresses:_0x46a8c8,firstName:_0x447b28,lastName:_0x14fd6d,imageUrl:_0x1cf663}=_0xad16f0,_0x360fe7=_0x46a8c8[0x0]?.['emailAddress'];if(!_0x46a8c8||!_0x360fe7)return{'type':'redirect','data':null,'error':'User\x20details\x20not\x20found'};if(!_0xc67174)return{'type':'redirect','data':null,'error':_0x46b111(0xf2)};const _0x24fa82=await createStudentIfNotExists({'clerkId':_0x1bdb94,'email':_0x360fe7||'','firstName':_0x447b28||_0x360fe7,'lastName':_0x14fd6d||'','imageUrl':_0x1cf663||''});if(!_0x24fa82)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(!_0xc67174['price']===undefined||_0xc67174[_0x46b111(0xee)]===null)return{'type':'redirect','data':null,'error':'Bundle\x20price\x20is\x20not\x20set'};const {title:_0x2390ed,description:_0x140b1b,backgroundImage:_0x22ca4a,slug:_0x3a1793}=_0xc67174;if(!_0x2390ed||!_0x140b1b||!_0x3a1793)return{'type':_0x46b111(0xe6),'data':null,'error':'Bundle\x20data\x20is\x20incomplete'};if(_0xc67174['price']===0x0)return await createBundleEnrollment({'studentId':_0x24fa82['_id'],'bundleId':_0xc67174['_id'],'paymentId':'free_stripe_bundle_'+Date['now'](),'paymentProvider':'stripe','amount':0x0,'bundleData':_0xc67174}),{'type':'redirect','data':'/my-courses'};const _0x40c5f3=Math[_0x46b111(0xf4)](_0xc67174['price']*0x64),_0x46ec1d=await a0_0x12a4ce['checkout']['sessions']['create']({'line_items':[{'price_data':{'currency':'usd','product_data':{'name':_0x2390ed+_0x46b111(0xe9),'description':_0x140b1b,'images':_0x22ca4a?[urlFor(_0x22ca4a)['url']()||'']:[]},'unit_amount':_0x40c5f3},'quantity':0x1}],'mode':_0x46b111(0xeb),'success_url':a0_0x17dc72+'/payment/success?payment_success=stripe&type=bundle','cancel_url':a0_0x17dc72+'/payment/failed?provider=stripe&type=bundle&reason=Payment\x20cancelled\x20by\x20user','metadata':{'bundleId':_0xc67174['_id'],'userId':_0x1bdb94,'sanityStudentId':_0x24fa82['_id'],'type':'bundle'}});if(!_0x46ec1d['url'])return{'type':'url','data':null,'error':'Could\x20not\x20create\x20Stripe\x20session\x20URL.'};return{'type':'url','data':_0x46ec1d['url']};}catch(_0x56f905){return console['error']('Error\x20in\x20createBundleCheckout:',_0x56f905),{'type':'redirect','data':null,'error':'Failed\x20to\x20create\x20Stripe\x20checkout\x20session:\x20'+(_0x56f905 instanceof Error?_0x56f905['message']:'Unknown\x20error')};}}
