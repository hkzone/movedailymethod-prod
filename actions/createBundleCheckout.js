"use server";

'use server';(function(_0x68164b,_0x269b2b){const _0x6156ce=a0_0x30a5,_0x5a940b=_0x68164b();while(!![]){try{const _0x28af20=-parseInt(_0x6156ce(0x1bf))/0x1*(parseInt(_0x6156ce(0x1c7))/0x2)+-parseInt(_0x6156ce(0x1c9))/0x3*(-parseInt(_0x6156ce(0x1c6))/0x4)+parseInt(_0x6156ce(0x1c4))/0x5+parseInt(_0x6156ce(0x1bd))/0x6+parseInt(_0x6156ce(0x1bc))/0x7+parseInt(_0x6156ce(0x1c1))/0x8+parseInt(_0x6156ce(0x1c0))/0x9*(-parseInt(_0x6156ce(0x1c3))/0xa);if(_0x28af20===_0x269b2b)break;else _0x5a940b['push'](_0x5a940b['shift']());}catch(_0xfbce7a){_0x5a940b['push'](_0x5a940b['shift']());}}}(a0_0x274b,0xc254f));import a0_0x3499fc from'@/lib/stripe';import a0_0xbd27d0 from'@/lib/baseUrl';import{urlFor}from'@/sanity/lib/image';import{getBundleById}from'@/sanity/lib/courses/getBundleById';function a0_0x30a5(_0x30c2aa,_0x37910e){const _0x274bf7=a0_0x274b();return a0_0x30a5=function(_0x30a564,_0x514d5c){_0x30a564=_0x30a564-0x1bb;let _0x2f239c=_0x274bf7[_0x30a564];return _0x2f239c;},a0_0x30a5(_0x30c2aa,_0x37910e);}import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';import{clerkClient}from'@clerk/nextjs/server';import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';export async function createBundleCheckout(_0x5212dd,_0x3a1e44){const _0x42c14a=a0_0x30a5;try{const _0x4945e5=await getBundleById(_0x5212dd),_0x25f5f9=await(await clerkClient())['users']['getUser'](_0x3a1e44),{emailAddresses:_0x2cc949,firstName:_0x2758fb,lastName:_0x42f37e,imageUrl:_0x224981}=_0x25f5f9,_0x431897=_0x2cc949[0x0]?.['emailAddress'];if(!_0x2cc949||!_0x431897)return{'type':'redirect','data':null,'error':'User\x20details\x20not\x20found'};if(!_0x4945e5)return{'type':'redirect','data':null,'error':'Bundle\x20not\x20found'};const _0x1ed14a=await createStudentIfNotExists({'clerkId':_0x3a1e44,'email':_0x431897||'','firstName':_0x2758fb||_0x431897,'lastName':_0x42f37e||'','imageUrl':_0x224981||''});if(!_0x1ed14a)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(!_0x4945e5['price']===undefined||_0x4945e5['price']===null)return{'type':'redirect','data':null,'error':_0x42c14a(0x1c5)};const {title:_0x423227,description:_0x4d5fd4,backgroundImage:_0x34c59e,slug:_0x3cf05f}=_0x4945e5;if(!_0x423227||!_0x4d5fd4||!_0x3cf05f)return{'type':'redirect','data':null,'error':_0x42c14a(0x1be)};if(_0x4945e5['price']===0x0)return await createBundleEnrollment({'studentId':_0x1ed14a['_id'],'bundleId':_0x4945e5['_id'],'paymentId':'free_stripe_bundle_'+Date['now'](),'paymentProvider':'stripe','amount':0x0,'bundleData':_0x4945e5}),{'type':'redirect','data':'/my-courses'};const _0x42473e=Math['round'](_0x4945e5['price']*0x64),_0x240262=await a0_0x3499fc['checkout']['sessions']['create']({'line_items':[{'price_data':{'currency':_0x42c14a(0x1c8),'product_data':{'name':_0x423227+'\x20-\x20Course\x20Bundle','description':_0x4d5fd4,'images':_0x34c59e?[urlFor(_0x34c59e)['url']()||'']:[]},'unit_amount':_0x42473e},'quantity':0x1}],'mode':_0x42c14a(0x1c2),'success_url':a0_0xbd27d0+'/payment/success?payment_success=stripe&type=bundle','cancel_url':a0_0xbd27d0+'/payment/failed?provider=stripe&type=bundle&reason=Payment\x20cancelled\x20by\x20user','metadata':{'bundleId':_0x4945e5['_id'],'userId':_0x3a1e44,'sanityStudentId':_0x1ed14a['_id'],'type':'bundle'}});if(!_0x240262['url'])return{'type':_0x42c14a(0x1bb),'data':null,'error':'Could\x20not\x20create\x20Stripe\x20session\x20URL.'};return{'type':'url','data':_0x240262['url']};}catch(_0x103100){return console['error']('Error\x20in\x20createBundleCheckout:',_0x103100),{'type':'redirect','data':null,'error':'Failed\x20to\x20create\x20Stripe\x20checkout\x20session:\x20'+(_0x103100 instanceof Error?_0x103100['message']:'Unknown\x20error')};}}function a0_0x274b(){const _0x2beeec=['535400ZOYcMG','Bundle\x20price\x20is\x20not\x20set','28aBFjSw','14gNPyKg','usd','471621GvyNNv','url','4199153rOpOKp','9017454HHFVvT','Bundle\x20data\x20is\x20incomplete','14557QpxNaI','26728497mQSUiI','4459184KYoLbF','payment','10VssGJz'];a0_0x274b=function(){return _0x2beeec;};return a0_0x274b();}
