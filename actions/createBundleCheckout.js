"use server";

'use server';(function(_0x18b653,_0x3e4ee1){const _0x239402=a0_0x56ab,_0x5ab7b5=_0x18b653();while(!![]){try{const _0xabc7d=parseInt(_0x239402(0x14d))/0x1+-parseInt(_0x239402(0x143))/0x2*(parseInt(_0x239402(0x145))/0x3)+-parseInt(_0x239402(0x14c))/0x4*(-parseInt(_0x239402(0x14e))/0x5)+-parseInt(_0x239402(0x14b))/0x6+parseInt(_0x239402(0x146))/0x7*(parseInt(_0x239402(0x149))/0x8)+parseInt(_0x239402(0x144))/0x9+-parseInt(_0x239402(0x14f))/0xa;if(_0xabc7d===_0x3e4ee1)break;else _0x5ab7b5['push'](_0x5ab7b5['shift']());}catch(_0x2e5fec){_0x5ab7b5['push'](_0x5ab7b5['shift']());}}}(a0_0x598d,0x231e6));import a0_0x47ba6b from'@/lib/stripe';import a0_0x31ecfd from'@/lib/baseUrl';import{urlFor}from'@/sanity/lib/image';import{getBundleById}from'@/sanity/lib/courses/getBundleById';function a0_0x598d(){const _0x4f6ef1=['209809kcEpGU','5FNyftr','1187150TahovD','url','sessions','356948FcHRqA','1175112VxyugS','3vyLomV','7FFwJIq','bundle','redirect','806704nfVxdx','/payment/success?payment_success=stripe&type=bundle','377724JMoZzP','251096MBhWmK'];a0_0x598d=function(){return _0x4f6ef1;};return a0_0x598d();}function a0_0x56ab(_0x5ddaa1,_0x2fc333){const _0x598d24=a0_0x598d();return a0_0x56ab=function(_0x56abff,_0x32d723){_0x56abff=_0x56abff-0x142;let _0x441293=_0x598d24[_0x56abff];return _0x441293;},a0_0x56ab(_0x5ddaa1,_0x2fc333);}import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';import{clerkClient}from'@clerk/nextjs/server';import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';export async function createBundleCheckout(_0x804f99,_0x4b5c95){const _0x52831b=a0_0x56ab;try{const _0x29fc3c=await getBundleById(_0x804f99),_0x32ab85=await(await clerkClient())['users']['getUser'](_0x4b5c95),{emailAddresses:_0x4d9b68,firstName:_0x45dbf8,lastName:_0x39dc89,imageUrl:_0x267a07}=_0x32ab85,_0x4dfe5e=_0x4d9b68[0x0]?.['emailAddress'];if(!_0x4d9b68||!_0x4dfe5e)return{'type':'redirect','data':null,'error':'User\x20details\x20not\x20found'};if(!_0x29fc3c)return{'type':'redirect','data':null,'error':'Bundle\x20not\x20found'};const _0x1ec9f4=await createStudentIfNotExists({'clerkId':_0x4b5c95,'email':_0x4dfe5e||'','firstName':_0x45dbf8||_0x4dfe5e,'lastName':_0x39dc89||'','imageUrl':_0x267a07||''});if(!_0x1ec9f4)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(!_0x29fc3c['price']===undefined||_0x29fc3c['price']===null)return{'type':'redirect','data':null,'error':'Bundle\x20price\x20is\x20not\x20set'};const {title:_0x3542c0,description:_0x5c8774,backgroundImage:_0x4751e0,slug:_0x2626dc}=_0x29fc3c;if(!_0x3542c0||!_0x5c8774||!_0x2626dc)return{'type':_0x52831b(0x148),'data':null,'error':'Bundle\x20data\x20is\x20incomplete'};if(_0x29fc3c['price']===0x0)return await createBundleEnrollment({'studentId':_0x1ec9f4['_id'],'bundleId':_0x29fc3c['_id'],'paymentId':'free_stripe_bundle_'+Date['now'](),'paymentProvider':'stripe','amount':0x0,'bundleData':_0x29fc3c}),{'type':_0x52831b(0x148),'data':'/my-courses'};const _0x8a3dda=Math['round'](_0x29fc3c['price']*0x64),_0x303cb8=await a0_0x47ba6b['checkout'][_0x52831b(0x142)]['create']({'line_items':[{'price_data':{'currency':'usd','product_data':{'name':_0x3542c0+'\x20-\x20Course\x20Bundle','description':_0x5c8774,'images':_0x4751e0?[urlFor(_0x4751e0)['url']()||'']:[]},'unit_amount':_0x8a3dda},'quantity':0x1}],'mode':'payment','success_url':a0_0x31ecfd+_0x52831b(0x14a),'cancel_url':a0_0x31ecfd+'/payment/failed?provider=stripe&type=bundle&reason=Payment\x20cancelled\x20by\x20user','metadata':{'bundleId':_0x29fc3c['_id'],'userId':_0x4b5c95,'sanityStudentId':_0x1ec9f4['_id'],'type':_0x52831b(0x147)}});if(!_0x303cb8[_0x52831b(0x150)])return{'type':'url','data':null,'error':'Could\x20not\x20create\x20Stripe\x20session\x20URL.'};return{'type':'url','data':_0x303cb8['url']};}catch(_0x20cc82){return console['error']('Error\x20in\x20createBundleCheckout:',_0x20cc82),{'type':_0x52831b(0x148),'data':null,'error':'Failed\x20to\x20create\x20Stripe\x20checkout\x20session:\x20'+(_0x20cc82 instanceof Error?_0x20cc82['message']:'Unknown\x20error')};}}
