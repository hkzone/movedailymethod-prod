"use server";

'use server';function a0_0x50da(_0x4aa670,_0x245b05){const _0x21ec40=a0_0x21ec();return a0_0x50da=function(_0x50daa5,_0x2bc6cb){_0x50daa5=_0x50daa5-0x146;let _0x3bd075=_0x21ec40[_0x50daa5];return _0x3bd075;},a0_0x50da(_0x4aa670,_0x245b05);}(function(_0x4b0c0d,_0xc85d7c){const _0x350834=a0_0x50da,_0x2ff461=_0x4b0c0d();while(!![]){try{const _0x1ac277=-parseInt(_0x350834(0x14e))/0x1+-parseInt(_0x350834(0x14c))/0x2+-parseInt(_0x350834(0x147))/0x3+parseInt(_0x350834(0x151))/0x4*(parseInt(_0x350834(0x150))/0x5)+-parseInt(_0x350834(0x153))/0x6+parseInt(_0x350834(0x152))/0x7+parseInt(_0x350834(0x146))/0x8;if(_0x1ac277===_0xc85d7c)break;else _0x2ff461['push'](_0x2ff461['shift']());}catch(_0x35e8e3){_0x2ff461['push'](_0x2ff461['shift']());}}}(a0_0x21ec,0xb8eee));import a0_0x17b3c4 from'@/lib/stripe';import a0_0x1083b4 from'@/lib/baseUrl';import{urlFor}from'@/sanity/lib/image';import a0_0x24dc53 from'@/sanity/lib/courses/getCourseById';import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';import{clerkClient}from'@clerk/nextjs/server';function a0_0x21ec(){const _0x3c65ee=['3352005mEirhM','Course\x20not\x20found','current','/courses/','checkout','88018TvYKPR','users','311352moQPWL','_id','290hGgzee','61220cbCPjq','4620385IAlPxZ','1120116hwzVMf','6952984QzTqJG'];a0_0x21ec=function(){return _0x3c65ee;};return a0_0x21ec();}import{createEnrollment}from'@/sanity/lib/student/createEnrollment';export async function createStripeCheckout(_0x1504e1,_0x1eb4fe){const _0xf302fe=a0_0x50da;try{const _0x8ddd54=await a0_0x24dc53(_0x1504e1),_0x46c6a6=await(await clerkClient())[_0xf302fe(0x14d)]['getUser'](_0x1eb4fe),{emailAddresses:_0x5333b3,firstName:_0x1f86d7,lastName:_0x19e5d9,imageUrl:_0x410560}=_0x46c6a6,_0x31386d=_0x5333b3[0x0]?.['emailAddress'];if(!_0x5333b3||!_0x31386d)return{'type':'redirect','data':null,'error':'User\x20details\x20not\x20found'};if(!_0x8ddd54)return{'type':'redirect','data':null,'error':_0xf302fe(0x148)};const _0x1a7dfd=await createStudentIfNotExists({'clerkId':_0x1eb4fe,'email':_0x31386d||'','firstName':_0x1f86d7||_0x31386d,'lastName':_0x19e5d9||'','imageUrl':_0x410560||''});if(!_0x1a7dfd)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(_0x8ddd54['price']===undefined||_0x8ddd54['price']===null)return{'type':'redirect','data':null,'error':'Course\x20price\x20is\x20not\x20set'};const {title:_0x235593,description:_0x36affe,image:_0x217dbe,slug:_0x1541a1}=_0x8ddd54;if(!_0x235593||!_0x36affe||!_0x217dbe||!_0x1541a1?.[_0xf302fe(0x149)])return{'type':'redirect','data':null,'error':'Course\x20data\x20is\x20incomplete'};if(_0x8ddd54['price']===0x0)return await createEnrollment({'studentId':_0x1a7dfd[_0xf302fe(0x14f)],'courseId':_0x8ddd54['_id'],'paymentId':'free_stripe_'+Date['now'](),'paymentProvider':'stripe','amount':0x0}),{'type':'redirect','data':'/dashboard/courses/'+_0x8ddd54['_id']};const _0x49fd60=Math['round'](_0x8ddd54['price']*0x64),_0x50eaf8=await a0_0x17b3c4[_0xf302fe(0x14b)]['sessions']['create']({'line_items':[{'price_data':{'currency':'usd','product_data':{'name':_0x235593,'description':_0x36affe,'images':[urlFor(_0x217dbe)['url']()||'']},'unit_amount':_0x49fd60},'quantity':0x1}],'mode':'payment','success_url':a0_0x1083b4+_0xf302fe(0x14a)+_0x1541a1['current']+'?payment_success=stripe','cancel_url':a0_0x1083b4+'/courses/'+_0x1541a1['current']+'?payment_canceled=true','metadata':{'courseId':_0x8ddd54[_0xf302fe(0x14f)],'userId':_0x1eb4fe,'sanityStudentId':_0x1a7dfd[_0xf302fe(0x14f)]}});if(!_0x50eaf8['url'])return{'type':'url','data':null,'error':'Could\x20not\x20create\x20Stripe\x20session\x20URL.'};return{'type':'url','data':_0x50eaf8['url']};}catch(_0x314038){return console['error']('Error\x20in\x20createStripeCheckout:',_0x314038),{'type':'redirect','data':null,'error':'Failed\x20to\x20create\x20Stripe\x20checkout\x20session:\x20'+(_0x314038 instanceof Error?_0x314038['message']:'Unknown\x20error')};}}
