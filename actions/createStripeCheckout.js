"use server";

'use server';(function(_0xd86cae,_0x2328d0){const _0x446583=a1_0x4a94,_0x4c8fe3=_0xd86cae();while(!![]){try{const _0x52fb71=-parseInt(_0x446583(0x1a3))/0x1+-parseInt(_0x446583(0x1a5))/0x2+-parseInt(_0x446583(0x1a4))/0x3+-parseInt(_0x446583(0x1a9))/0x4*(-parseInt(_0x446583(0x1a2))/0x5)+-parseInt(_0x446583(0x1aa))/0x6*(parseInt(_0x446583(0x19f))/0x7)+parseInt(_0x446583(0x1ac))/0x8+parseInt(_0x446583(0x19d))/0x9*(parseInt(_0x446583(0x19e))/0xa);if(_0x52fb71===_0x2328d0)break;else _0x4c8fe3['push'](_0x4c8fe3['shift']());}catch(_0x215828){_0x4c8fe3['push'](_0x4c8fe3['shift']());}}}(a1_0x10e2,0x18dd1));import a1_0x364634 from'@/lib/stripe';import a1_0x146b9c from'@/lib/baseUrl';import{urlFor}from'@/sanity/lib/image';import a1_0x21f027 from'@/sanity/lib/courses/getCourseById';import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';import{clerkClient}from'@clerk/nextjs/server';function a1_0x4a94(_0x54ff90,_0xcf0426){const _0x10e227=a1_0x10e2();return a1_0x4a94=function(_0x4a94c0,_0x55e93e){_0x4a94c0=_0x4a94c0-0x19d;let _0x8104e2=_0x10e227[_0x4a94c0];return _0x8104e2;},a1_0x4a94(_0x54ff90,_0xcf0426);}import{createEnrollment}from'@/sanity/lib/student/createEnrollment';function a1_0x10e2(){const _0x31aa51=['356414zBYzxw','redirect','Could\x20not\x20create\x20Stripe\x20session\x20URL.','url','229648pzZmMd','6smRdHx','price','518904FNjhlO','351nqsOre','152580tUYZjw','1163743MRAMkg','checkout','create','15SFaWGm','189238AlfVGC','589878ewzedv'];a1_0x10e2=function(){return _0x31aa51;};return a1_0x10e2();}export async function createStripeCheckout(_0x155b6b,_0xd6e2fd){const _0x235087=a1_0x4a94;try{const _0xf4f1f2=await a1_0x21f027(_0x155b6b),_0x545862=await(await clerkClient())['users']['getUser'](_0xd6e2fd),{emailAddresses:_0x162dc7,firstName:_0x1a9b80,lastName:_0x4d4d45,imageUrl:_0x631161}=_0x545862,_0x45ed8f=_0x162dc7[0x0]?.['emailAddress'];if(!_0x162dc7||!_0x45ed8f)return{'type':'redirect','data':null,'error':'User\x20details\x20not\x20found'};if(!_0xf4f1f2)return{'type':'redirect','data':null,'error':'Course\x20not\x20found'};const _0x5a8e72=await createStudentIfNotExists({'clerkId':_0xd6e2fd,'email':_0x45ed8f||'','firstName':_0x1a9b80||_0x45ed8f,'lastName':_0x4d4d45||'','imageUrl':_0x631161||''});if(!_0x5a8e72)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(_0xf4f1f2['price']===undefined||_0xf4f1f2['price']===null)return{'type':_0x235087(0x1a6),'data':null,'error':'Course\x20price\x20is\x20not\x20set'};const {title:_0x46cad6,description:_0x150a06,image:_0x1a2a02,slug:_0x3e6e5a}=_0xf4f1f2;if(!_0x46cad6||!_0x150a06||!_0x1a2a02||!_0x3e6e5a?.['current'])return{'type':'redirect','data':null,'error':'Course\x20data\x20is\x20incomplete'};if(_0xf4f1f2['price']===0x0)return await createEnrollment({'studentId':_0x5a8e72['_id'],'courseId':_0xf4f1f2['_id'],'paymentId':'free_stripe_'+Date['now'](),'paymentProvider':'stripe','amount':0x0}),{'type':'redirect','data':'/dashboard/courses/'+_0xf4f1f2['_id']};const _0x509d65=Math['round'](_0xf4f1f2[_0x235087(0x1ab)]*0x64),_0x10aff6=await a1_0x364634[_0x235087(0x1a0)]['sessions'][_0x235087(0x1a1)]({'line_items':[{'price_data':{'currency':'usd','product_data':{'name':_0x46cad6,'description':_0x150a06,'images':[urlFor(_0x1a2a02)['url']()||'']},'unit_amount':_0x509d65},'quantity':0x1}],'mode':'payment','success_url':a1_0x146b9c+'/payment/success?payment_success=stripe&type=course','cancel_url':a1_0x146b9c+'/payment/failed?provider=stripe&type=course&reason=Payment\x20cancelled\x20by\x20user','metadata':{'courseId':_0xf4f1f2['_id'],'userId':_0xd6e2fd,'sanityStudentId':_0x5a8e72['_id']}});if(!_0x10aff6['url'])return{'type':'url','data':null,'error':_0x235087(0x1a7)};return{'type':'url','data':_0x10aff6[_0x235087(0x1a8)]};}catch(_0x599461){return console['error']('Error\x20in\x20createStripeCheckout:',_0x599461),{'type':'redirect','data':null,'error':'Failed\x20to\x20create\x20Stripe\x20checkout\x20session:\x20'+(_0x599461 instanceof Error?_0x599461['message']:'Unknown\x20error')};}}
