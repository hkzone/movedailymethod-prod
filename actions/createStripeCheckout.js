"use server";

'use server';(function(_0x13cf1d,_0x290851){const _0x326564=a0_0xeff8,_0x571419=_0x13cf1d();while(!![]){try{const _0x50d6dd=parseInt(_0x326564(0x65))/0x1+-parseInt(_0x326564(0x71))/0x2+-parseInt(_0x326564(0x69))/0x3+parseInt(_0x326564(0x70))/0x4+-parseInt(_0x326564(0x6c))/0x5+parseInt(_0x326564(0x6b))/0x6+parseInt(_0x326564(0x67))/0x7*(parseInt(_0x326564(0x6e))/0x8);if(_0x50d6dd===_0x290851)break;else _0x571419['push'](_0x571419['shift']());}catch(_0x5d7915){_0x571419['push'](_0x571419['shift']());}}}(a0_0x3051,0x424dc));import a0_0x5b5855 from'@/lib/stripe';import a0_0x5c66eb from'@/lib/baseUrl';import{urlFor}from'@/sanity/lib/image';import a0_0x11bc70 from'@/sanity/lib/courses/getCourseById';function a0_0x3051(){const _0x1e660f=['986876fOiVft','318548uOyOvz','free_stripe_','299434nGqINQ','current','14szPrgZ','create','1263837rNnHLt','payment','875070KzfeAD','252915iuxRsn','_id','842872YGcHhO','url'];a0_0x3051=function(){return _0x1e660f;};return a0_0x3051();}function a0_0xeff8(_0x5b9b8c,_0xe9d1b0){const _0x305114=a0_0x3051();return a0_0xeff8=function(_0xeff81b,_0x5c0497){_0xeff81b=_0xeff81b-0x64;let _0x231bb5=_0x305114[_0xeff81b];return _0x231bb5;},a0_0xeff8(_0x5b9b8c,_0xe9d1b0);}import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';import{clerkClient}from'@clerk/nextjs/server';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';export async function createStripeCheckout(_0x3307eb,_0x191357){const _0x4362c3=a0_0xeff8;try{const _0x5d55a7=await a0_0x11bc70(_0x3307eb),_0x1a81fb=await(await clerkClient())['users']['getUser'](_0x191357),{emailAddresses:_0x14e470,firstName:_0x4b77cd,lastName:_0x53a024,imageUrl:_0x514fc9}=_0x1a81fb,_0xaeb0aa=_0x14e470[0x0]?.['emailAddress'];if(!_0x14e470||!_0xaeb0aa)return{'type':'redirect','data':null,'error':'User\x20details\x20not\x20found'};if(!_0x5d55a7)return{'type':'redirect','data':null,'error':'Course\x20not\x20found'};const _0x297988=await createStudentIfNotExists({'clerkId':_0x191357,'email':_0xaeb0aa||'','firstName':_0x4b77cd||_0xaeb0aa,'lastName':_0x53a024||'','imageUrl':_0x514fc9||''});if(!_0x297988)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(_0x5d55a7['price']===undefined||_0x5d55a7['price']===null)return{'type':'redirect','data':null,'error':'Course\x20price\x20is\x20not\x20set'};const {title:_0x32512e,description:_0xc16e51,image:_0x5ee7ca,slug:_0x232da2}=_0x5d55a7;if(!_0x32512e||!_0xc16e51||!_0x5ee7ca||!_0x232da2?.['current'])return{'type':'redirect','data':null,'error':'Course\x20data\x20is\x20incomplete'};if(_0x5d55a7['price']===0x0)return await createEnrollment({'studentId':_0x297988['_id'],'courseId':_0x5d55a7['_id'],'paymentId':_0x4362c3(0x64)+Date['now'](),'paymentProvider':'stripe','amount':0x0}),{'type':'redirect','data':'/dashboard/courses/'+_0x5d55a7['_id']};const _0x5625de=Math['round'](_0x5d55a7['price']*0x64),_0x34f1e3=await a0_0x5b5855['checkout']['sessions'][_0x4362c3(0x68)]({'line_items':[{'price_data':{'currency':'usd','product_data':{'name':_0x32512e,'description':_0xc16e51,'images':[urlFor(_0x5ee7ca)['url']()||'']},'unit_amount':_0x5625de},'quantity':0x1}],'mode':_0x4362c3(0x6a),'success_url':a0_0x5c66eb+'/courses/'+_0x232da2['current']+'?payment_success=stripe','cancel_url':a0_0x5c66eb+'/courses/'+_0x232da2[_0x4362c3(0x66)]+'?payment_canceled=true','metadata':{'courseId':_0x5d55a7[_0x4362c3(0x6d)],'userId':_0x191357,'sanityStudentId':_0x297988['_id']}});if(!_0x34f1e3['url'])return{'type':'url','data':null,'error':'Could\x20not\x20create\x20Stripe\x20session\x20URL.'};return{'type':_0x4362c3(0x6f),'data':_0x34f1e3['url']};}catch(_0x1062a4){return console['error']('Error\x20in\x20createStripeCheckout:',_0x1062a4),{'type':'redirect','data':null,'error':'Failed\x20to\x20create\x20Stripe\x20checkout\x20session:\x20'+(_0x1062a4 instanceof Error?_0x1062a4['message']:'Unknown\x20error')};}}
