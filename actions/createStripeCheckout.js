"use server";

'use server';(function(_0x2ee21d,_0x316aec){const _0x4dcafd=a1_0x13a5,_0x129bb3=_0x2ee21d();while(!![]){try{const _0x58c442=parseInt(_0x4dcafd(0x1b0))/0x1*(parseInt(_0x4dcafd(0x1a6))/0x2)+-parseInt(_0x4dcafd(0x1ad))/0x3+-parseInt(_0x4dcafd(0x1aa))/0x4+parseInt(_0x4dcafd(0x1ac))/0x5+parseInt(_0x4dcafd(0x1af))/0x6+-parseInt(_0x4dcafd(0x1ae))/0x7*(parseInt(_0x4dcafd(0x1b1))/0x8)+parseInt(_0x4dcafd(0x1a9))/0x9;if(_0x58c442===_0x316aec)break;else _0x129bb3['push'](_0x129bb3['shift']());}catch(_0x3c9466){_0x129bb3['push'](_0x129bb3['shift']());}}}(a1_0x186a,0x977c9));import a1_0x3d4826 from'@/lib/stripe';import a1_0xb10dc4 from'@/lib/baseUrl';import{urlFor}from'@/sanity/lib/image';import a1_0x37607b from'@/sanity/lib/courses/getCourseById';import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';function a1_0x186a(){const _0xfcb6a3=['_id','4493050dxlTGa','708906MUDsSU','64862DmZXkW','1484484XfIOLX','385639gXCGTL','848TeTiLW','4tVAOqc','redirect','url','6769017ecJyom','3321712JizwjJ'];a1_0x186a=function(){return _0xfcb6a3;};return a1_0x186a();}import{clerkClient}from'@clerk/nextjs/server';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';function a1_0x13a5(_0x3308f7,_0x9046bc){const _0x186a3f=a1_0x186a();return a1_0x13a5=function(_0x13a537,_0xadf8d3){_0x13a537=_0x13a537-0x1a6;let _0x4fbca7=_0x186a3f[_0x13a537];return _0x4fbca7;},a1_0x13a5(_0x3308f7,_0x9046bc);}export async function createStripeCheckout(_0xf75ee7,_0x136580){const _0x59dac1=a1_0x13a5;try{const _0x13638d=await a1_0x37607b(_0xf75ee7),_0x304197=await(await clerkClient())['users']['getUser'](_0x136580),{emailAddresses:_0x4dc446,firstName:_0x25ab44,lastName:_0x2412cb,imageUrl:_0x2b9802}=_0x304197,_0x22bde7=_0x4dc446[0x0]?.['emailAddress'];if(!_0x4dc446||!_0x22bde7)return{'type':_0x59dac1(0x1a7),'data':null,'error':'User\x20details\x20not\x20found'};if(!_0x13638d)return{'type':'redirect','data':null,'error':'Course\x20not\x20found'};const _0x2b24f5=await createStudentIfNotExists({'clerkId':_0x136580,'email':_0x22bde7||'','firstName':_0x25ab44||_0x22bde7,'lastName':_0x2412cb||'','imageUrl':_0x2b9802||''});if(!_0x2b24f5)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(_0x13638d['price']===undefined||_0x13638d['price']===null)return{'type':'redirect','data':null,'error':'Course\x20price\x20is\x20not\x20set'};const {title:_0x225995,description:_0x45de67,image:_0x5bb540,slug:_0x1f96bf}=_0x13638d;if(!_0x225995||!_0x45de67||!_0x5bb540||!_0x1f96bf?.['current'])return{'type':'redirect','data':null,'error':'Course\x20data\x20is\x20incomplete'};if(_0x13638d['price']===0x0)return await createEnrollment({'studentId':_0x2b24f5['_id'],'courseId':_0x13638d['_id'],'paymentId':'free_stripe_'+Date['now'](),'paymentProvider':'stripe','amount':0x0}),{'type':'redirect','data':'/dashboard/courses/'+_0x13638d[_0x59dac1(0x1ab)]};const _0x2fc280=Math['round'](_0x13638d['price']*0x64),_0x33f7f1=await a1_0x3d4826['checkout']['sessions']['create']({'line_items':[{'price_data':{'currency':'usd','product_data':{'name':_0x225995,'description':_0x45de67,'images':[urlFor(_0x5bb540)['url']()||'']},'unit_amount':_0x2fc280},'quantity':0x1}],'mode':'payment','success_url':a1_0xb10dc4+'/payment/success?payment_success=stripe&type=course','cancel_url':a1_0xb10dc4+'/payment/failed?provider=stripe&type=course&reason=Payment\x20cancelled\x20by\x20user','metadata':{'courseId':_0x13638d['_id'],'userId':_0x136580,'sanityStudentId':_0x2b24f5['_id']}});if(!_0x33f7f1['url'])return{'type':'url','data':null,'error':'Could\x20not\x20create\x20Stripe\x20session\x20URL.'};return{'type':'url','data':_0x33f7f1[_0x59dac1(0x1a8)]};}catch(_0x140dcf){return console['error']('Error\x20in\x20createStripeCheckout:',_0x140dcf),{'type':'redirect','data':null,'error':'Failed\x20to\x20create\x20Stripe\x20checkout\x20session:\x20'+(_0x140dcf instanceof Error?_0x140dcf['message']:'Unknown\x20error')};}}
