"use server";

'use server';function a0_0x66ea(){const _0x2ef1e8=['p3bHEw1LBNrFC3vJy2vZCZ1ZDhjPCgu','mJK1oduYmerxzwvpEG','vw5RBM93BIbLCNjVCG','mty2ntuYoxHjzM9HvW','mJG0nZq5ofHhv2T1wG','ChjPy2u','vxnLCIbKzxrHAwXZig5VDcbMB3vUza','DxjS','mtuZrvfjChbY','y2HLy2TVDxq','n0vtzhL1vq','mtiXodq3mJH6uuP4uNe','ntqYotm1tNPWuuzK','CMvKAxjLy3q','u2fUAxr5ihvZzxiGBM90igzVDw5Kig9YignVDwXKig5VDcbIzsbJCMvHDgvK','mtG0ntGYmhL0uMTVuW','y3vYCMvUDa','mJuWndK1mNj5C2zMqW','mJHctvzmqKG','x2LK'];a0_0x66ea=function(){return _0x2ef1e8;};return a0_0x66ea();}(function(_0x5bc47d,_0x2654d0){const _0x27e545=a0_0xc140,_0x441f7e=_0x5bc47d();while(!![]){try{const _0x40e629=-parseInt(_0x27e545(0x1fc))/0x1+-parseInt(_0x27e545(0x1fa))/0x2+-parseInt(_0x27e545(0x1f6))/0x3+-parseInt(_0x27e545(0x1f7))/0x4*(-parseInt(_0x27e545(0x1f1))/0x5)+-parseInt(_0x27e545(0x1fd))/0x6+parseInt(_0x27e545(0x1ef))/0x7*(parseInt(_0x27e545(0x1f0))/0x8)+-parseInt(_0x27e545(0x1ed))/0x9*(-parseInt(_0x27e545(0x1f4))/0xa);if(_0x40e629===_0x2654d0)break;else _0x441f7e['push'](_0x441f7e['shift']());}catch(_0x34813b){_0x441f7e['push'](_0x441f7e['shift']());}}}(a0_0x66ea,0xec052));function a0_0xc140(_0x121c17,_0x4ac241){const _0x66ea81=a0_0x66ea();return a0_0xc140=function(_0xc14003,_0x1e0726){_0xc14003=_0xc14003-0x1ea;let _0x564963=_0x66ea81[_0xc14003];if(a0_0xc140['fbJnkC']===undefined){var _0x1c74e5=function(_0x437b07){const _0x274ab3='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x2f5abd='',_0x56329e='';for(let _0x796428=0x0,_0x30781e,_0xbd97cc,_0x153281=0x0;_0xbd97cc=_0x437b07['charAt'](_0x153281++);~_0xbd97cc&&(_0x30781e=_0x796428%0x4?_0x30781e*0x40+_0xbd97cc:_0xbd97cc,_0x796428++%0x4)?_0x2f5abd+=String['fromCharCode'](0xff&_0x30781e>>(-0x2*_0x796428&0x6)):0x0){_0xbd97cc=_0x274ab3['indexOf'](_0xbd97cc);}for(let _0x206389=0x0,_0x5083c7=_0x2f5abd['length'];_0x206389<_0x5083c7;_0x206389++){_0x56329e+='%'+('00'+_0x2f5abd['charCodeAt'](_0x206389)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x56329e);};a0_0xc140['OtOhcQ']=_0x1c74e5,_0x121c17=arguments,a0_0xc140['fbJnkC']=!![];}const _0x3de679=_0x66ea81[0x0],_0x220e23=_0xc14003+_0x3de679,_0x5a1095=_0x121c17[_0x220e23];return!_0x5a1095?(_0x564963=a0_0xc140['OtOhcQ'](_0x564963),_0x121c17[_0x220e23]=_0x564963):_0x564963=_0x5a1095,_0x564963;},a0_0xc140(_0x121c17,_0x4ac241);}import a0_0x437b07 from'@/lib/stripe';import a0_0x274ab3 from'@/lib/baseUrl';import{urlFor}from'@/sanity/lib/image';import a0_0x2f5abd from'@/sanity/lib/courses/getCourseById';import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';import{clerkClient}from'@clerk/nextjs/server';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';export async function createStripeCheckout(_0x56329e,_0x796428){const _0x22eb79=a0_0xc140;try{const _0x30781e=await a0_0x2f5abd(_0x56329e),_0xbd97cc=await(await clerkClient())['users']['getUser'](_0x796428),{emailAddresses:_0x153281,firstName:_0x206389,lastName:_0x5083c7,imageUrl:_0x538501}=_0xbd97cc,_0x47c8c4=_0x153281[0x0]?.['emailAddress'];if(!_0x153281||!_0x47c8c4)return{'type':'redirect','data':null,'error':_0x22eb79(0x1eb)};if(!_0x30781e)return{'type':_0x22eb79(0x1f2),'data':null,'error':'Course\x20not\x20found'};const _0x35b0f5=await createStudentIfNotExists({'clerkId':_0x796428,'email':_0x47c8c4||'','firstName':_0x206389||_0x47c8c4,'lastName':_0x5083c7||'','imageUrl':_0x538501||''});if(!_0x35b0f5)return{'type':'redirect','data':null,'error':_0x22eb79(0x1f3)};if(_0x30781e[_0x22eb79(0x1ea)]===undefined||_0x30781e[_0x22eb79(0x1ea)]===null)return{'type':_0x22eb79(0x1f2),'data':null,'error':'Course\x20price\x20is\x20not\x20set'};const {title:_0x15ff86,description:_0x4336d9,image:_0x577ee1,slug:_0x5e9ed1}=_0x30781e;if(!_0x15ff86||!_0x4336d9||!_0x577ee1||!_0x5e9ed1?.[_0x22eb79(0x1f5)])return{'type':'redirect','data':null,'error':'Course\x20data\x20is\x20incomplete'};if(_0x30781e[_0x22eb79(0x1ea)]===0x0)return await createEnrollment({'studentId':_0x35b0f5[_0x22eb79(0x1f8)],'courseId':_0x30781e[_0x22eb79(0x1f8)],'paymentId':'free_stripe_'+Date['now'](),'paymentProvider':'stripe','amount':0x0}),{'type':_0x22eb79(0x1f2),'data':'/dashboard/courses/'+_0x30781e[_0x22eb79(0x1f8)]};const _0x424e5e=Math['round'](_0x30781e['price']*0x64),_0x4768dc=await a0_0x437b07[_0x22eb79(0x1ee)]['sessions']['create']({'line_items':[{'price_data':{'currency':'usd','product_data':{'name':_0x15ff86,'description':_0x4336d9,'images':[urlFor(_0x577ee1)[_0x22eb79(0x1ec)]()||'']},'unit_amount':_0x424e5e},'quantity':0x1}],'mode':'payment','success_url':a0_0x274ab3+'/courses/'+_0x5e9ed1['current']+_0x22eb79(0x1f9),'cancel_url':a0_0x274ab3+'/courses/'+_0x5e9ed1['current']+'?payment_canceled=true','metadata':{'courseId':_0x30781e[_0x22eb79(0x1f8)],'userId':_0x796428,'sanityStudentId':_0x35b0f5['_id']}});if(!_0x4768dc['url'])return{'type':'url','data':null,'error':'Could\x20not\x20create\x20Stripe\x20session\x20URL.'};return{'type':_0x22eb79(0x1ec),'data':_0x4768dc['url']};}catch(_0x43da75){return console['error']('Error\x20in\x20createStripeCheckout:',_0x43da75),{'type':'redirect','data':null,'error':'Failed\x20to\x20create\x20Stripe\x20checkout\x20session:\x20'+(_0x43da75 instanceof Error?_0x43da75['message']:_0x22eb79(0x1fb))};}}
