"use server";

'use server';(function(_0x496e97,_0x4793bd){const _0x4b340a=a0_0x63ef,_0x18e065=_0x496e97();while(!![]){try{const _0x31320e=parseInt(_0x4b340a(0xdd))/0x1+-parseInt(_0x4b340a(0xe8))/0x2*(-parseInt(_0x4b340a(0xeb))/0x3)+parseInt(_0x4b340a(0xe4))/0x4*(-parseInt(_0x4b340a(0xdc))/0x5)+parseInt(_0x4b340a(0xea))/0x6+-parseInt(_0x4b340a(0xe9))/0x7+parseInt(_0x4b340a(0xe6))/0x8*(-parseInt(_0x4b340a(0xe2))/0x9)+parseInt(_0x4b340a(0xe3))/0xa;if(_0x31320e===_0x4793bd)break;else _0x18e065['push'](_0x18e065['shift']());}catch(_0x43465d){_0x18e065['push'](_0x18e065['shift']());}}}(a0_0x4219,0x8820a));import a0_0x4490be from'@/lib/stripe';import a0_0x59f48f from'@/lib/baseUrl';import{urlFor}from'@/sanity/lib/image';function a0_0x63ef(_0x2751f4,_0x241b13){const _0x42199a=a0_0x4219();return a0_0x63ef=function(_0x63efce,_0x52bdf5){_0x63efce=_0x63efce-0xdc;let _0x2b84be=_0x42199a[_0x63efce];return _0x2b84be;},a0_0x63ef(_0x2751f4,_0x241b13);}import a0_0x2c7032 from'@/sanity/lib/courses/getCourseById';import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';function a0_0x4219(){const _0x363d6c=['Course\x20data\x20is\x20incomplete','55dcZJlB','1062464wLYCTa','redirect','current','Course\x20not\x20found','url','164412HMXdZQ','8449070xHehQO','134684NVjBcy','emailAddress','456VsflwM','checkout','617104xyKujD','3249022sOJIYW','1304748GmXLlP','3MwMhFm'];a0_0x4219=function(){return _0x363d6c;};return a0_0x4219();}import{clerkClient}from'@clerk/nextjs/server';import{createEnrollment}from'@/sanity/lib/student/createEnrollment';export async function createStripeCheckout(_0x573bfe,_0xd8f0fa){const _0x29bcd4=a0_0x63ef;try{const _0x4e5edf=await a0_0x2c7032(_0x573bfe),_0x2077c7=await(await clerkClient())['users']['getUser'](_0xd8f0fa),{emailAddresses:_0x488380,firstName:_0x1c7e14,lastName:_0x553cb2,imageUrl:_0x1784e2}=_0x2077c7,_0x5025e4=_0x488380[0x0]?.[_0x29bcd4(0xe5)];if(!_0x488380||!_0x5025e4)return{'type':'redirect','data':null,'error':'User\x20details\x20not\x20found'};if(!_0x4e5edf)return{'type':'redirect','data':null,'error':_0x29bcd4(0xe0)};const _0x36f457=await createStudentIfNotExists({'clerkId':_0xd8f0fa,'email':_0x5025e4||'','firstName':_0x1c7e14||_0x5025e4,'lastName':_0x553cb2||'','imageUrl':_0x1784e2||''});if(!_0x36f457)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(_0x4e5edf['price']===undefined||_0x4e5edf['price']===null)return{'type':'redirect','data':null,'error':'Course\x20price\x20is\x20not\x20set'};const {title:_0x1ce0fc,description:_0x16b943,image:_0x294e37,slug:_0x4bb94b}=_0x4e5edf;if(!_0x1ce0fc||!_0x16b943||!_0x294e37||!_0x4bb94b?.[_0x29bcd4(0xdf)])return{'type':'redirect','data':null,'error':_0x29bcd4(0xec)};if(_0x4e5edf['price']===0x0)return await createEnrollment({'studentId':_0x36f457['_id'],'courseId':_0x4e5edf['_id'],'paymentId':'free_stripe_'+Date['now'](),'paymentProvider':'stripe','amount':0x0}),{'type':'redirect','data':'/dashboard/courses/'+_0x4e5edf['_id']};const _0x5e9fdb=Math['round'](_0x4e5edf['price']*0x64),_0x16a137=await a0_0x4490be[_0x29bcd4(0xe7)]['sessions']['create']({'line_items':[{'price_data':{'currency':'usd','product_data':{'name':_0x1ce0fc,'description':_0x16b943,'images':[urlFor(_0x294e37)[_0x29bcd4(0xe1)]()||'']},'unit_amount':_0x5e9fdb},'quantity':0x1}],'mode':'payment','success_url':a0_0x59f48f+'/courses/'+_0x4bb94b['current']+'?payment_success=stripe','cancel_url':a0_0x59f48f+'/courses/'+_0x4bb94b['current']+'?payment_canceled=true','metadata':{'courseId':_0x4e5edf['_id'],'userId':_0xd8f0fa,'sanityStudentId':_0x36f457['_id']}});if(!_0x16a137['url'])return{'type':'url','data':null,'error':'Could\x20not\x20create\x20Stripe\x20session\x20URL.'};return{'type':'url','data':_0x16a137['url']};}catch(_0x362c68){return console['error']('Error\x20in\x20createStripeCheckout:',_0x362c68),{'type':_0x29bcd4(0xde),'data':null,'error':'Failed\x20to\x20create\x20Stripe\x20checkout\x20session:\x20'+(_0x362c68 instanceof Error?_0x362c68['message']:'Unknown\x20error')};}}
