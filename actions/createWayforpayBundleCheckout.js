"use server";

'use server';(function(_0x2f4f0e,_0x4a4f16){const _0x27df4c=a2_0x2178,_0x1bea41=_0x2f4f0e();while(!![]){try{const _0x4a712a=parseInt(_0x27df4c(0xd3))/0x1+parseInt(_0x27df4c(0xcd))/0x2+parseInt(_0x27df4c(0xc9))/0x3+parseInt(_0x27df4c(0xcc))/0x4+parseInt(_0x27df4c(0xd2))/0x5+-parseInt(_0x27df4c(0xca))/0x6*(-parseInt(_0x27df4c(0xce))/0x7)+-parseInt(_0x27df4c(0xd8))/0x8*(parseInt(_0x27df4c(0xd4))/0x9);if(_0x4a712a===_0x4a4f16)break;else _0x1bea41['push'](_0x1bea41['shift']());}catch(_0x1ec75e){_0x1bea41['push'](_0x1bea41['shift']());}}}(a2_0xc86a,0x6dc06));function a2_0x2178(_0x1545fe,_0x21f41a){const _0xc86a5e=a2_0xc86a();return a2_0x2178=function(_0x21785d,_0x3982bb){_0x21785d=_0x21785d-0xc9;let _0x85d2ec=_0xc86a5e[_0x21785d];return _0x85d2ec;},a2_0x2178(_0x1545fe,_0x21f41a);}import{Wayforpay}from'wayforpay-ts-integration';import a2_0x4890e6 from'@/lib/baseUrl';import{getBundleById}from'@/sanity/lib/courses/getBundleById';function a2_0xc86a(){const _0x2ede08=['redirect','\x20-\x20Course\x20Bundle','Bundle\x20data\x20is\x20incomplete','1707665GbEWdJ','104057QFTvub','209862tyIJsx','now','env','WAYFORPAY_CURRENCY','632VsHEwd','973392BgqhLZ','45912fkytva','_id','1345904WOyVJj','1314292zyLLzI','483lNaqdR'];a2_0xc86a=function(){return _0x2ede08;};return a2_0xc86a();}import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';import{clerkClient}from'@clerk/nextjs/server';import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';export async function createWayforpayBundleCheckout(_0x2cd03c,_0x4ea7de){const _0x46c7e7=a2_0x2178;try{const [_0x1e805e,_0x570dcf]=await Promise['all']([getBundleById(_0x2cd03c),(await clerkClient())['users']['getUser'](_0x4ea7de)]),{emailAddresses:_0x1b20fd,firstName:_0x4f9597,lastName:_0x1176d9,imageUrl:_0x4c362a}=_0x570dcf,_0x155996=_0x1b20fd[0x0]?.['emailAddress'];if(!_0x1b20fd||!_0x155996)return{'type':_0x46c7e7(0xcf),'data':null,'error':'User\x20details\x20not\x20found'};if(!_0x1e805e)return{'type':'redirect','data':null,'error':'Bundle\x20not\x20found'};const _0x207de9=await createStudentIfNotExists({'clerkId':_0x4ea7de,'email':_0x155996||'','firstName':_0x4f9597||_0x155996,'lastName':_0x1176d9||'','imageUrl':_0x4c362a||''});if(!_0x207de9)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(_0x1e805e['price']===undefined||_0x1e805e['price']===null)return{'type':'redirect','data':null,'error':'Bundle\x20price\x20is\x20not\x20set'};const {title:_0x455c3f,description:_0x5361ef,slug:_0x409d20}=_0x1e805e;if(!_0x455c3f||!_0x5361ef||!_0x409d20)return{'type':'redirect','data':null,'error':_0x46c7e7(0xd1)};if(_0x1e805e['price']===0x0)return await createBundleEnrollment({'studentId':_0x207de9['_id'],'bundleId':_0x1e805e['_id'],'paymentId':'free_wayforpay_bundle_'+Date[_0x46c7e7(0xd5)](),'paymentProvider':'wayforpay','amount':0x0,'bundleData':_0x1e805e}),{'type':_0x46c7e7(0xcf),'data':'/my-courses'};const _0xf50f43={'merchantLogin':process['env']['WAYFORPAY_MERCHANT_LOGIN'],'merchantSecret':process['env']['WAYFORPAY_MERCHANT_SECRET_KEY'],'domain':process[_0x46c7e7(0xd6)]['WAYFORPAY_DOMAIN'],'currency':process['env'][_0x46c7e7(0xd7)]};if(!_0xf50f43['merchantLogin']||!_0xf50f43['merchantSecret']||!_0xf50f43['domain']||!_0xf50f43['currency'])return{'type':'redirect','data':null,'error':'WayForPay environment variables are not properly configured.'};const _0x105687='bundle--'+_0x1e805e[_0x46c7e7(0xcb)]+'--'+_0x4ea7de+'--'+Date['now'](),_0xee7d16=[{'product':{'name':_0x455c3f+_0x46c7e7(0xd0),'price':_0x1e805e['price']},'quantity':0x1}],_0x20b062=new Wayforpay({'merchantLogin':_0xf50f43['merchantLogin'],'merchantSecret':_0xf50f43['merchantSecret']}),_0x34b958=await _0x20b062['purchase'](_0xee7d16,{'domain':_0xf50f43['domain'],'orderReference':_0x105687,'currency':_0xf50f43['currency'],'returnUrl':a2_0x4890e6+'/payment/redirect?provider=wayforpay&type=bundle&order='+_0x105687,'serviceUrl':a2_0x4890e6+'/api/wayforpay-checout/webhook','clientFirstName':_0x4f9597||undefined,'clientLastName':_0x1176d9||undefined,'clientEmail':_0x155996||undefined});return{'type':'form','data':_0x34b958};}catch(_0x5b1f70){return console['error']('Error\x20in\x20createWayforpayBundleCheckout:',_0x5b1f70),{'type':_0x46c7e7(0xcf),'data':null,'error':'Failed\x20to\x20create\x20WayForPay\x20bundle\x20checkout:\x20'+(_0x5b1f70 instanceof Error?_0x5b1f70['message']:'Unknown\x20error')};}}
