"use server";

'use server';(function(_0x3e1ec9,_0xe53544){const _0x4d0b2a=a2_0x431b,_0x40be51=_0x3e1ec9();while(!![]){try{const _0x1dbf06=parseInt(_0x4d0b2a(0x187))/0x1*(-parseInt(_0x4d0b2a(0x185))/0x2)+parseInt(_0x4d0b2a(0x18b))/0x3*(parseInt(_0x4d0b2a(0x17f))/0x4)+-parseInt(_0x4d0b2a(0x190))/0x5*(-parseInt(_0x4d0b2a(0x182))/0x6)+parseInt(_0x4d0b2a(0x18d))/0x7*(parseInt(_0x4d0b2a(0x18c))/0x8)+parseInt(_0x4d0b2a(0x18e))/0x9*(parseInt(_0x4d0b2a(0x18a))/0xa)+-parseInt(_0x4d0b2a(0x18f))/0xb+parseInt(_0x4d0b2a(0x180))/0xc*(-parseInt(_0x4d0b2a(0x186))/0xd);if(_0x1dbf06===_0xe53544)break;else _0x40be51['push'](_0x40be51['shift']());}catch(_0xf03d1){_0x40be51['push'](_0x40be51['shift']());}}}(a2_0x9638,0xbcdeb));import{Wayforpay}from'wayforpay-ts-integration';function a2_0x9638(){const _0x250c6e=['_id','4zeNpfJ','49548pbblOz','currency','7263072gAygii','merchantSecret','redirect','354244xbINdC','4199CVaMgL','8AKSYDB','price','\x20-\x20Course\x20Bundle','2208970ktMCtB','3285147mQjPGH','8NeFGUi','9739506TxxINU','27bxwTWR','9188916UFfzfU','5yJMSxH','merchantLogin','Bundle\x20price\x20is\x20not\x20set'];a2_0x9638=function(){return _0x250c6e;};return a2_0x9638();}import a2_0x41a0ef from'@/lib/baseUrl';function a2_0x431b(_0x495f45,_0x1719e0){const _0x963834=a2_0x9638();return a2_0x431b=function(_0x431b4b,_0x2796ab){_0x431b4b=_0x431b4b-0x17f;let _0x55cb8d=_0x963834[_0x431b4b];return _0x55cb8d;},a2_0x431b(_0x495f45,_0x1719e0);}import{getBundleById}from'@/sanity/lib/courses/getBundleById';import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';import{clerkClient}from'@clerk/nextjs/server';import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';export async function createWayforpayBundleCheckout(_0x3493ba,_0x3579b8){const _0x4ec2b9=a2_0x431b;try{const [_0x39e009,_0x8821db]=await Promise['all']([getBundleById(_0x3493ba),(await clerkClient())['users']['getUser'](_0x3579b8)]),{emailAddresses:_0x3edf98,firstName:_0x406806,lastName:_0x797752,imageUrl:_0x161cea}=_0x8821db,_0x262d37=_0x3edf98[0x0]?.['emailAddress'];if(!_0x3edf98||!_0x262d37)return{'type':'redirect','data':null,'error':'User\x20details\x20not\x20found'};if(!_0x39e009)return{'type':_0x4ec2b9(0x184),'data':null,'error':'Bundle\x20not\x20found'};const _0x310f66=await createStudentIfNotExists({'clerkId':_0x3579b8,'email':_0x262d37||'','firstName':_0x406806||_0x262d37,'lastName':_0x797752||'','imageUrl':_0x161cea||''});if(!_0x310f66)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(_0x39e009['price']===undefined||_0x39e009['price']===null)return{'type':'redirect','data':null,'error':_0x4ec2b9(0x192)};const {title:_0x22c9ec,description:_0x20f758,slug:_0x5e27ae}=_0x39e009;if(!_0x22c9ec||!_0x20f758||!_0x5e27ae)return{'type':'redirect','data':null,'error':'Bundle\x20data\x20is\x20incomplete'};if(_0x39e009[_0x4ec2b9(0x188)]===0x0)return await createBundleEnrollment({'studentId':_0x310f66[_0x4ec2b9(0x193)],'bundleId':_0x39e009['_id'],'paymentId':'free_wayforpay_bundle_'+Date['now'](),'paymentProvider':'wayforpay','amount':0x0,'bundleData':_0x39e009}),{'type':'redirect','data':'/my-courses'};const _0x3361d6={'merchantLogin':process['env']['WAYFORPAY_MERCHANT_LOGIN'],'merchantSecret':process['env']['WAYFORPAY_MERCHANT_SECRET_KEY'],'domain':process['env']['WAYFORPAY_DOMAIN'],'currency':process['env']['WAYFORPAY_CURRENCY']};if(!_0x3361d6['merchantLogin']||!_0x3361d6[_0x4ec2b9(0x183)]||!_0x3361d6['domain']||!_0x3361d6[_0x4ec2b9(0x181)])return{'type':_0x4ec2b9(0x184),'data':null,'error':'WayForPay environment variables are not properly configured.'};const _0x5687e2='bundle--'+_0x39e009['_id']+'--'+_0x3579b8+'--'+Date['now'](),_0x5b12e5=[{'product':{'name':_0x22c9ec+_0x4ec2b9(0x189),'price':_0x39e009['price']},'quantity':0x1}],_0xbbfd99=new Wayforpay({'merchantLogin':_0x3361d6[_0x4ec2b9(0x191)],'merchantSecret':_0x3361d6['merchantSecret']}),_0x48876a=await _0xbbfd99['purchase'](_0x5b12e5,{'domain':_0x3361d6['domain'],'orderReference':_0x5687e2,'currency':_0x3361d6['currency'],'returnUrl':a2_0x41a0ef+'/payment/redirect?provider=wayforpay&type=bundle&order='+_0x5687e2,'serviceUrl':a2_0x41a0ef+'/api/wayforpay-checout/webhook','clientFirstName':_0x406806||undefined,'clientLastName':_0x797752||undefined,'clientEmail':_0x262d37||undefined});return{'type':'form','data':_0x48876a};}catch(_0x206568){return console['error']('Error\x20in\x20createWayforpayBundleCheckout:',_0x206568),{'type':'redirect','data':null,'error':'Failed\x20to\x20create\x20WayForPay\x20bundle\x20checkout:\x20'+(_0x206568 instanceof Error?_0x206568['message']:'Unknown\x20error')};}}
