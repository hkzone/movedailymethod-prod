"use server";

'use server';function a2_0x2e21(){const _0x4a6cff=['650076nmXKGu','488594LlqPMC','Bundle\x20price\x20is\x20not\x20set','2793165uwSzCl','3218747OCFOSI','1dUeftz','6068152bTpfui','merchantSecret','now','733746FWrDxH','_id','\x20-\x20Course\x20Bundle','1379856mxhdIA','9JawzzL'];a2_0x2e21=function(){return _0x4a6cff;};return a2_0x2e21();}(function(_0x3e0426,_0x1a63b6){const _0x39f0ce=a2_0x2855,_0x2907ea=_0x3e0426();while(!![]){try{const _0x5a7411=parseInt(_0x39f0ce(0xa8))/0x1*(-parseInt(_0x39f0ce(0xa4))/0x2)+-parseInt(_0x39f0ce(0xac))/0x3+parseInt(_0x39f0ce(0xa3))/0x4+parseInt(_0x39f0ce(0xa6))/0x5+-parseInt(_0x39f0ce(0xa1))/0x6+-parseInt(_0x39f0ce(0xa7))/0x7+parseInt(_0x39f0ce(0xa9))/0x8*(parseInt(_0x39f0ce(0xa2))/0x9);if(_0x5a7411===_0x1a63b6)break;else _0x2907ea['push'](_0x2907ea['shift']());}catch(_0x396d1c){_0x2907ea['push'](_0x2907ea['shift']());}}}(a2_0x2e21,0x497c3));import{Wayforpay}from'wayforpay-ts-integration';import a2_0x5d5a60 from'@/lib/baseUrl';import{getBundleById}from'@/sanity/lib/courses/getBundleById';import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';function a2_0x2855(_0x74e371,_0x5717ee){const _0x2e2181=a2_0x2e21();return a2_0x2855=function(_0x2855e5,_0x506a5f){_0x2855e5=_0x2855e5-0x9f;let _0x4d87f4=_0x2e2181[_0x2855e5];return _0x4d87f4;},a2_0x2855(_0x74e371,_0x5717ee);}import{clerkClient}from'@clerk/nextjs/server';import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';export async function createWayforpayBundleCheckout(_0x47d184,_0x5c014e){const _0x14eda7=a2_0x2855;try{const [_0x2fa26d,_0x441aba]=await Promise['all']([getBundleById(_0x47d184),(await clerkClient())['users']['getUser'](_0x5c014e)]),{emailAddresses:_0x188879,firstName:_0x310805,lastName:_0x4838ea,imageUrl:_0x3dbc8f}=_0x441aba,_0xca7993=_0x188879[0x0]?.['emailAddress'];if(!_0x188879||!_0xca7993)return{'type':'redirect','data':null,'error':'User\x20details\x20not\x20found'};if(!_0x2fa26d)return{'type':'redirect','data':null,'error':'Bundle\x20not\x20found'};const _0x2c7989=await createStudentIfNotExists({'clerkId':_0x5c014e,'email':_0xca7993||'','firstName':_0x310805||_0xca7993,'lastName':_0x4838ea||'','imageUrl':_0x3dbc8f||''});if(!_0x2c7989)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(_0x2fa26d['price']===undefined||_0x2fa26d['price']===null)return{'type':'redirect','data':null,'error':_0x14eda7(0xa5)};const {title:_0x378b23,description:_0x2915d3,slug:_0x13a8b7}=_0x2fa26d;if(!_0x378b23||!_0x2915d3||!_0x13a8b7)return{'type':'redirect','data':null,'error':'Bundle\x20data\x20is\x20incomplete'};if(_0x2fa26d['price']===0x0)return await createBundleEnrollment({'studentId':_0x2c7989['_id'],'bundleId':_0x2fa26d['_id'],'paymentId':'free_wayforpay_bundle_'+Date['now'](),'paymentProvider':'wayforpay','amount':0x0,'bundleData':_0x2fa26d}),{'type':'redirect','data':'/my-courses'};const _0x4cf9a9={'merchantLogin':process['env']['WAYFORPAY_MERCHANT_LOGIN'],'merchantSecret':process['env']['WAYFORPAY_MERCHANT_SECRET_KEY'],'domain':process['env']['WAYFORPAY_DOMAIN'],'currency':process['env']['WAYFORPAY_CURRENCY']};if(!_0x4cf9a9['merchantLogin']||!_0x4cf9a9[_0x14eda7(0xaa)]||!_0x4cf9a9['domain']||!_0x4cf9a9['currency'])return{'type':'redirect','data':null,'error':'WayForPay environment variables are not properly configured.'};const _0x53998e='bundle--'+_0x2fa26d[_0x14eda7(0x9f)]+'--'+_0x5c014e+'--'+Date[_0x14eda7(0xab)](),_0x564949=[{'product':{'name':_0x378b23+_0x14eda7(0xa0),'price':_0x2fa26d['price']},'quantity':0x1}],_0x8d06f8=new Wayforpay({'merchantLogin':_0x4cf9a9['merchantLogin'],'merchantSecret':_0x4cf9a9['merchantSecret']}),_0x544874=await _0x8d06f8['purchase'](_0x564949,{'domain':_0x4cf9a9['domain'],'orderReference':_0x53998e,'currency':_0x4cf9a9['currency'],'returnUrl':a2_0x5d5a60+'/payment/redirect?provider=wayforpay&type=bundle&order='+_0x53998e,'serviceUrl':a2_0x5d5a60+'/api/wayforpay-checout/webhook','clientFirstName':_0x310805||undefined,'clientLastName':_0x4838ea||undefined,'clientEmail':_0xca7993||undefined});return{'type':'form','data':_0x544874};}catch(_0x51750f){return console['error']('Error\x20in\x20createWayforpayBundleCheckout:',_0x51750f),{'type':'redirect','data':null,'error':'Failed\x20to\x20create\x20WayForPay\x20bundle\x20checkout:\x20'+(_0x51750f instanceof Error?_0x51750f['message']:'Unknown\x20error')};}}
