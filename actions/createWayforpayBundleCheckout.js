"use server";

'use server';(function(_0x46b0cf,_0x36edc4){const _0x56cf0a=a2_0x599c,_0x53af88=_0x46b0cf();while(!![]){try{const _0x2289e2=-parseInt(_0x56cf0a(0x9a))/0x1+parseInt(_0x56cf0a(0x9d))/0x2+-parseInt(_0x56cf0a(0x99))/0x3*(-parseInt(_0x56cf0a(0xa1))/0x4)+parseInt(_0x56cf0a(0x9e))/0x5*(-parseInt(_0x56cf0a(0x9b))/0x6)+-parseInt(_0x56cf0a(0xa3))/0x7+-parseInt(_0x56cf0a(0x96))/0x8*(parseInt(_0x56cf0a(0x9c))/0x9)+parseInt(_0x56cf0a(0xa4))/0xa;if(_0x2289e2===_0x36edc4)break;else _0x53af88['push'](_0x53af88['shift']());}catch(_0x13c76e){_0x53af88['push'](_0x53af88['shift']());}}}(a2_0x2eab,0xd2c38));function a2_0x2eab(){const _0x43ef3f=['message','all','152beaHGt','env','8527330emLPAc','59004780LIeQFs','2747944DVNDDo','redirect','_id','16524BUDQib','1593171OIsCuF','10169784rspceb','27yaagJx','580620NhQxLK','5rsKZsN'];a2_0x2eab=function(){return _0x43ef3f;};return a2_0x2eab();}import{Wayforpay}from'wayforpay-ts-integration';import a2_0x104fb9 from'@/lib/baseUrl';import{getBundleById}from'@/sanity/lib/courses/getBundleById';import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';import{clerkClient}from'@clerk/nextjs/server';function a2_0x599c(_0x1aee33,_0x739720){const _0x2eab4a=a2_0x2eab();return a2_0x599c=function(_0x599c9b,_0x5acd09){_0x599c9b=_0x599c9b-0x96;let _0x2cfd99=_0x2eab4a[_0x599c9b];return _0x2cfd99;},a2_0x599c(_0x1aee33,_0x739720);}import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';export async function createWayforpayBundleCheckout(_0x1e44b4,_0xa351d4){const _0x3b9233=a2_0x599c;try{const [_0x22ae2f,_0x40154b]=await Promise[_0x3b9233(0xa0)]([getBundleById(_0x1e44b4),(await clerkClient())['users']['getUser'](_0xa351d4)]),{emailAddresses:_0x636507,firstName:_0x40b770,lastName:_0x2ab29e,imageUrl:_0x793d6}=_0x40154b,_0x3aeb07=_0x636507[0x0]?.['emailAddress'];if(!_0x636507||!_0x3aeb07)return{'type':'redirect','data':null,'error':'User\x20details\x20not\x20found'};if(!_0x22ae2f)return{'type':'redirect','data':null,'error':'Bundle\x20not\x20found'};const _0xfa74c7=await createStudentIfNotExists({'clerkId':_0xa351d4,'email':_0x3aeb07||'','firstName':_0x40b770||_0x3aeb07,'lastName':_0x2ab29e||'','imageUrl':_0x793d6||''});if(!_0xfa74c7)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(_0x22ae2f['price']===undefined||_0x22ae2f['price']===null)return{'type':'redirect','data':null,'error':'Bundle\x20price\x20is\x20not\x20set'};const {title:_0x2b9e3c,description:_0xd1224b,slug:_0x2d4bcb}=_0x22ae2f;if(!_0x2b9e3c||!_0xd1224b||!_0x2d4bcb)return{'type':'redirect','data':null,'error':'Bundle\x20data\x20is\x20incomplete'};if(_0x22ae2f['price']===0x0)return await createBundleEnrollment({'studentId':_0xfa74c7['_id'],'bundleId':_0x22ae2f['_id'],'paymentId':'free_wayforpay_bundle_'+Date['now'](),'paymentProvider':'wayforpay','amount':0x0,'bundleData':_0x22ae2f}),{'type':_0x3b9233(0x97),'data':'/my-courses'};const _0x4ae1f9={'merchantLogin':process['env']['WAYFORPAY_MERCHANT_LOGIN'],'merchantSecret':process['env']['WAYFORPAY_MERCHANT_SECRET_KEY'],'domain':process[_0x3b9233(0xa2)]['WAYFORPAY_DOMAIN'],'currency':process['env']['WAYFORPAY_CURRENCY']};if(!_0x4ae1f9['merchantLogin']||!_0x4ae1f9['merchantSecret']||!_0x4ae1f9['domain']||!_0x4ae1f9['currency'])return{'type':'redirect','data':null,'error':'WayForPay environment variables are not properly configured.'};const _0x6fd383='bundle--'+_0x22ae2f[_0x3b9233(0x98)]+'--'+_0xa351d4+'--'+Date['now'](),_0x1b3abd=[{'product':{'name':_0x2b9e3c+'\x20-\x20Course\x20Bundle','price':_0x22ae2f['price']},'quantity':0x1}],_0x494773=new Wayforpay({'merchantLogin':_0x4ae1f9['merchantLogin'],'merchantSecret':_0x4ae1f9['merchantSecret']}),_0x1544e7=await _0x494773['purchase'](_0x1b3abd,{'domain':_0x4ae1f9['domain'],'orderReference':_0x6fd383,'currency':_0x4ae1f9['currency'],'returnUrl':a2_0x104fb9+'/payment/redirect?provider=wayforpay&type=bundle&order='+_0x6fd383,'serviceUrl':a2_0x104fb9+'/api/wayforpay-checout/webhook','clientFirstName':_0x40b770||undefined,'clientLastName':_0x2ab29e||undefined,'clientEmail':_0x3aeb07||undefined});return{'type':'form','data':_0x1544e7};}catch(_0x3e9abf){return console['error']('Error\x20in\x20createWayforpayBundleCheckout:',_0x3e9abf),{'type':'redirect','data':null,'error':'Failed\x20to\x20create\x20WayForPay\x20bundle\x20checkout:\x20'+(_0x3e9abf instanceof Error?_0x3e9abf[_0x3b9233(0x9f)]:'Unknown\x20error')};}}
