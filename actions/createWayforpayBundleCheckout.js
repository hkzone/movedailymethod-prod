"use server";

'use server';(function(_0x344e19,_0x153158){const _0x4d4614=a2_0x2737,_0x49dd29=_0x344e19();while(!![]){try{const _0x7bbbea=parseInt(_0x4d4614(0x1f1))/0x1*(parseInt(_0x4d4614(0x1f7))/0x2)+parseInt(_0x4d4614(0x1f3))/0x3*(parseInt(_0x4d4614(0x1f6))/0x4)+parseInt(_0x4d4614(0x1f2))/0x5*(-parseInt(_0x4d4614(0x1ee))/0x6)+parseInt(_0x4d4614(0x1fb))/0x7*(-parseInt(_0x4d4614(0x1f9))/0x8)+-parseInt(_0x4d4614(0x1f0))/0x9*(-parseInt(_0x4d4614(0x1f4))/0xa)+parseInt(_0x4d4614(0x1fd))/0xb*(-parseInt(_0x4d4614(0x1fc))/0xc)+-parseInt(_0x4d4614(0x1fa))/0xd*(parseInt(_0x4d4614(0x1fe))/0xe);if(_0x7bbbea===_0x153158)break;else _0x49dd29['push'](_0x49dd29['shift']());}catch(_0x1ec863){_0x49dd29['push'](_0x49dd29['shift']());}}}(a2_0x5a9f,0x269ec));import{Wayforpay}from'wayforpay-ts-integration';import a2_0x3b2920 from'@/lib/baseUrl';import{getBundleById}from'@/sanity/lib/courses/getBundleById';import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';function a2_0x5a9f(){const _0xbe6b2d=['price','957256ozWLrM','226876tHmpxG','7iOiMnv','276CnOTCz','80278dstIFj','42uZkzMh','186sTmNYA','Failed\x20to\x20create\x20WayForPay\x20bundle\x20checkout:\x20','3357wbQRZi','259591YnRFQZ','2935UvpOhA','3OyCnYp','1390KMPEBP','env','819256kmObYO','2uxguMq'];a2_0x5a9f=function(){return _0xbe6b2d;};return a2_0x5a9f();}import{clerkClient}from'@clerk/nextjs/server';import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';function a2_0x2737(_0x4b7eb3,_0x55b98c){const _0x5a9f27=a2_0x5a9f();return a2_0x2737=function(_0x2737cd,_0x175a1e){_0x2737cd=_0x2737cd-0x1ee;let _0x1bb3d2=_0x5a9f27[_0x2737cd];return _0x1bb3d2;},a2_0x2737(_0x4b7eb3,_0x55b98c);}export async function createWayforpayBundleCheckout(_0x500f29,_0x5dd910){const _0x24f884=a2_0x2737;try{const [_0x3c5dac,_0x186bbf]=await Promise['all']([getBundleById(_0x500f29),(await clerkClient())['users']['getUser'](_0x5dd910)]),{emailAddresses:_0x545179,firstName:_0x57da79,lastName:_0x121dc1,imageUrl:_0x581256}=_0x186bbf,_0x1f4e84=_0x545179[0x0]?.['emailAddress'];if(!_0x545179||!_0x1f4e84)return{'type':'redirect','data':null,'error':'User\x20details\x20not\x20found'};if(!_0x3c5dac)return{'type':'redirect','data':null,'error':'Bundle\x20not\x20found'};const _0x30341c=await createStudentIfNotExists({'clerkId':_0x5dd910,'email':_0x1f4e84||'','firstName':_0x57da79||_0x1f4e84,'lastName':_0x121dc1||'','imageUrl':_0x581256||''});if(!_0x30341c)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(_0x3c5dac[_0x24f884(0x1f8)]===undefined||_0x3c5dac['price']===null)return{'type':'redirect','data':null,'error':'Bundle\x20price\x20is\x20not\x20set'};const {title:_0x3f4c07,description:_0x5b4784,slug:_0x47fde9}=_0x3c5dac;if(!_0x3f4c07||!_0x5b4784||!_0x47fde9)return{'type':'redirect','data':null,'error':'Bundle\x20data\x20is\x20incomplete'};if(_0x3c5dac['price']===0x0)return await createBundleEnrollment({'studentId':_0x30341c['_id'],'bundleId':_0x3c5dac['_id'],'paymentId':'free_wayforpay_bundle_'+Date['now'](),'paymentProvider':'wayforpay','amount':0x0,'bundleData':_0x3c5dac}),{'type':'redirect','data':'/my-courses'};const _0x524b29={'merchantLogin':process['env']['WAYFORPAY_MERCHANT_LOGIN'],'merchantSecret':process['env']['WAYFORPAY_MERCHANT_SECRET_KEY'],'domain':process[_0x24f884(0x1f5)]['WAYFORPAY_DOMAIN'],'currency':process['env']['WAYFORPAY_CURRENCY']};if(!_0x524b29['merchantLogin']||!_0x524b29['merchantSecret']||!_0x524b29['domain']||!_0x524b29['currency'])return{'type':'redirect','data':null,'error':'WayForPay environment variables are not properly configured.'};const _0xca154c='bundle--'+_0x3c5dac['_id']+'--'+_0x5dd910+'--'+Date['now'](),_0x588601=[{'product':{'name':_0x3f4c07+'\x20-\x20Course\x20Bundle','price':_0x3c5dac['price']},'quantity':0x1}],_0x29a4af=new Wayforpay({'merchantLogin':_0x524b29['merchantLogin'],'merchantSecret':_0x524b29['merchantSecret']}),_0x54fbc8=await _0x29a4af['purchase'](_0x588601,{'domain':_0x524b29['domain'],'orderReference':_0xca154c,'currency':_0x524b29['currency'],'returnUrl':a2_0x3b2920+'/payment/redirect?provider=wayforpay&type=bundle&order='+_0xca154c,'serviceUrl':a2_0x3b2920+'/api/wayforpay-checout/webhook','clientFirstName':_0x57da79||undefined,'clientLastName':_0x121dc1||undefined,'clientEmail':_0x1f4e84||undefined});return{'type':'form','data':_0x54fbc8};}catch(_0x337d00){return console['error']('Error\x20in\x20createWayforpayBundleCheckout:',_0x337d00),{'type':'redirect','data':null,'error':_0x24f884(0x1ef)+(_0x337d00 instanceof Error?_0x337d00['message']:'Unknown\x20error')};}}
