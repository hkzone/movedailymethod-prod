"use server";

'use server';(function(_0x57cb54,_0x3ebd59){const _0x52d03e=a2_0x3396,_0xc89adb=_0x57cb54();while(!![]){try{const _0x59568b=parseInt(_0x52d03e(0x119))/0x1+-parseInt(_0x52d03e(0x118))/0x2*(parseInt(_0x52d03e(0x117))/0x3)+parseInt(_0x52d03e(0x11c))/0x4*(parseInt(_0x52d03e(0x112))/0x5)+parseInt(_0x52d03e(0x11a))/0x6+parseInt(_0x52d03e(0x111))/0x7+-parseInt(_0x52d03e(0x113))/0x8*(-parseInt(_0x52d03e(0x115))/0x9)+-parseInt(_0x52d03e(0x11d))/0xa*(parseInt(_0x52d03e(0x114))/0xb);if(_0x59568b===_0x3ebd59)break;else _0xc89adb['push'](_0xc89adb['shift']());}catch(_0x130069){_0xc89adb['push'](_0xc89adb['shift']());}}}(a2_0x56e2,0x1c62a));import{Wayforpay}from'wayforpay-ts-integration';import a2_0x3e5c6f from'@/lib/baseUrl';import{getBundleById}from'@/sanity/lib/courses/getBundleById';function a2_0x56e2(){const _0x4753ec=['3CWPHGo','201038CNrFXT','194418HBbJRq','471486PUVgie','redirect','21304uhdeEV','4521430CsjSih','220619oHysjX','155JpNJHQ','797224rMzIBr','11AVhMFA','18raVCIr','Bundle\x20not\x20found'];a2_0x56e2=function(){return _0x4753ec;};return a2_0x56e2();}function a2_0x3396(_0x5a97d7,_0x2d59c2){const _0x56e2fd=a2_0x56e2();return a2_0x3396=function(_0x33960c,_0x13da8b){_0x33960c=_0x33960c-0x111;let _0x2456f1=_0x56e2fd[_0x33960c];return _0x2456f1;},a2_0x3396(_0x5a97d7,_0x2d59c2);}import{createStudentIfNotExists}from'@/sanity/lib/student/createStudentIfNotExists';import{clerkClient}from'@clerk/nextjs/server';import{createBundleEnrollment}from'@/sanity/lib/student/createBundleEnrollment';export async function createWayforpayBundleCheckout(_0x5ea2cb,_0x2e9700){const _0x172f5f=a2_0x3396;try{const [_0xa382e3,_0x22d59c]=await Promise['all']([getBundleById(_0x5ea2cb),(await clerkClient())['users']['getUser'](_0x2e9700)]),{emailAddresses:_0x465a99,firstName:_0x21e043,lastName:_0x1e43f9,imageUrl:_0x37ef0e}=_0x22d59c,_0x66dd52=_0x465a99[0x0]?.['emailAddress'];if(!_0x465a99||!_0x66dd52)return{'type':_0x172f5f(0x11b),'data':null,'error':'User\x20details\x20not\x20found'};if(!_0xa382e3)return{'type':'redirect','data':null,'error':_0x172f5f(0x116)};const _0x466314=await createStudentIfNotExists({'clerkId':_0x2e9700,'email':_0x66dd52||'','firstName':_0x21e043||_0x66dd52,'lastName':_0x1e43f9||'','imageUrl':_0x37ef0e||''});if(!_0x466314)return{'type':'redirect','data':null,'error':'Sanity\x20user\x20not\x20found\x20or\x20could\x20not\x20be\x20created'};if(_0xa382e3['price']===undefined||_0xa382e3['price']===null)return{'type':'redirect','data':null,'error':'Bundle\x20price\x20is\x20not\x20set'};const {title:_0x8c3f6f,description:_0x4c3dc9,slug:_0xffe844}=_0xa382e3;if(!_0x8c3f6f||!_0x4c3dc9||!_0xffe844)return{'type':'redirect','data':null,'error':'Bundle\x20data\x20is\x20incomplete'};if(_0xa382e3['price']===0x0)return await createBundleEnrollment({'studentId':_0x466314['_id'],'bundleId':_0xa382e3['_id'],'paymentId':'free_wayforpay_bundle_'+Date['now'](),'paymentProvider':'wayforpay','amount':0x0,'bundleData':_0xa382e3}),{'type':'redirect','data':'/my-courses'};const _0x340a65={'merchantLogin':process['env']['WAYFORPAY_MERCHANT_LOGIN'],'merchantSecret':process['env']['WAYFORPAY_MERCHANT_SECRET_KEY'],'domain':process['env']['WAYFORPAY_DOMAIN'],'currency':process['env']['WAYFORPAY_CURRENCY']};if(!_0x340a65['merchantLogin']||!_0x340a65['merchantSecret']||!_0x340a65['domain']||!_0x340a65['currency'])return{'type':'redirect','data':null,'error':'WayForPay environment variables are not properly configured.'};const _0x37fe71='bundle--'+_0xa382e3['_id']+'--'+_0x2e9700+'--'+Date['now'](),_0x497749=[{'product':{'name':_0x8c3f6f+'\x20-\x20Course\x20Bundle','price':_0xa382e3['price']},'quantity':0x1}],_0x440661=new Wayforpay({'merchantLogin':_0x340a65['merchantLogin'],'merchantSecret':_0x340a65['merchantSecret']}),_0x148feb=await _0x440661['purchase'](_0x497749,{'domain':_0x340a65['domain'],'orderReference':_0x37fe71,'currency':_0x340a65['currency'],'returnUrl':a2_0x3e5c6f+'/payment/redirect?provider=wayforpay&type=bundle&order='+_0x37fe71,'serviceUrl':a2_0x3e5c6f+'/api/wayforpay-checout/webhook','clientFirstName':_0x21e043||undefined,'clientLastName':_0x1e43f9||undefined,'clientEmail':_0x66dd52||undefined});return{'type':'form','data':_0x148feb};}catch(_0x2b4f88){return console['error']('Error\x20in\x20createWayforpayBundleCheckout:',_0x2b4f88),{'type':'redirect','data':null,'error':'Failed\x20to\x20create\x20WayForPay\x20bundle\x20checkout:\x20'+(_0x2b4f88 instanceof Error?_0x2b4f88['message']:'Unknown\x20error')};}}
