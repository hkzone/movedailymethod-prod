(function(_0x357821,_0xe74b46){const _0x1e2947=a29_0x3abb,_0x3016ae=_0x357821();while(!![]){try{const _0x1524dd=-parseInt(_0x1e2947(0x97))/0x1+parseInt(_0x1e2947(0x9a))/0x2+parseInt(_0x1e2947(0x9c))/0x3+parseInt(_0x1e2947(0x99))/0x4+parseInt(_0x1e2947(0x95))/0x5+parseInt(_0x1e2947(0x98))/0x6+-parseInt(_0x1e2947(0x9f))/0x7;if(_0x1524dd===_0xe74b46)break;else _0x3016ae['push'](_0x3016ae['shift']());}catch(_0x566855){_0x3016ae['push'](_0x3016ae['shift']());}}}(a29_0x4851,0x7de96));import{client}from'../adminClient';import{createEnrollment}from'./createEnrollment';async function getExistingEnrollments(_0x5a8512,_0x8ce1ff){const _0x41e0f2='*[_type\x20==\x20\x22enrollment\x22\x20&&\x20student._ref\x20==\x20$studentId\x20&&\x20course._ref\x20in\x20$courseIds]\x20{\x0a\x20\x20\x20\x20_id,\x0a\x20\x20\x20\x20\x22courseId\x22:\x20course._ref\x0a\x20\x20}',_0x4f2f9c=await client['fetch'](_0x41e0f2,{'studentId':_0x5a8512,'courseIds':_0x8ce1ff});return _0x4f2f9c||[];}function a29_0x3abb(_0x1ec3ee,_0x577344){const _0x485179=a29_0x4851();return a29_0x3abb=function(_0x3abb3c,_0x29782b){_0x3abb3c=_0x3abb3c-0x92;let _0x141a11=_0x485179[_0x3abb3c];return _0x141a11;},a29_0x3abb(_0x1ec3ee,_0x577344);}function a29_0x4851(){const _0x3842fe=['length','683474AySqRl','1476732vdjmxa','2492232IXRAlQ','901056GnwLBw','\x20course\x20enrollments','2378739pUIOHl','_id','filter','13283704lTCGhw','includes','description','course','4921295oKpAiq'];a29_0x4851=function(){return _0x3842fe;};return a29_0x4851();}export async function createBundleEnrollment({studentId:_0x89d01c,bundleId:_0x2e9b45,paymentId:_0x49e014,amount:_0x1f6947,paymentProvider:_0x501e9c,bundleData:_0x4304cb}){const _0x5cdebf=a29_0x3abb;try{const _0x20913e=[];if(_0x4304cb['courses']&&_0x4304cb['courses']['length']>0x0){const _0x27f3b2=_0x4304cb['courses'][_0x5cdebf(0x9e)](_0x26b462=>_0x26b462['course']&&_0x26b462['course']['_id'])['map'](_0x7f95d7=>_0x7f95d7['course']['_id']),_0x61370f=await getExistingEnrollments(_0x89d01c,_0x27f3b2),_0x242210=_0x61370f['map'](_0x1cebc9=>_0x1cebc9['courseId']);console['log']('Found\x20'+_0x61370f[_0x5cdebf(0x96)]+'\x20existing\x20enrollments\x20for\x20bundle\x20purchase'),console['log']('Existing\x20course\x20IDs:',_0x242210);for(const _0x41bc5b of _0x4304cb['courses']){if(_0x41bc5b[_0x5cdebf(0x94)]&&_0x41bc5b['course']['_id']){const _0xd3d797=_0x41bc5b['course'][_0x5cdebf(0x9d)];if(_0x242210[_0x5cdebf(0x92)](_0xd3d797)){console['log']('Skipping\x20enrollment\x20for\x20course\x20'+_0xd3d797+'\x20-\x20user\x20already\x20enrolled');const _0x12cb7c=_0x61370f['find'](_0x8bbfd4=>_0x8bbfd4['courseId']===_0xd3d797);_0x12cb7c&&_0x20913e['push']({'_type':'reference','_ref':_0x12cb7c['_id']});continue;}console['log']('Creating\x20new\x20enrollment\x20for\x20course\x20'+_0xd3d797);const _0x5d6114=await createEnrollment({'studentId':_0x89d01c,'courseId':_0xd3d797,'paymentId':_0x49e014+'_course_'+_0xd3d797,'amount':0x0,'paymentProvider':_0x501e9c});_0x20913e['push']({'_type':'reference','_ref':_0x5d6114[_0x5cdebf(0x9d)]});}}}const _0x3f7e30={'title':_0x4304cb['title'],'description':_0x4304cb[_0x5cdebf(0x93)],'courses':_0x4304cb['courses']?.['map'](_0x346885=>({'courseId':_0x346885['course']?.['_id'],'courseTitle':_0x346885['course']?.['title'],'customTitle':_0x346885['customTitle'],'customDescription':_0x346885['customDescription']}))||[]},_0x17bf35=await client['create']({'_type':'bundleEnrollment','student':{'_type':'reference','_ref':_0x89d01c},'courseBundle':{'_type':'reference','_ref':_0x2e9b45},'bundleSnapshot':_0x3f7e30,'paymentId':_0x49e014,'paymentProvider':_0x501e9c,'amount':_0x1f6947,'enrolledAt':new Date()['toISOString'](),'individualEnrollments':_0x20913e});return console['log']('Bundle\x20enrollment\x20created\x20with\x20'+_0x20913e['length']+_0x5cdebf(0x9b)),_0x17bf35;}catch(_0xa385a1){console['error']('Error\x20creating\x20bundle\x20enrollment:',_0xa385a1);throw _0xa385a1;}}