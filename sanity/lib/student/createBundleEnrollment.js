(function(_0x22f4b1,_0x468321){const _0x415a90=a29_0x528c,_0x2fcc76=_0x22f4b1();while(!![]){try{const _0x1a99a5=-parseInt(_0x415a90(0xb4))/0x1*(parseInt(_0x415a90(0xb2))/0x2)+-parseInt(_0x415a90(0xb7))/0x3+parseInt(_0x415a90(0xaf))/0x4+-parseInt(_0x415a90(0xbd))/0x5*(-parseInt(_0x415a90(0xb5))/0x6)+-parseInt(_0x415a90(0xb0))/0x7+-parseInt(_0x415a90(0xbc))/0x8*(-parseInt(_0x415a90(0xb9))/0x9)+parseInt(_0x415a90(0xb3))/0xa;if(_0x1a99a5===_0x468321)break;else _0x2fcc76['push'](_0x2fcc76['shift']());}catch(_0x38bc41){_0x2fcc76['push'](_0x2fcc76['shift']());}}}(a29_0x676a,0xe24f8));function a29_0x528c(_0x2c0eea,_0x1ed72f){const _0x676a41=a29_0x676a();return a29_0x528c=function(_0x528c6a,_0x352145){_0x528c6a=_0x528c6a-0xaf;let _0x21dabc=_0x676a41[_0x528c6a];return _0x21dabc;},a29_0x528c(_0x2c0eea,_0x1ed72f);}import{client}from'../adminClient';import{createEnrollment}from'./createEnrollment';function a29_0x676a(){const _0x540eed=['87693DlfPEL','3084pEQsNE','reference','1779432xjlXAH','customTitle','27VwbRAO','course','length','90584LkxWEj','2260TpprEt','4060168HtAGNh','11145113fvpMTb','log','36egGwxA','34094060DbYXRq'];a29_0x676a=function(){return _0x540eed;};return a29_0x676a();}async function getExistingEnrollments(_0x12ccc5,_0x5627fa){const _0x4899e1='*[_type\x20==\x20\x22enrollment\x22\x20&&\x20student._ref\x20==\x20$studentId\x20&&\x20course._ref\x20in\x20$courseIds]\x20{\x0a\x20\x20\x20\x20_id,\x0a\x20\x20\x20\x20\x22courseId\x22:\x20course._ref\x0a\x20\x20}',_0x1f2d7a=await client['fetch'](_0x4899e1,{'studentId':_0x12ccc5,'courseIds':_0x5627fa});return _0x1f2d7a||[];}export async function createBundleEnrollment({studentId:_0x3accb1,bundleId:_0xed944f,paymentId:_0xba99f4,amount:_0x3877f2,paymentProvider:_0xb756ec,bundleData:_0x5581c4}){const _0x102709=a29_0x528c;try{const _0x5cf9e3=[];if(_0x5581c4['courses']&&_0x5581c4['courses']['length']>0x0){const _0x39815d=_0x5581c4['courses']['filter'](_0x466dcc=>_0x466dcc['course']&&_0x466dcc[_0x102709(0xba)]['_id'])['map'](_0x36bbbf=>_0x36bbbf[_0x102709(0xba)]['_id']),_0xaa244d=await getExistingEnrollments(_0x3accb1,_0x39815d),_0x422357=_0xaa244d['map'](_0x371c76=>_0x371c76['courseId']);console['log']('Found\x20'+_0xaa244d[_0x102709(0xbb)]+'\x20existing\x20enrollments\x20for\x20bundle\x20purchase'),console['log']('Existing\x20course\x20IDs:',_0x422357);for(const _0x2a76f3 of _0x5581c4['courses']){if(_0x2a76f3['course']&&_0x2a76f3['course']['_id']){const _0x4377eb=_0x2a76f3['course']['_id'];if(_0x422357['includes'](_0x4377eb)){console['log']('Skipping\x20enrollment\x20for\x20course\x20'+_0x4377eb+'\x20-\x20user\x20already\x20enrolled');const _0x31c433=_0xaa244d['find'](_0x39cc9c=>_0x39cc9c['courseId']===_0x4377eb);_0x31c433&&_0x5cf9e3['push']({'_type':'reference','_ref':_0x31c433['_id']});continue;}console[_0x102709(0xb1)]('Creating\x20new\x20enrollment\x20for\x20course\x20'+_0x4377eb);const _0x341bd2=await createEnrollment({'studentId':_0x3accb1,'courseId':_0x4377eb,'paymentId':_0xba99f4+'_course_'+_0x4377eb,'amount':0x0,'paymentProvider':_0xb756ec});_0x5cf9e3['push']({'_type':'reference','_ref':_0x341bd2['_id']});}}}const _0x3be70a={'title':_0x5581c4['title'],'description':_0x5581c4['description'],'courses':_0x5581c4['courses']?.['map'](_0x21170e=>({'courseId':_0x21170e['course']?.['_id'],'courseTitle':_0x21170e['course']?.['title'],'customTitle':_0x21170e[_0x102709(0xb8)],'customDescription':_0x21170e['customDescription']}))||[]},_0x3cc1ba=await client['create']({'_type':'bundleEnrollment','student':{'_type':_0x102709(0xb6),'_ref':_0x3accb1},'courseBundle':{'_type':_0x102709(0xb6),'_ref':_0xed944f},'bundleSnapshot':_0x3be70a,'paymentId':_0xba99f4,'paymentProvider':_0xb756ec,'amount':_0x3877f2,'enrolledAt':new Date()['toISOString'](),'individualEnrollments':_0x5cf9e3});return console['log']('Bundle\x20enrollment\x20created\x20with\x20'+_0x5cf9e3['length']+'\x20course\x20enrollments'),_0x3cc1ba;}catch(_0x381fcf){console['error']('Error\x20creating\x20bundle\x20enrollment:',_0x381fcf);throw _0x381fcf;}}