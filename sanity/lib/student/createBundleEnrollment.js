(function(_0xf57a85,_0x574121){const _0x45fe91=a29_0x2dc0,_0x77d0e3=_0xf57a85();while(!![]){try{const _0x448428=-parseInt(_0x45fe91(0xfb))/0x1*(parseInt(_0x45fe91(0xf6))/0x2)+parseInt(_0x45fe91(0x102))/0x3+parseInt(_0x45fe91(0xf8))/0x4+parseInt(_0x45fe91(0xf5))/0x5*(parseInt(_0x45fe91(0x101))/0x6)+parseInt(_0x45fe91(0xf7))/0x7*(parseInt(_0x45fe91(0xf9))/0x8)+parseInt(_0x45fe91(0xfe))/0x9+-parseInt(_0x45fe91(0xfa))/0xa*(parseInt(_0x45fe91(0xff))/0xb);if(_0x448428===_0x574121)break;else _0x77d0e3['push'](_0x77d0e3['shift']());}catch(_0x5435ba){_0x77d0e3['push'](_0x77d0e3['shift']());}}}(a29_0x57a8,0xd7f43));function a29_0x2dc0(_0x4ee320,_0x2cdeb0){const _0x57a8b7=a29_0x57a8();return a29_0x2dc0=function(_0x2dc0df,_0x2714a8){_0x2dc0df=_0x2dc0df-0xf5;let _0x529bde=_0x57a8b7[_0x2dc0df];return _0x529bde;},a29_0x2dc0(_0x4ee320,_0x2cdeb0);}function a29_0x57a8(){const _0x39b08a=['1320LkQEmt','3623568qOczyW','1410mkYlds','2GrMDCX','35TCfOjj','1007024BTvkwl','1692712LrcCYA','23440iWyvCe','1005835mZXJSt','title','create','6602337jHqyBs','6677XPiIXq','filter'];a29_0x57a8=function(){return _0x39b08a;};return a29_0x57a8();}import{client}from'../adminClient';import{createEnrollment}from'./createEnrollment';async function getExistingEnrollments(_0x887c52,_0x5caa5b){const _0x418910='*[_type\x20==\x20\x22enrollment\x22\x20&&\x20student._ref\x20==\x20$studentId\x20&&\x20course._ref\x20in\x20$courseIds]\x20{\x0a\x20\x20\x20\x20_id,\x0a\x20\x20\x20\x20\x22courseId\x22:\x20course._ref\x0a\x20\x20}',_0x56cf69=await client['fetch'](_0x418910,{'studentId':_0x887c52,'courseIds':_0x5caa5b});return _0x56cf69||[];}export async function createBundleEnrollment({studentId:_0x256e14,bundleId:_0x2f88a5,paymentId:_0x352288,amount:_0x4d8635,paymentProvider:_0x52c587,bundleData:_0x3ef449}){const _0x3fe48c=a29_0x2dc0;try{const _0x12d123=[];if(_0x3ef449['courses']&&_0x3ef449['courses']['length']>0x0){const _0x4be9d9=_0x3ef449['courses'][_0x3fe48c(0x100)](_0x52d784=>_0x52d784['course']&&_0x52d784['course']['_id'])['map'](_0x404221=>_0x404221['course']['_id']),_0x3df7fa=await getExistingEnrollments(_0x256e14,_0x4be9d9),_0x11839f=_0x3df7fa['map'](_0x2a229d=>_0x2a229d['courseId']);console['log']('Found\x20'+_0x3df7fa['length']+'\x20existing\x20enrollments\x20for\x20bundle\x20purchase'),console['log']('Existing\x20course\x20IDs:',_0x11839f);for(const _0x6be04e of _0x3ef449['courses']){if(_0x6be04e['course']&&_0x6be04e['course']['_id']){const _0x1e9c7d=_0x6be04e['course']['_id'];if(_0x11839f['includes'](_0x1e9c7d)){console['log']('Skipping\x20enrollment\x20for\x20course\x20'+_0x1e9c7d+'\x20-\x20user\x20already\x20enrolled');const _0x1f92ae=_0x3df7fa['find'](_0x115ec0=>_0x115ec0['courseId']===_0x1e9c7d);_0x1f92ae&&_0x12d123['push']({'_type':'reference','_ref':_0x1f92ae['_id']});continue;}console['log']('Creating\x20new\x20enrollment\x20for\x20course\x20'+_0x1e9c7d);const _0x95deb1=await createEnrollment({'studentId':_0x256e14,'courseId':_0x1e9c7d,'paymentId':_0x352288+'_course_'+_0x1e9c7d,'amount':0x0,'paymentProvider':_0x52c587});_0x12d123['push']({'_type':'reference','_ref':_0x95deb1['_id']});}}}const _0xeca330={'title':_0x3ef449[_0x3fe48c(0xfc)],'description':_0x3ef449['description'],'courses':_0x3ef449['courses']?.['map'](_0x288679=>({'courseId':_0x288679['course']?.['_id'],'courseTitle':_0x288679['course']?.['title'],'customTitle':_0x288679['customTitle'],'customDescription':_0x288679['customDescription']}))||[]},_0x8a9d3e=await client[_0x3fe48c(0xfd)]({'_type':'bundleEnrollment','student':{'_type':'reference','_ref':_0x256e14},'courseBundle':{'_type':'reference','_ref':_0x2f88a5},'bundleSnapshot':_0xeca330,'paymentId':_0x352288,'paymentProvider':_0x52c587,'amount':_0x4d8635,'enrolledAt':new Date()['toISOString'](),'individualEnrollments':_0x12d123});return console['log']('Bundle\x20enrollment\x20created\x20with\x20'+_0x12d123['length']+'\x20course\x20enrollments'),_0x8a9d3e;}catch(_0x9d4d2){console['error']('Error\x20creating\x20bundle\x20enrollment:',_0x9d4d2);throw _0x9d4d2;}}