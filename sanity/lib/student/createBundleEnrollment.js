(function(_0x22b6ac,_0x46296d){const _0x49d193=a29_0x3b90,_0x52cfd3=_0x22b6ac();while(!![]){try{const _0x3f4c25=-parseInt(_0x49d193(0x144))/0x1*(-parseInt(_0x49d193(0x146))/0x2)+-parseInt(_0x49d193(0x14d))/0x3+parseInt(_0x49d193(0x143))/0x4+parseInt(_0x49d193(0x13e))/0x5+parseInt(_0x49d193(0x13f))/0x6*(parseInt(_0x49d193(0x145))/0x7)+parseInt(_0x49d193(0x14e))/0x8*(parseInt(_0x49d193(0x140))/0x9)+-parseInt(_0x49d193(0x141))/0xa*(parseInt(_0x49d193(0x148))/0xb);if(_0x3f4c25===_0x46296d)break;else _0x52cfd3['push'](_0x52cfd3['shift']());}catch(_0x1e5aae){_0x52cfd3['push'](_0x52cfd3['shift']());}}}(a29_0xdebe,0x2fa10));import{client}from'../adminClient';import{createEnrollment}from'./createEnrollment';function a29_0x3b90(_0x1c514f,_0x38e9e7){const _0xdebeb6=a29_0xdebe();return a29_0x3b90=function(_0x3b90f1,_0x53c9fa){_0x3b90f1=_0x3b90f1-0x13e;let _0x3fd67f=_0xdebeb6[_0x3b90f1];return _0x3fd67f;},a29_0x3b90(_0x1c514f,_0x38e9e7);}async function getExistingEnrollments(_0x33dd31,_0xc5cc3a){const _0x4dbd47=a29_0x3b90,_0x3206ae='*[_type\x20==\x20\x22enrollment\x22\x20&&\x20student._ref\x20==\x20$studentId\x20&&\x20course._ref\x20in\x20$courseIds]\x20{\x0a\x20\x20\x20\x20_id,\x0a\x20\x20\x20\x20\x22courseId\x22:\x20course._ref\x0a\x20\x20}',_0x49db2d=await client[_0x4dbd47(0x14c)](_0x3206ae,{'studentId':_0x33dd31,'courseIds':_0xc5cc3a});return _0x49db2d||[];}export async function createBundleEnrollment({studentId:_0x530c53,bundleId:_0x3959ce,paymentId:_0x1e463e,amount:_0x8599ac,paymentProvider:_0x262fa6,bundleData:_0x10c4d2}){const _0x167170=a29_0x3b90;try{const _0x705967=[];if(_0x10c4d2[_0x167170(0x142)]&&_0x10c4d2[_0x167170(0x142)]['length']>0x0){const _0xc18f4c=_0x10c4d2['courses']['filter'](_0x1bfd14=>_0x1bfd14['course']&&_0x1bfd14['course']['_id'])['map'](_0x4de7a2=>_0x4de7a2['course']['_id']),_0x3416ad=await getExistingEnrollments(_0x530c53,_0xc18f4c),_0x4fd6f6=_0x3416ad['map'](_0x94cdf4=>_0x94cdf4['courseId']);console['log']('Found\x20'+_0x3416ad['length']+'\x20existing\x20enrollments\x20for\x20bundle\x20purchase'),console['log']('Existing\x20course\x20IDs:',_0x4fd6f6);for(const _0x421e56 of _0x10c4d2['courses']){if(_0x421e56['course']&&_0x421e56[_0x167170(0x14b)]['_id']){const _0x316c82=_0x421e56['course'][_0x167170(0x14a)];if(_0x4fd6f6['includes'](_0x316c82)){console['log']('Skipping\x20enrollment\x20for\x20course\x20'+_0x316c82+'\x20-\x20user\x20already\x20enrolled');const _0x3829e5=_0x3416ad['find'](_0x2653b2=>_0x2653b2[_0x167170(0x147)]===_0x316c82);_0x3829e5&&_0x705967['push']({'_type':'reference','_ref':_0x3829e5['_id']});continue;}console['log']('Creating\x20new\x20enrollment\x20for\x20course\x20'+_0x316c82);const _0x5e7ed7=await createEnrollment({'studentId':_0x530c53,'courseId':_0x316c82,'paymentId':_0x1e463e+'_course_'+_0x316c82,'amount':0x0,'paymentProvider':_0x262fa6});_0x705967['push']({'_type':'reference','_ref':_0x5e7ed7['_id']});}}}const _0x12b3dd={'title':_0x10c4d2['title'],'description':_0x10c4d2[_0x167170(0x149)],'courses':_0x10c4d2['courses']?.['map'](_0x395ecf=>({'courseId':_0x395ecf['course']?.['_id'],'courseTitle':_0x395ecf['course']?.['title'],'customTitle':_0x395ecf['customTitle'],'customDescription':_0x395ecf['customDescription']}))||[]},_0x33816c=await client['create']({'_type':'bundleEnrollment','student':{'_type':'reference','_ref':_0x530c53},'courseBundle':{'_type':'reference','_ref':_0x3959ce},'bundleSnapshot':_0x12b3dd,'paymentId':_0x1e463e,'paymentProvider':_0x262fa6,'amount':_0x8599ac,'enrolledAt':new Date()['toISOString'](),'individualEnrollments':_0x705967});return console['log']('Bundle\x20enrollment\x20created\x20with\x20'+_0x705967['length']+'\x20course\x20enrollments'),_0x33816c;}catch(_0x545a5f){console['error']('Error\x20creating\x20bundle\x20enrollment:',_0x545a5f);throw _0x545a5f;}}function a29_0xdebe(){const _0x56365a=['3156760rfVNkT','courses','1142144jzGjSL','6043amVKQA','321937zUTBLS','76BzkJvW','courseId','33YpXNqg','description','_id','course','fetch','638688ffPBDy','152ovWyxx','1224660ntNwTg','42aambNl','129303apDoNW'];a29_0xdebe=function(){return _0x56365a;};return a29_0xdebe();}