function a29_0x33cf(){const _0x1ded87=['742540yUCovz','748959REwrcG','1261716iZtYia','301673kvdrBj','push','1001021NSoTcu','_id','10YiMUhz','map','reference','course','5177472xnpYiI','27FWQeBj','5293870PYKEHR','2BYGEbl','length'];a29_0x33cf=function(){return _0x1ded87;};return a29_0x33cf();}(function(_0x23b7f5,_0x494eb1){const _0x14317e=a29_0x2d92,_0x457481=_0x23b7f5();while(!![]){try{const _0x3679fd=parseInt(_0x14317e(0x125))/0x1*(parseInt(_0x14317e(0x120))/0x2)+parseInt(_0x14317e(0x123))/0x3+parseInt(_0x14317e(0x122))/0x4+parseInt(_0x14317e(0x129))/0x5*(parseInt(_0x14317e(0x124))/0x6)+parseInt(_0x14317e(0x127))/0x7+parseInt(_0x14317e(0x12d))/0x8+parseInt(_0x14317e(0x12e))/0x9*(-parseInt(_0x14317e(0x12f))/0xa);if(_0x3679fd===_0x494eb1)break;else _0x457481['push'](_0x457481['shift']());}catch(_0x4b80ec){_0x457481['push'](_0x457481['shift']());}}}(a29_0x33cf,0x57c87));import{client}from'../adminClient';import{createEnrollment}from'./createEnrollment';function a29_0x2d92(_0x531015,_0x2e9fab){const _0x33cfb3=a29_0x33cf();return a29_0x2d92=function(_0x2d923c,_0x58df29){_0x2d923c=_0x2d923c-0x120;let _0x2c41f9=_0x33cfb3[_0x2d923c];return _0x2c41f9;},a29_0x2d92(_0x531015,_0x2e9fab);}async function getExistingEnrollments(_0x3485d0,_0x4201e1){const _0x55f1dc='*[_type\x20==\x20\x22enrollment\x22\x20&&\x20student._ref\x20==\x20$studentId\x20&&\x20course._ref\x20in\x20$courseIds]\x20{\x0a\x20\x20\x20\x20_id,\x0a\x20\x20\x20\x20\x22courseId\x22:\x20course._ref\x0a\x20\x20}',_0x136cbe=await client['fetch'](_0x55f1dc,{'studentId':_0x3485d0,'courseIds':_0x4201e1});return _0x136cbe||[];}export async function createBundleEnrollment({studentId:_0x17b2d8,bundleId:_0x47b809,paymentId:_0x1cbc82,amount:_0x41ac1c,paymentProvider:_0x279866,bundleData:_0x9fb9ec}){const _0x261e88=a29_0x2d92;try{const _0x36a1e9=[];if(_0x9fb9ec['courses']&&_0x9fb9ec['courses'][_0x261e88(0x121)]>0x0){const _0x32922f=_0x9fb9ec['courses']['filter'](_0x2de283=>_0x2de283[_0x261e88(0x12c)]&&_0x2de283['course']['_id'])['map'](_0x4c509f=>_0x4c509f[_0x261e88(0x12c)]['_id']),_0x9d8265=await getExistingEnrollments(_0x17b2d8,_0x32922f),_0x1fb81a=_0x9d8265[_0x261e88(0x12a)](_0xcf4b06=>_0xcf4b06['courseId']);console['log']('Found\x20'+_0x9d8265['length']+'\x20existing\x20enrollments\x20for\x20bundle\x20purchase'),console['log']('Existing\x20course\x20IDs:',_0x1fb81a);for(const _0x17af56 of _0x9fb9ec['courses']){if(_0x17af56['course']&&_0x17af56['course']['_id']){const _0xd2af84=_0x17af56['course']['_id'];if(_0x1fb81a['includes'](_0xd2af84)){console['log']('Skipping\x20enrollment\x20for\x20course\x20'+_0xd2af84+'\x20-\x20user\x20already\x20enrolled');const _0x2c0505=_0x9d8265['find'](_0x5548fa=>_0x5548fa['courseId']===_0xd2af84);_0x2c0505&&_0x36a1e9[_0x261e88(0x126)]({'_type':'reference','_ref':_0x2c0505[_0x261e88(0x128)]});continue;}console['log']('Creating\x20new\x20enrollment\x20for\x20course\x20'+_0xd2af84);const _0x131648=await createEnrollment({'studentId':_0x17b2d8,'courseId':_0xd2af84,'paymentId':_0x1cbc82+'_course_'+_0xd2af84,'amount':0x0,'paymentProvider':_0x279866});_0x36a1e9['push']({'_type':'reference','_ref':_0x131648['_id']});}}}const _0x279d8a={'title':_0x9fb9ec['title'],'description':_0x9fb9ec['description'],'courses':_0x9fb9ec['courses']?.['map'](_0xc18998=>({'courseId':_0xc18998['course']?.['_id'],'courseTitle':_0xc18998['course']?.['title'],'customTitle':_0xc18998['customTitle'],'customDescription':_0xc18998['customDescription']}))||[]},_0x2ca1d9=await client['create']({'_type':'bundleEnrollment','student':{'_type':_0x261e88(0x12b),'_ref':_0x17b2d8},'courseBundle':{'_type':'reference','_ref':_0x47b809},'bundleSnapshot':_0x279d8a,'paymentId':_0x1cbc82,'paymentProvider':_0x279866,'amount':_0x41ac1c,'enrolledAt':new Date()['toISOString'](),'individualEnrollments':_0x36a1e9});return console['log']('Bundle\x20enrollment\x20created\x20with\x20'+_0x36a1e9['length']+'\x20course\x20enrollments'),_0x2ca1d9;}catch(_0x269a1a){console['error']('Error\x20creating\x20bundle\x20enrollment:',_0x269a1a);throw _0x269a1a;}}